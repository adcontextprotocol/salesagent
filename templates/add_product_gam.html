{% extends "base.html" %}

{% block title %}{{ 'Edit' if product else 'Create' }} Product - Google Ad Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ 'Edit' if product else 'Create' }} Product (Google Ad Manager)</h2>

    {% if not inventory_synced %}
    <div class="alert alert-warning" style="margin-bottom: 2rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
        <h4 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Inventory Not Synced</h4>
        <p style="margin-bottom: 1rem;">GAM inventory has not been synced yet. You won't be able to select ad units or placements until inventory is synced.</p>
        <a href="{{ url_for('inventory.inventory_browser', tenant_id=tenant_id) }}" class="btn btn-primary">
            üìä Go to Inventory Browser to Sync
        </a>
    </div>
    {% endif %}

    <form id="product-form" method="POST" onsubmit="debugFormSubmission(event)">
        <!-- Section 1: Product Basics -->
        <h3 style="margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem;">Product Information</h3>
        <p style="color: #666; margin-bottom: 1.5rem;">Basic product details that buyers will see</p>

        <div class="form-group">
            <label for="name">Product Name *</label>
            <input type="text" id="name" name="name" required placeholder="e.g., Premium Homepage Package" value="{{ product.name if product else '' }}">
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3" placeholder="Describe this product for potential buyers">{{ product.description if product else '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="countries">Countries</label>
            <select id="countries" name="countries" multiple size="5">
                <option value="ALL">All Countries</option>
                <option value="United States">United States</option>
                <option value="Canada">Canada</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="Australia">Australia</option>
            </select>
            <small style="color: #666;">Hold Ctrl/Cmd to select multiple, or select "All Countries"</small>
        </div>

        <!-- Section 2: GAM Inventory Selection -->
        <h3 style="margin-top: 2rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem;">GAM Inventory</h3>
        <p style="color: #666; margin-bottom: 1.5rem;">Select ad units and placements from your GAM inventory</p>

        <div class="form-group">
            <label for="ad-unit-search">Ad Units</label>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="ad-unit-search" placeholder="Search ad units..." style="flex: 1;">
                <button type="button" onclick="openInventoryPicker('ad_unit')" class="btn btn-secondary" {% if not inventory_synced %}disabled{% endif %}>
                    Browse Ad Units
                </button>
            </div>
            <div id="selected-ad-units" style="min-height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: #f9f9f9;">
                <span style="color: #999;">No ad units selected</span>
            </div>
            <textarea id="targeted_ad_unit_ids" name="targeted_ad_unit_ids" style="display: none;"></textarea>
        </div>

        <div class="form-group">
            <label for="placement-search">Placements</label>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="placement-search" placeholder="Search placements..." style="flex: 1;">
                <button type="button" onclick="openInventoryPicker('placement')" class="btn btn-secondary" {% if not inventory_synced %}disabled{% endif %}>
                    Browse Placements
                </button>
            </div>
            <div id="selected-placements" style="min-height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: #f9f9f9;">
                <span style="color: #999;">No placements selected</span>
            </div>
            <textarea id="targeted_placement_ids" name="targeted_placement_ids" style="display: none;"></textarea>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="include_descendants" checked>
                Include child ad units in targeting
            </label>
        </div>

        <!-- Section 3: Creative Formats -->
        <h3 style="margin-top: 2rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem;">Creative Formats</h3>
        <p style="color: #666; margin-bottom: 1.5rem;">Select ad units first, then choose matching creative formats. Click the ‚ìò icon on each format to learn more.</p>

        <!-- Message shown before ad units are selected -->
        <div id="formats-placeholder" style="{% if product and product.formats %}display: none;{% else %}padding: 2rem; background: #f8f9fa; border: 2px dashed #ddd; border-radius: 4px; text-align: center; color: #666;{% endif %}">
            <p style="margin: 0; font-size: 1.1rem;">‚Üë Select ad units above to see compatible creative formats</p>
        </div>

        <!-- Search box for formats (shown when formats are visible) -->
        <div id="format-search-box" style="display: {% if product and product.formats %}block{% else %}none{% endif %}; margin-bottom: 1rem;">
            <input type="text" id="format-search-input" placeholder="Search formats by name, type, or size..."
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                   onkeyup="filterGAMFormats()">
        </div>

        <!-- Size-type combos being searched (shown after ad units selected) -->
        <div id="format-search-targets" style="display: none; padding: 1rem; background: #e7f3ff; border: 1px solid #90caf9; border-radius: 4px; margin-bottom: 1rem;">
            <strong style="color: #1565c0;">Looking for formats:</strong>
            <div id="search-target-list" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
        </div>

        <!-- Formats container (hidden until ad units selected, or shown if editing product with formats) -->
        <div id="formats-container" style="display: {% if product and product.formats %}grid{% else %}none{% endif %}; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem; max-height: 500px; overflow-y: auto; padding: 1rem; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
            {% for format in formats %}
            <label class="format-card"
                   data-format-id="{{ format.id }}"
                   data-dimensions="{{ format.dimensions or '' }}"
                   data-type="{{ format.type }}"
                   data-description="{{ format.description or '' }}"
                   data-preview-url="{{ format.preview_url or '' }}"
                   data-agent-url="{{ format.agent_url or '' }}"
                   data-search="{{ format.name|lower }} {{ format.type|lower }} {{ format.dimensions or '' }}"
                   style="border: 2px solid #ddd; border-radius: 4px; padding: 1rem; cursor: pointer; transition: all 0.2s; background: white; position: relative;">
                <input type="checkbox" name="formats" value="{{ format.agent_url }}|{{ format.id }}" data-format-id="{{ format.id }}" data-agent-url="{{ format.agent_url }}" {% if selected_format_ids and (format.agent_url, format.id) in selected_format_ids %}checked{% endif %} style="margin-right: 0.5rem;">
                <strong>{{ format.name }}</strong>
                <span class="format-info-icon" onclick="event.preventDefault(); event.stopPropagation(); showFormatInfo({{ format.name | tojson }}, {{ (format.description or 'No description available') | tojson }}, {{ (format.preview_url or '') | tojson }}, {{ (format.agent_url or '') | tojson }}, {{ format.id | tojson }});" style="cursor: help; color: #007bff; font-size: 0.9rem; margin-left: 0.3rem; float: right;">‚ìò</span>
                <br>
                <small style="color: #666;">
                    {{ format.type }}
                    {% if format.dimensions %} - {{ format.dimensions }}{% endif %}
                    {% if format.duration %} - {{ format.duration }}{% endif %}
                </small>
            </label>
            {% endfor %}
        </div>

        <!-- Format selection summary -->
        <div id="format-summary" style="display: {% if product and product.formats %}block{% else %}none{% endif %}; padding: 1rem; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; margin-top: 1rem;">
            <strong style="color: #155724;">‚úì Selected:</strong>
            <span id="format-count" style="font-weight: 600;">{% if product and product.formats %}{{ product.formats|length }}{% else %}0{% endif %}</span> format(s)
        </div>

        <!-- Section 4: Pricing Options (AdCP PR #88) -->
        <h3 style="margin-top: 2rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem;">Pricing Options</h3>

        <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Add one or more pricing models for this product. Buyers can choose which model to use.</p>

            <div id="pricing-options-container">
                <!-- Pricing options will be added here by JavaScript -->
            </div>

            <button type="button" class="btn btn-secondary" onclick="addPricingOption()" style="margin-top: 0.5rem;">
                + Add Pricing Option
            </button>
        </div>

        <!-- Section 5: GAM Line Item Configuration -->
        <h3 style="margin-top: 2rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem;">GAM Line Item Configuration</h3>

        <div style="padding: 1rem; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px;">
            <strong>‚ÑπÔ∏è Automatic Configuration</strong>
            <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                Line item type and priority are automatically determined based on your selected pricing model:
            </p>
            <ul style="margin: 0.5rem 0 0 1.5rem; color: #666; font-size: 0.9rem;">
                <li><strong>CPM Fixed</strong> ‚Üí Standard line item (priority 8, guaranteed delivery)</li>
                <li><strong>Flat Rate</strong> ‚Üí Sponsorship line item (priority 4, guaranteed delivery)</li>
                <li><strong>CPM/VCPM/CPC Auction</strong> ‚Üí Price Priority line item (priority 12, non-guaranteed)</li>
            </ul>
        </div>

        <!-- Submit Buttons -->
        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary">{{ 'Update Product' if product else 'Create Product' }}</button>
            <a href="{{ url_for('products.list_products', tenant_id=tenant_id) }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
.format-card input[type="checkbox"]:checked + strong {
    color: #007bff;
}

.format-card:has(input[type="checkbox"]:checked) {
    border-color: #007bff;
    background-color: #e7f3ff;
}

.format-card:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}
</style>

<script>
// Inventory picker functionality
let currentPickerType = null;

function openInventoryPicker(type) {
    currentPickerType = type;
    const modal = document.getElementById('inventory-picker-modal');
    const title = document.getElementById('picker-modal-title');
    title.textContent = type === 'ad_unit' ? 'Select Ad Units' : 'Select Placements';

    // Load inventory
    loadInventory(type);

    // Show modal
    modal.style.display = 'flex';
}

function closeInventoryPicker() {
    document.getElementById('inventory-picker-modal').style.display = 'none';
    currentPickerType = null;
}

function loadInventory(type, search = '') {
    const list = document.getElementById('inventory-list');
    list.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">Loading...</div>';

    const url = `{{ url_for('inventory.get_inventory_list', tenant_id=tenant_id) }}?type=${type}${search ? '&search=' + encodeURIComponent(search) : ''}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                list.innerHTML = `<div style="padding: 2rem; text-align: center; color: #dc3545;">${data.error}</div>`;
                return;
            }

            if (data.items.length === 0) {
                const inventoryUrl = "{{ url_for('inventory.inventory_browser', tenant_id=tenant_id) }}";
                list.innerHTML = `<div style="padding: 2rem; text-align: center; color: #666;">No items found. <a href="${inventoryUrl}">Sync inventory</a> first.</div>`;
                return;
            }

            // Get currently selected IDs
            const selectedIds = type === 'ad_unit'
                ? new Set((document.getElementById('targeted_ad_unit_ids').value || '').split(',').filter(Boolean))
                : new Set((document.getElementById('targeted_placement_ids').value || '').split(',').filter(Boolean));

            list.innerHTML = data.items.map(item => {
                // Extract sizes for ad units
                let sizesHtml = '';
                if (type === 'ad_unit' && item.metadata && item.metadata.sizes && item.metadata.sizes.length > 0) {
                    const sizeStrings = item.metadata.sizes.map(s => `${s.width}x${s.height}`).join(', ');
                    sizesHtml = `<br><small style="color: #28a745; font-weight: 500;">Sizes: ${sizeStrings}</small>`;
                }

                return `
                <label class="inventory-item" style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #eee; cursor: pointer;">
                    <input type="checkbox"
                           value="${item.id}"
                           data-sizes='${item.metadata && item.metadata.sizes ? JSON.stringify(item.metadata.sizes) : '[]'}'
                           data-path='${item.path ? JSON.stringify(item.path) : '[]'}'
                           ${selectedIds.has(item.id) ? 'checked' : ''}
                           style="margin-right: 0.75rem;">
                    <div style="flex: 1;">
                        <strong>${item.name}</strong>
                        ${item.path && item.path.length > 1 ? `<br><small style="color: #666;">${item.path.join(' > ')}</small>` : ''}
                        ${sizesHtml}
                    </div>
                </label>
            `}).join('');
        })
        .catch(error => {
            list.innerHTML = `<div style="padding: 2rem; text-align: center; color: #dc3545;">Error loading inventory: ${error.message}</div>`;
        });
}

function applyInventorySelection() {
    const checkboxes = document.querySelectorAll('#inventory-list input[type="checkbox"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    const selectedNames = Array.from(checkboxes).map(cb => {
        const label = cb.closest('label');
        return label.querySelector('strong').textContent;
    });

    if (currentPickerType === 'ad_unit') {
        document.getElementById('targeted_ad_unit_ids').value = selectedIds.join(',');
        updateSelectedDisplay('selected-ad-units', selectedNames, selectedIds);

        // Auto-suggest creative formats based on ad unit sizes
        autoSuggestFormats(checkboxes);
    } else {
        document.getElementById('targeted_placement_ids').value = selectedIds.join(',');
        updateSelectedDisplay('selected-placements', selectedNames, selectedIds);
    }

    closeInventoryPicker();
}

function updateSelectedDisplay(containerId, names, ids) {
    const container = document.getElementById(containerId);
    if (names.length === 0) {
        container.innerHTML = '<span style="color: #999;">No items selected</span>';
    } else {
        container.innerHTML = names.map((name, idx) => `
            <span class="selected-item" style="display: inline-block; background: #e7f3ff; padding: 0.25rem 0.5rem; margin: 0.25rem; border-radius: 4px;">
                ${name}
                <button type="button" onclick="removeSelectedItem('${containerId}', '${ids[idx]}')" style="border: none; background: none; color: #666; cursor: pointer; margin-left: 0.25rem;">√ó</button>
            </span>
        `).join('');
    }
}

async function autoSuggestFormats(selectedCheckboxes) {
    // Collect all ad unit constraints (type + max dimensions)
    const adUnitConstraints = []; // [{type: 'display', maxWidth: 970, maxHeight: 250}, ...]
    const includeChildren = document.querySelector('input[name="include_descendants"]')?.checked;

    // First, collect constraints from directly selected ad units
    const selectedPaths = [];
    selectedCheckboxes.forEach(cb => {
        const sizesData = cb.getAttribute('data-sizes');
        const pathData = cb.getAttribute('data-path');

        // Extract path for child lookup
        let path = [];
        if (pathData) {
            try {
                path = JSON.parse(pathData);
            } catch (e) {
                console.warn('Failed to parse path data:', e);
                const label = cb.closest('label');
                const name = label.querySelector('strong').textContent.trim();
                path = [name];
            }
        }
        if (path.length > 0) {
            selectedPaths.push(path);
        }

        // Collect size constraints from this ad unit
        if (sizesData) {
            try {
                const sizes = JSON.parse(sizesData);
                sizes.forEach(size => {
                    // For now, assume all ad units are 'display' type
                    // In future, could get type from ad unit metadata
                    adUnitConstraints.push({
                        type: 'display',
                        maxWidth: size.width,
                        maxHeight: size.height
                    });
                });
            } catch (e) {
                console.warn('Failed to parse size data:', e);
            }
        }
    });

    // If "include children" is checked, fetch all ad units and find children
    if (includeChildren && selectedPaths.length > 0) {
        try {
            const url = `{{ url_for('inventory.get_inventory_list', tenant_id=tenant_id) }}?type=ad_unit`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.items) {
                data.items.forEach(item => {
                    if (item.path && item.path.length > 0) {
                        for (const selectedPath of selectedPaths) {
                            const isChild = selectedPath.every((segment, idx) => item.path[idx] === segment)
                                         && item.path.length > selectedPath.length;

                            if (isChild && item.metadata && item.metadata.sizes) {
                                item.metadata.sizes.forEach(size => {
                                    adUnitConstraints.push({
                                        type: 'display',
                                        maxWidth: size.width,
                                        maxHeight: size.height
                                    });
                                });
                                break;
                            }
                        }
                    }
                });
            }
        } catch (e) {
            console.warn('Failed to fetch child ad units:', e);
        }
    }

    // Hide placeholder and show formats container
    const placeholder = document.getElementById('formats-placeholder');
    const container = document.getElementById('formats-container');
    const searchTargets = document.getElementById('format-search-targets');
    const searchTargetList = document.getElementById('search-target-list');
    const searchBox = document.getElementById('format-search-box');

    if (adUnitConstraints.length === 0) {
        placeholder.style.display = 'block';
        container.style.display = 'none';
        searchTargets.style.display = 'none';
        searchBox.style.display = 'none';
        return;
    }

    placeholder.style.display = 'none';
    searchBox.style.display = 'block';

    // Helper: Check if format fits within any ad unit constraint
    function formatFitsConstraint(formatWidth, formatHeight, formatType) {
        return adUnitConstraints.some(constraint => {
            // Type compatibility check
            // - Exact match (display ‚Üî display, video ‚Üî video, etc.)
            // - Generative formats can serve in display ad units
            // - Universal formats can serve anywhere
            const typeMatches =
                formatType === constraint.type ||
                (formatType === 'generative' && constraint.type === 'display') ||
                formatType === 'universal';

            if (!typeMatches) return false;

            // Format must fit within ad unit dimensions
            return formatWidth <= constraint.maxWidth && formatHeight <= constraint.maxHeight;
        });
    }

    // Group constraints by type for display
    const constraintsByType = {};
    adUnitConstraints.forEach(c => {
        if (!constraintsByType[c.type]) {
            constraintsByType[c.type] = [];
        }
        constraintsByType[c.type].push(`${c.maxWidth}√ó${c.maxHeight}`);
    });

    // Display search targets grouped by type
    const searchTargetHTML = Object.entries(constraintsByType)
        .map(([type, sizes]) => {
            // Get unique sizes
            const uniqueSizes = [...new Set(sizes)];
            return `
                <span style="background: #1565c0; color: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.9rem;">
                    ${type} formats ‚â§ ${uniqueSizes.join(', ')}
                </span>
            `;
        }).join('');

    searchTargetList.innerHTML = searchTargetHTML;
    searchTargets.style.display = 'block';

    // Filter and display matching formats
    const formatCards = document.querySelectorAll('.format-card');
    container.style.display = 'grid';
    let matchingCount = 0;
    let autoCheckedCount = 0;

    console.log(`[DEBUG] Filtering ${formatCards.length} format cards`);
    console.log(`[DEBUG] Ad unit constraints:`, constraintsByType);

    formatCards.forEach((card, index) => {
        const dimensions = card.getAttribute('data-dimensions');
        const type = card.getAttribute('data-type');
        const checkbox = card.querySelector('input[type="checkbox"]');
        const name = card.querySelector('strong').textContent;

        if (index < 5) {
            console.log(`[DEBUG] Format ${index}: "${name}" type="${type}" dimensions="${dimensions}"`);
        }

        if (dimensions) {
            // Parse format dimensions (e.g., "300x250")
            const [widthStr, heightStr] = dimensions.split('x');
            const formatWidth = parseInt(widthStr, 10);
            const formatHeight = parseInt(heightStr, 10);

            if (index < 5) {
                console.log(`[DEBUG] Format ${index}: parsed w=${formatWidth} h=${formatHeight}`);
            }

            if (formatFitsConstraint(formatWidth, formatHeight, type)) {
                // This format fits - show it
                matchingCount++;
                card.style.display = 'block';

                // Auto-check if not already checked
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    autoCheckedCount++;
                    // Add visual feedback
                    card.style.borderColor = '#28a745';
                    card.style.backgroundColor = '#f0fff4';
                    setTimeout(() => {
                        card.style.borderColor = '#007bff';
                        card.style.backgroundColor = '#e7f3ff';
                    }, 2000);
                }
            } else {
                // This format doesn't fit - hide it but preserve checked state
                // User might have selected it deliberately, so don't uncheck it
                // IMPORTANT: Don't disable checkbox - disabled inputs don't submit with form!
                card.style.display = 'none';
                // checkbox.disabled = true; // REMOVED - would prevent form submission
                // DO NOT uncheck: checkbox.checked = false;
            }
        } else {
            // No dimensions - hide it but preserve checked state
            // IMPORTANT: Don't disable checkbox - disabled inputs don't submit with form!
            card.style.display = 'none';
            // checkbox.disabled = true; // REMOVED - would prevent form submission
            // DO NOT uncheck: checkbox.checked = false;
        }
    });

    // Update summary
    updateFormatSummary(matchingCount);

    if (autoCheckedCount > 0) {
        console.log(`Auto-checked ${autoCheckedCount} matching format(s) from ${matchingCount} compatible formats`);
        console.log(`Constraints: ${JSON.stringify(constraintsByType)}`);
    }
}

function updateFormatSummary(matchingCount) {
    const summary = document.getElementById('format-summary');
    const countSpan = document.getElementById('format-count');

    // Only count visible checked formats
    const checkedCount = Array.from(document.querySelectorAll('.format-card input[type="checkbox"]:checked'))
        .filter(cb => cb.closest('.format-card').style.display !== 'none')
        .length;

    countSpan.textContent = checkedCount;

    if (checkedCount > 0) {
        summary.style.display = 'block';
    } else {
        summary.style.display = 'none';
    }
}

async function removeSelectedItem(containerId, idToRemove) {
    const isAdUnit = containerId === 'selected-ad-units';
    const hiddenInput = document.getElementById(isAdUnit ? 'targeted_ad_unit_ids' : 'targeted_placement_ids');
    const currentIds = hiddenInput.value.split(',').filter(Boolean);
    const newIds = currentIds.filter(id => id !== idToRemove);
    hiddenInput.value = newIds.join(',');

    // Refresh display
    const selectedNames = Array.from(document.getElementById(containerId).querySelectorAll('.selected-item'))
        .map(span => span.textContent.trim().replace('√ó', '').trim())
        .filter((_, idx) => currentIds[idx] !== idToRemove);

    updateSelectedDisplay(containerId, selectedNames, newIds);

    // If removing ad units, refresh format suggestions
    if (isAdUnit) {
        // Get remaining selected ad units from the inventory list
        const remainingCheckboxes = [];
        // We need to re-fetch to get the checkboxes with size data
        if (newIds.length > 0) {
            try {
                const url = `{{ url_for('inventory.get_inventory_list', tenant_id=tenant_id) }}?type=ad_unit`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.items) {
                    // Create virtual checkboxes for remaining items
                    data.items.forEach(item => {
                        if (newIds.includes(item.id)) {
                            const virtualCheckbox = {
                                getAttribute: (attr) => {
                                    if (attr === 'data-sizes') {
                                        return item.metadata && item.metadata.sizes ? JSON.stringify(item.metadata.sizes) : '[]';
                                    }
                                    if (attr === 'data-path') {
                                        return item.path ? JSON.stringify(item.path) : '[]';
                                    }
                                    return null;
                                },
                                closest: () => ({ querySelector: () => ({ textContent: { trim: () => item.name }}) })
                            };
                            remainingCheckboxes.push(virtualCheckbox);
                        }
                    });
                }
            } catch (e) {
                console.warn('Failed to refresh format suggestions:', e);
            }
        }

        await autoSuggestFormats(remainingCheckboxes);
    }
}

// Search handler
let searchTimeout;
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('picker-search');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (currentPickerType) {
                    loadInventory(currentPickerType, this.value);
                }
            }, 300);
        });
    }

    // Add event listeners to format checkboxes to update summary
    const formatsContainer = document.getElementById('formats-container');
    if (formatsContainer) {
        formatsContainer.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                // Update summary when formats are manually checked/unchecked
                const visibleFormats = Array.from(document.querySelectorAll('.format-card'))
                    .filter(card => card.style.display !== 'none').length;
                updateFormatSummary(visibleFormats);
            }
        });
    }
});

// Pricing Options Management (AdCP PR #88)
// Moved here so it's available for both create and edit modes
let pricingOptionIndex = 0;

function addPricingOption(existingData = null) {
    const container = document.getElementById('pricing-options-container');
    const index = pricingOptionIndex++;

    const optionHtml = `
        <div class="pricing-option" id="pricing-option-${index}" style="border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h5 style="margin: 0;">Pricing Option #${index + 1}</h5>
                <button type="button" class="btn btn-secondary" onclick="removePricingOption(${index})" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Remove</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label>Pricing Model *</label>
                    <select name="pricing_model_${index}" class="pricing-model-select" onchange="updatePricingFields${index}()" required>
                        <option value="">Select...</option>
                        <optgroup label="Guaranteed (Fixed Price)">
                            <option value="cpm_fixed" ${existingData && existingData.pricing_model === 'cpm' && existingData.is_fixed ? 'selected' : ''}>CPM - Fixed Rate (Cost per 1,000 impressions)</option>
                            <option value="flat_rate" ${existingData && existingData.pricing_model === 'flat_rate' ? 'selected' : ''}>Flat Rate - Fixed Campaign Cost (Sponsorship)</option>
                        </optgroup>
                        <optgroup label="Non-Guaranteed (Auction/Bidding)">
                            <option value="cpm_auction" ${existingData && existingData.pricing_model === 'cpm' && !existingData.is_fixed ? 'selected' : ''}>CPM - Auction (Floor price bidding)</option>
                            <option value="vcpm" ${existingData && existingData.pricing_model === 'vcpm' ? 'selected' : ''}>VCPM - Auction (Viewable impressions)</option>
                            <option value="cpc" ${existingData && existingData.pricing_model === 'cpc' ? 'selected' : ''}>CPC - Auction (Cost per click)</option>
                        </optgroup>
                    </select>
                    <small style="color: #666;">All pricing models shown are supported by Google Ad Manager.</small>
                </div>

                <div class="form-group">
                    <label>Currency *</label>
                    <select name="currency_${index}" required>
                        {% for currency in currencies %}
                        <option value="{{ currency }}" ${existingData && existingData.currency === '{{ currency }}' ? 'selected' : ''}>{{ currency }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group" id="rate-group-${index}">
                    <label>Rate *</label>
                    <input type="number" name="rate_${index}" step="0.01" min="0" placeholder="e.g., 12.50" value="${existingData && existingData.rate ? existingData.rate : ''}">
                    <small style="color: #666;">Price per unit: CPM=$12.50 per 1K imps, CPC=$2.50 per click, FLAT_RATE=$5000 total campaign</small>
                </div>

                <div class="form-group" id="floor-group-${index}" style="display: none;">
                    <label>Floor Price *</label>
                    <input type="number" name="floor_${index}" step="0.01" min="0" placeholder="Minimum bid" value="${existingData && existingData.price_guidance ? existingData.price_guidance.floor : ''}">
                    <small style="color: #666;">Minimum acceptable price</small>
                </div>

                <div class="form-group">
                    <label>Min Spend Per Package</label>
                    <input type="number" name="min_spend_${index}" step="0.01" min="0" placeholder="Optional" value="${existingData && existingData.min_spend_per_package ? existingData.min_spend_per_package : ''}">
                    <small style="color: #666;">Minimum spend required for this pricing option</small>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', optionHtml);

    // Create dynamic update function
    window[`updatePricingFields${index}`] = function() {
        const modelSelect = document.querySelector(`select[name="pricing_model_${index}"]`);
        const rateGroup = document.getElementById(`rate-group-${index}`);
        const floorGroup = document.getElementById(`floor-group-${index}`);

        const isAuction = modelSelect.value.includes('auction');

        if (isAuction) {
            rateGroup.style.display = 'none';
            floorGroup.style.display = 'block';
            document.querySelector(`input[name="rate_${index}"]`).removeAttribute('required');
            document.querySelector(`input[name="floor_${index}"]`).setAttribute('required', '');
        } else {
            rateGroup.style.display = 'block';
            floorGroup.style.display = 'none';
            document.querySelector(`input[name="rate_${index}"]`).setAttribute('required', '');
            document.querySelector(`input[name="floor_${index}"]`).removeAttribute('required');
        }
    };

    // Initialize fields if existing data
    if (existingData) {
        window[`updatePricingFields${index}`]();
    }
}

function removePricingOption(index) {
    const element = document.getElementById(`pricing-option-${index}`);
    if (element) {
        element.remove();
    }
}

// Debug form submission
function debugFormSubmission(event) {
    const formatCheckboxes = document.querySelectorAll('input[name="formats"]:checked');
    const formatValues = Array.from(formatCheckboxes).map(cb => cb.value);
    console.log('[DEBUG] Form submission - checked formats:', formatValues);
    console.log('[DEBUG] Form submission - total checked:', formatValues.length);

    if (formatValues.length === 0) {
        console.error('[DEBUG] NO FORMATS CHECKED ON SUBMIT!');
        // Don't prevent submission, just log the issue
    }

    // Continue with form submission
    return true;
}

// Filter formats based on search input
function filterGAMFormats() {
    const searchInput = document.getElementById('format-search-input');
    const searchTerm = searchInput.value.toLowerCase();
    const formatCards = document.querySelectorAll('.format-card');
    let visibleCount = 0;

    formatCards.forEach(card => {
        const formatName = card.querySelector('strong').textContent.toLowerCase();
        const formatType = card.getAttribute('data-type').toLowerCase();
        const formatDimensions = card.getAttribute('data-dimensions') || '';

        const matches = formatName.includes(searchTerm) ||
                       formatType.includes(searchTerm) ||
                       formatDimensions.includes(searchTerm);

        if (matches) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // Update format count
    const checkedCount = Array.from(document.querySelectorAll('.format-card input[type="checkbox"]:checked'))
        .filter(cb => cb.closest('.format-card').style.display !== 'none')
        .length;
    document.getElementById('format-count').textContent = checkedCount;
}
</script>

<!-- Inventory Picker Modal -->
<div id="inventory-picker-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        <!-- Header -->
        <div style="padding: 1.5rem; border-bottom: 1px solid #ddd;">
            <h3 id="picker-modal-title" style="margin: 0;">Select Items</h3>
        </div>

        <!-- Search -->
        <div style="padding: 1rem; border-bottom: 1px solid #ddd;">
            <input type="text" id="picker-search" placeholder="Search..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <!-- List -->
        <div id="inventory-list" style="flex: 1; overflow-y: auto; min-height: 200px;">
            <!-- Items loaded dynamically -->
        </div>

        <!-- Footer -->
        <div style="padding: 1rem; border-top: 1px solid #ddd; display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button type="button" onclick="closeInventoryPicker()" class="btn btn-secondary">Cancel</button>
            <button type="button" onclick="applyInventorySelection()" class="btn btn-primary">Apply Selection</button>
        </div>
    </div>
</div>

{% if product %}
<script>
// Pre-populate form for editing
(function() {
    const product = {{ product | tojson }};
    const config = product.implementation_config || {};

    // Line item type is now automatically determined from pricing model - no need to set it

    // Set pricing values
    setTimeout(() => {
        if (product.cpm) {
            const cpmField = document.getElementById('cpm');
            if (cpmField) {
                cpmField.value = product.cpm;
                console.log('Set CPM to:', product.cpm);
            }
        }
        if (product.price_guidance && product.price_guidance.min !== undefined) {
            const floorField = document.getElementById('floor_cpm');
            if (floorField) {
                floorField.value = product.price_guidance.min;
                console.log('Set floor_cpm to:', product.price_guidance.min);
            } else {
                console.warn('floor_cpm field not found!');
            }
        }
        if (config.priority) {
            const priorityField = document.getElementById('priority');
            if (priorityField) {
                priorityField.value = config.priority;
                console.log('Set priority to:', config.priority);
            }
        }
    }, 200);

    // Set countries
    if (product.countries && product.countries.length > 0) {
        const countriesSelect = document.getElementById('countries');
        Array.from(countriesSelect.options).forEach(option => {
            if (product.countries.includes(option.value)) {
                option.selected = true;
            }
        });
    }

    // Set ad units and placements - fetch actual names from inventory
    if (config.targeted_ad_unit_ids && config.targeted_ad_unit_ids.length > 0) {
        document.getElementById('targeted_ad_unit_ids').value = config.targeted_ad_unit_ids.join(',');

        // Fetch ad unit names
        fetch(`{{ url_for('inventory.get_inventory_list', tenant_id=tenant_id) }}?type=ad_unit`)
            .then(response => response.json())
            .then(data => {
                if (data.items) {
                    const names = config.targeted_ad_unit_ids.map(id => {
                        const item = data.items.find(i => i.id === id);
                        return item ? item.name : id;
                    });
                    updateSelectedDisplay('selected-ad-units', names, config.targeted_ad_unit_ids);
                    console.log('Populated ad units:', names);
                }
            })
            .catch(error => {
                console.error('Failed to fetch ad unit names:', error);
                // Fallback to IDs
                updateSelectedDisplay('selected-ad-units', config.targeted_ad_unit_ids, config.targeted_ad_unit_ids);
            });
    }

    if (config.targeted_placement_ids && config.targeted_placement_ids.length > 0) {
        document.getElementById('targeted_placement_ids').value = config.targeted_placement_ids.join(',');

        // Fetch placement names
        fetch(`{{ url_for('inventory.get_inventory_list', tenant_id=tenant_id) }}?type=placement`)
            .then(response => response.json())
            .then(data => {
                if (data.items) {
                    const names = config.targeted_placement_ids.map(id => {
                        const item = data.items.find(i => i.id === id);
                        return item ? item.name : id;
                    });
                    updateSelectedDisplay('selected-placements', names, config.targeted_placement_ids);
                    console.log('Populated placements:', names);
                }
            })
            .catch(error => {
                console.error('Failed to fetch placement names:', error);
                // Fallback to IDs
                updateSelectedDisplay('selected-placements', config.targeted_placement_ids, config.targeted_placement_ids);
            });
    }

    // Set include descendants checkbox
    if (config.include_descendants) {
        const checkbox = document.querySelector('input[name="include_descendants"]');
        if (checkbox) checkbox.checked = true;
    }

    // Set creative formats
    if (product.formats && product.formats.length > 0) {
        product.formats.forEach(format => {
            // Handle both FormatReference objects and legacy string format
            let formatId, agentUrl;
            if (typeof format === 'object') {
                formatId = format.format_id || format.id;
                agentUrl = format.agent_url;
            } else {
                formatId = format;
                agentUrl = 'https://creative.adcontextprotocol.org'; // default
            }

            // Try to match against pipe-delimited format first (current format)
            let checkbox = agentUrl ? document.querySelector(`input[name="formats"][value="${agentUrl}|${formatId}"]`) : null;

            // Fallback: try to match by data-format-id attribute
            if (!checkbox) {
                checkbox = document.querySelector(`input[name="formats"][data-format-id="${formatId}"]`);
            }

            if (checkbox) {
                checkbox.checked = true;
                console.log('Checked format:', formatId);
            } else {
                console.warn('Format checkbox not found for:', formatId);
            }
        });
    }
})();

// Initialize pricing options on page load
{% if product %}
// Edit mode: Load existing pricing options
const existingOptions = {{ product.pricing_options | tojson if product.pricing_options else '[]' }};
if (existingOptions.length > 0) {
    existingOptions.forEach(option => {
        addPricingOption(option);
    });
} else {
    // No existing options, add one empty option
    addPricingOption();
}
{% else %}
// Create mode: Add one empty option
addPricingOption();
{% endif %}

// Format info modal functionality
function showFormatInfo(name, description, previewUrl, agentUrl, formatId) {
    const modal = document.getElementById('format-info-modal');
    document.getElementById('format-info-name').textContent = name;
    document.getElementById('format-info-description').textContent = description;

    // Handle preview image
    const previewContainer = document.getElementById('format-preview-container');
    const previewImg = document.getElementById('format-preview-img');
    const noPreview = document.getElementById('format-no-preview');

    if (previewUrl) {
        previewImg.src = previewUrl;
        previewImg.style.display = 'block';
        noPreview.style.display = 'none';
    } else {
        previewImg.style.display = 'none';
        noPreview.style.display = 'block';
    }

    // Handle more info link
    const moreInfoLink = document.getElementById('format-more-info-link');
    if (agentUrl && formatId) {
        // Construct URL to format details on agent (most agents follow this pattern)
        const detailsUrl = `${agentUrl}/formats/${formatId}`;
        moreInfoLink.href = detailsUrl;
        moreInfoLink.style.display = 'inline-block';
    } else {
        moreInfoLink.style.display = 'none';
    }

    modal.style.display = 'block';
}

function closeFormatInfo() {
    document.getElementById('format-info-modal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('format-info-modal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>

<!-- Format Info Modal -->
<div id="format-info-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 2rem; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; color: #333; font-size: 1.5rem;" id="format-info-name"></h2>
            <span onclick="closeFormatInfo()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
        </div>

        <!-- Preview Image -->
        <div id="format-preview-container" style="margin-bottom: 1.5rem; text-align: center; background: #f8f9fa; border-radius: 4px; padding: 1rem; min-height: 200px; display: flex; align-items: center; justify-content: center;">
            <img id="format-preview-img" src="" alt="Format preview" style="max-width: 100%; max-height: 300px; border-radius: 4px; display: none;">
            <div id="format-no-preview" style="color: #999; display: none;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üñºÔ∏è</div>
                <div>No preview available</div>
            </div>
        </div>

        <!-- Description -->
        <div style="margin-bottom: 1.5rem;">
            <p id="format-info-description" style="color: #666; line-height: 1.6; margin: 0;"></p>
        </div>

        <!-- Actions -->
        <div style="display: flex; gap: 0.5rem;">
            <a id="format-more-info-link" href="#" target="_blank" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; display: none;">
                Learn More ‚Üí
            </a>
            <button onclick="closeFormatInfo()" class="btn btn-primary" style="flex: 1;">Close</button>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
