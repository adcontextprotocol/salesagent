{% extends "base.html" %}

{% block title %}Create Your Account - AdCP Sales Agent{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 2rem auto; padding: 0 1rem;">
    <div class="card">
        <h1 style="margin-bottom: 0.5rem;">Create Your Sales Agent Account</h1>
        <p style="color: #666; margin-bottom: 2rem;">
            Welcome, <strong>{{ user_name or user_email }}</strong>! Let's set up your publisher account.
        </p>

        {% if error %}
        <div class="alert alert-error">{{ error }}</div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('public.provision_tenant') }}" id="onboarding-form">
            <!-- Step 1: Publisher Information -->
            <div class="form-section">
                <h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1a1a1a;">üìù Publisher Information</h2>

                <div class="form-group">
                    <label for="publisher_name">Publisher Name <span style="color: red;">*</span></label>
                    <input
                        type="text"
                        id="publisher_name"
                        name="publisher_name"
                        required
                        placeholder="e.g., New York Times"
                        autofocus
                    >
                    <small>Your company or publication name</small>
                </div>

                <div class="form-group">
                    <label for="subdomain">Subdomain <span style="color: red;">*</span></label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input
                            type="text"
                            id="subdomain"
                            name="subdomain"
                            required
                            pattern="[a-z0-9-]+"
                            placeholder="e.g., {{ suggested_subdomain or 'publisher' }}"
                            value="{{ suggested_subdomain }}"
                            style="flex: 1;"
                        >
                        <span style="color: #666; white-space: nowrap;">.sales-agent.scope3.com</span>
                    </div>
                    <small>Lowercase letters, numbers, and hyphens only. This will be your unique URL.</small>
                </div>
            </div>

            <!-- Step 2: Ad Server Selection -->
            <div class="form-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                <h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1a1a1a;">üîå Select Your Ad Server</h2>

                <div class="form-group">
                    <label for="adapter">Ad Server <span style="color: red;">*</span></label>
                    <select id="adapter" name="adapter" required onchange="toggleAdapterConfig()">
                        <option value="mock">Mock (Testing & Development)</option>
                        <option value="google_ad_manager">Google Ad Manager</option>
                        <option value="kevel">Kevel</option>
                    </select>
                    <small>You can change this later in your account settings</small>
                </div>
            </div>

            <!-- Adapter-Specific Configuration Sections -->

            <!-- Mock Adapter Info -->
            <div id="mock-config" class="adapter-config" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #34A853;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">
                    <strong>‚úì Mock Adapter Selected</strong><br>
                    No additional configuration needed. Perfect for testing and development.
                    You can switch to a real ad server later.
                </p>
            </div>

            <!-- Google Ad Manager Config -->
            <div id="gam-config" class="adapter-config" style="display: none; margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 4px; border-left: 3px solid #4285F4;">
                <p style="margin-bottom: 1rem; color: #1565c0; font-size: 0.9rem;">
                    <strong>üìã Google Ad Manager Setup</strong><br>
                    You'll connect your GAM account after creating your publisher account.
                    This will allow us to auto-detect your network information.
                </p>
                <p style="margin: 0; color: #666; font-size: 0.85rem;">
                    <strong>Note:</strong> You'll need GAM admin access to complete the OAuth flow.
                </p>
            </div>

            <!-- Kevel Config -->
            <div id="kevel-config" class="adapter-config" style="display: none; margin-top: 1rem; padding: 1rem; background: #fff3e0; border-radius: 4px; border-left: 3px solid #ff9800;">
                <p style="margin-bottom: 1rem; color: #e65100; font-size: 0.9rem;">
                    <strong>üîë Kevel Configuration</strong><br>
                    Enter your Kevel API credentials (you can also configure this later in settings).
                </p>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="kevel_network_id">Network ID</label>
                    <input
                        type="text"
                        id="kevel_network_id"
                        name="kevel_network_id"
                        placeholder="Your Kevel Network ID"
                    >
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="kevel_api_key">API Key</label>
                    <input
                        type="password"
                        id="kevel_api_key"
                        name="kevel_api_key"
                        placeholder="Your Kevel API Key"
                        autocomplete="new-password"
                    >
                </div>
            </div>

            <!-- Submit Button -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                <button type="submit" class="btn" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                    Create My Account ‚Üí
                </button>
                <p style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: #666;">
                    By creating an account, you agree to our Terms of Service
                </p>
            </div>
        </form>
    </div>
</div>

<script>
function toggleAdapterConfig() {
    const adapter = document.getElementById('adapter').value;

    // Hide all adapter config sections
    document.querySelectorAll('.adapter-config').forEach(el => {
        el.style.display = 'none';
    });

    // Show selected adapter config
    if (adapter === 'mock') {
        document.getElementById('mock-config').style.display = 'block';
    } else if (adapter === 'google_ad_manager') {
        document.getElementById('gam-config').style.display = 'block';
    } else if (adapter === 'kevel') {
        document.getElementById('kevel-config').style.display = 'block';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleAdapterConfig();

    // Auto-generate subdomain from publisher name
    const publisherNameInput = document.getElementById('publisher_name');
    const subdomainInput = document.getElementById('subdomain');

    publisherNameInput.addEventListener('input', function() {
        // Only auto-fill if subdomain is empty or matches previous suggestion
        if (!subdomainInput.value || subdomainInput.dataset.autoFilled === 'true') {
            const suggested = this.value
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '') // Remove invalid chars
                .replace(/\s+/g, '-')          // Replace spaces with hyphens
                .replace(/-+/g, '-')           // Collapse multiple hyphens
                .replace(/^-|-$/g, '');        // Remove leading/trailing hyphens

            if (suggested) {
                subdomainInput.value = suggested;
                subdomainInput.dataset.autoFilled = 'true';
            }
        }
    });

    // Mark subdomain as manually edited if user changes it
    subdomainInput.addEventListener('input', function() {
        subdomainInput.dataset.autoFilled = 'false';
    });
});

// Form validation
document.getElementById('onboarding-form').addEventListener('submit', function(e) {
    const subdomain = document.getElementById('subdomain').value;
    const publisherName = document.getElementById('publisher_name').value;

    if (!subdomain || !publisherName) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return false;
    }

    // Validate subdomain format
    if (!/^[a-z0-9-]+$/.test(subdomain)) {
        e.preventDefault();
        alert('Subdomain can only contain lowercase letters, numbers, and hyphens');
        return false;
    }

    // Check for reserved subdomains
    const reserved = ['admin', 'www', 'api', 'mcp', 'a2a', 'app', 'staging', 'dev', 'test', 'prod', 'production'];
    if (reserved.includes(subdomain)) {
        e.preventDefault();
        alert('This subdomain is reserved. Please choose another.');
        return false;
    }
});
</script>

<style>
.form-section {
    margin-bottom: 1.5rem;
}

.adapter-config {
    transition: all 0.3s ease;
}

.btn {
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

input:invalid {
    border-color: #dc3545;
}

input:valid {
    border-color: #28a745;
}
</style>
{% endblock %}
