{% extends "base.html" %}

{% block title %}Create Your Account - AdCP Sales Agent{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 2rem auto; padding: 0 1rem;">
    <div class="card">
        <h1 style="margin-bottom: 0.5rem;">Create Your Sales Agent Account</h1>
        <p style="color: #666; margin-bottom: 2rem;">
            Welcome, <strong>{{ user_name or user_email }}</strong>! Let's set up your publisher account.
        </p>

        {% if error %}
        <div class="alert alert-error">{{ error }}</div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('public.provision_tenant') }}" id="onboarding-form">
            <!-- Step 1: Publisher Information -->
            <div class="form-section">
                <h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1a1a1a;">üìù Publisher Information</h2>

                <div class="form-group">
                    <label for="publisher_name">Publisher Name <span style="color: red;">*</span></label>
                    <input
                        type="text"
                        id="publisher_name"
                        name="publisher_name"
                        required
                        placeholder="e.g., New York Times"
                        autofocus
                    >
                    <small>Your company or publication name</small>
                </div>

                <div class="form-group">
                    <label for="subdomain">Subdomain <span style="color: red;">*</span></label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input
                            type="text"
                            id="subdomain"
                            name="subdomain"
                            required
                            pattern="[a-z0-9-]+"
                            placeholder="e.g., {{ suggested_subdomain or 'publisher' }}"
                            value="{{ suggested_subdomain }}"
                            style="flex: 1;"
                        >
                        <span style="color: #666; white-space: nowrap;">.sales-agent.scope3.com</span>
                    </div>
                    <small>Lowercase letters, numbers, and hyphens only. This will be your unique URL.</small>
                </div>
            </div>

            <!-- Step 2: Ad Server Selection -->
            <div class="form-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                <h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1a1a1a;">üîå Ad Server Integration</h2>

                <div class="form-group">
                    <label for="adapter">Ad Server</label>
                    <input type="hidden" id="adapter" name="adapter" value="google_ad_manager">
                    <div style="padding: 1rem; background: #e3f2fd; border-radius: 4px; border-left: 3px solid #4285F4;">
                        <strong>Google Ad Manager</strong>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                            You'll connect your GAM account in the next step after account creation.
                        </p>
                    </div>
                    <small style="display: block; margin-top: 0.5rem;">Need a different ad server? <a href="mailto:support@scope3.com">Contact us</a> for enterprise setup.</small>
                </div>
            </div>


            <!-- Submit Button -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                <button type="submit" class="btn" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                    Create My Account ‚Üí
                </button>
                <p style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: #666;">
                    By creating an account, you agree to our Terms of Service
                </p>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {

    // Auto-generate subdomain from publisher name
    const publisherNameInput = document.getElementById('publisher_name');
    const subdomainInput = document.getElementById('subdomain');

    publisherNameInput.addEventListener('input', function() {
        // Only auto-fill if subdomain is empty or matches previous suggestion
        if (!subdomainInput.value || subdomainInput.dataset.autoFilled === 'true') {
            const suggested = this.value
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '') // Remove invalid chars
                .replace(/\s+/g, '-')          // Replace spaces with hyphens
                .replace(/-+/g, '-')           // Collapse multiple hyphens
                .replace(/^-|-$/g, '');        // Remove leading/trailing hyphens

            if (suggested) {
                subdomainInput.value = suggested;
                subdomainInput.dataset.autoFilled = 'true';
            }
        }
    });

    // Mark subdomain as manually edited if user changes it
    subdomainInput.addEventListener('input', function() {
        subdomainInput.dataset.autoFilled = 'false';
    });
});

// Form validation
document.getElementById('onboarding-form').addEventListener('submit', function(e) {
    const subdomain = document.getElementById('subdomain').value;
    const publisherName = document.getElementById('publisher_name').value;

    if (!subdomain || !publisherName) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return false;
    }

    // Validate subdomain format
    if (!/^[a-z0-9-]+$/.test(subdomain)) {
        e.preventDefault();
        alert('Subdomain can only contain lowercase letters, numbers, and hyphens');
        return false;
    }

    // Check for reserved subdomains
    const reserved = ['admin', 'www', 'api', 'mcp', 'a2a', 'app', 'staging', 'dev', 'test', 'prod', 'production'];
    if (reserved.includes(subdomain)) {
        e.preventDefault();
        alert('This subdomain is reserved. Please choose another.');
        return false;
    }
});
</script>

<style>
.form-section {
    margin-bottom: 1.5rem;
}

.adapter-config {
    transition: all 0.3s ease;
}

.btn {
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

input:invalid {
    border-color: #dc3545;
}

input:valid {
    border-color: #28a745;
}
</style>
{% endblock %}
