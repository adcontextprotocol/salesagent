{% extends "base.html" %}

{% block title %}Accounts - Sales Agent Admin{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>Accounts</h2>
        <div>
            {% if session.role == 'super_admin' %}
            <a href="{{ script_name }}/settings" class="btn btn-secondary">Settings</a>
            {% endif %}
            <a href="{{ script_name }}/create_tenant" class="btn">Create New Account</a>
        </div>
    </div>

    {% if tenants %}
    <!-- Filter Controls -->
    <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
            <div>
                <label style="font-weight: bold; margin-right: 0.5rem;">Configuration:</label>
                <select id="configFilter" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">All</option>
                    <option value="configured">Configured</option>
                    <option value="not-configured">Not Configured</option>
                </select>
            </div>
            <div>
                <label style="font-weight: bold; margin-right: 0.5rem;">Activity:</label>
                <select id="activityFilter" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">All</option>
                    <option value="has-activity">Has Activity</option>
                    <option value="no-activity">No Activity</option>
                </select>
            </div>
            <div style="margin-left: auto; color: #666;">
                Showing: <strong id="visibleCount">{{ tenants|length }}</strong> of {{ tenants|length }} accounts
            </div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Tenant Access</th>
                <th>Configuration</th>
                <th>Setup Status</th>
                <th>Activity</th>
                <th>Ad Server</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for tenant in tenants %}
            <tr data-configured="{{ 'true' if tenant.is_configured else 'false' }}" data-has-activity="{{ 'true' if tenant.has_activity else 'false' }}">
                <td><strong>{{ tenant.name }}</strong></td>
                <td>
                    {% if tenant.virtual_host %}
                    <code>{{ tenant.virtual_host }}</code>
                    <br><small style="color: #666;">https://{{ tenant.virtual_host }}</small>
                    <br><small style="color: #999;">(Virtual Host)</small>
                    {% else %}
                    <code>{{ tenant.subdomain }}</code>
                    {% if is_production %}
                        <br><small style="color: #666;">https://{{ tenant.subdomain }}.sales-agent.scope3.com/mcp/</small>
                        <br><small style="color: #999;">(Tenant Subdomain)</small>
                    {% else %}
                        <br><small style="color: #666;">http://localhost:{{ mcp_port }}/mcp/</small>
                        <br><small style="color: #999;">(use x-adcp-tenant: {{ tenant.subdomain }})</small>
                    {% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if tenant.is_configured %}
                    <span class="status status-active">✓ Configured</span>
                    {% else %}
                    <span class="status status-inactive">⚠ Pending</span>
                    {% endif %}
                </td>
                <td>
                    {% if tenant.setup_status %}
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; min-width: 120px;">
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: {% if tenant.setup_status.progress_percent == 100 %}#28a745{% elif tenant.setup_status.progress_percent >= 60 %}#ffc107{% else %}#dc3545{% endif %}; height: 100%; width: {{ tenant.setup_status.progress_percent }}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div style="min-width: 60px; text-align: right;">
                            <strong>{{ tenant.setup_status.progress_percent }}%</strong>
                            <br><small style="color: #666;">{{ tenant.setup_status.completed_count }}/{{ tenant.setup_status.total_count }}</small>
                        </div>
                    </div>
                    {% if tenant.setup_status.ready_for_orders %}
                    <small style="color: #28a745;">✓ Ready for orders</small>
                    {% else %}
                    <small style="color: #dc3545;">{{ tenant.setup_status.critical|selectattr('is_complete', 'equalto', false)|list|length }} critical tasks remaining</small>
                    {% endif %}
                    {% else %}
                    <span style="color: #999;">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if tenant.has_activity %}
                    <div style="color: #28a745;">
                        <strong>{{ tenant.total_buys_count }}</strong> total buys
                        {% if tenant.recent_buys_count > 0 %}
                        <br><small style="color: #666;">{{ tenant.recent_buys_count }} in last 30 days</small>
                        {% endif %}
                    </div>
                    {% else %}
                    <span style="color: #999;">No activity</span>
                    {% endif %}
                </td>
                <td>
                    {% if tenant.ad_server == 'google_ad_manager' %}
                    <span style="color: #1a73e8;">Google Ad Manager</span>
                    {% elif tenant.ad_server %}
                    {{ tenant.ad_server|replace('_', ' ')|title }}
                    {% else %}
                    <span style="color: #999;">Not configured</span>
                    {% endif %}
                </td>
                <td>{{ tenant.created_at.strftime('%Y-%m-%d') if tenant.created_at else 'N/A' }}</td>
                <td>
                    <a href="{{ script_name }}/tenant/{{ tenant.tenant_id }}" class="btn btn-small">Manage</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No tenants found. <a href="{{ script_name }}/create_tenant">Create your first tenant</a>.</p>
    {% endif %}
</div>

<script>
// Client-side filtering for tenant list
document.addEventListener('DOMContentLoaded', function() {
    const configFilter = document.getElementById('configFilter');
    const activityFilter = document.getElementById('activityFilter');
    const visibleCount = document.getElementById('visibleCount');
    const tableRows = document.querySelectorAll('tbody tr');
    const totalCount = tableRows.length;

    function applyFilters() {
        const configValue = configFilter.value;
        const activityValue = activityFilter.value;
        let visibleRows = 0;

        tableRows.forEach(row => {
            let showRow = true;

            // Apply configuration filter
            if (configValue === 'configured' && row.dataset.configured !== 'true') {
                showRow = false;
            } else if (configValue === 'not-configured' && row.dataset.configured !== 'false') {
                showRow = false;
            }

            // Apply activity filter
            if (activityValue === 'has-activity' && row.dataset.hasActivity !== 'true') {
                showRow = false;
            } else if (activityValue === 'no-activity' && row.dataset.hasActivity !== 'false') {
                showRow = false;
            }

            // Show/hide row
            if (showRow) {
                row.style.display = '';
                visibleRows++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update count
        visibleCount.textContent = visibleRows;
    }

    // Attach event listeners
    configFilter.addEventListener('change', applyFilters);
    activityFilter.addEventListener('change', applyFilters);
});
</script>
{% endblock %}
