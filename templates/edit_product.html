{% extends "base.html" %}

{% block title %}Edit Product - {{ product.name }} - Sales Agent Admin{% endblock %}

{% block content %}
<div class="card">
    <h2>Edit Product</h2>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <form method="POST">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="name">Product Name *</label>
                <input type="text" id="name" name="name" value="{{ product.name }}" required>
            </div>

            <div class="form-group">
                <label>Product ID</label>
                <input type="text" value="{{ product.product_id }}" disabled style="background: #f5f5f5;">
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3">{{ product.description or '' }}</textarea>
        </div>

        <h3 style="margin-top: 2rem;">Pricing & Delivery</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="delivery_type">Delivery Type</label>
                <select id="delivery_type" name="delivery_type">
                    <option value="guaranteed" {% if product.delivery_type == 'guaranteed' %}selected{% endif %}>Guaranteed</option>
                    <option value="non_guaranteed" {% if product.delivery_type == 'non_guaranteed' %}selected{% endif %}>Non-guaranteed</option>
                </select>
            </div>

            <div class="form-group" id="cpm-group" {% if not product.is_fixed_price %}style="display: none;"{% endif %}>
                <label for="cpm">CPM (Cost per 1000 impressions) *</label>
                <input type="number" id="cpm" name="cpm" value="{{ product.cpm or 5.00 }}" step="0.01">
            </div>

            <div class="form-group" id="price-guidance-group" {% if product.is_fixed_price %}style="display: none;"{% endif %}>
                <label for="price_guidance_min">Price Guidance (CPM Range)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="price_guidance_min" name="price_guidance_min"
                           value="{{ product.price_guidance.min if product.price_guidance else '' }}"
                           placeholder="Min" step="0.01" style="flex: 1;">
                    <span>-</span>
                    <input type="number" id="price_guidance_max" name="price_guidance_max"
                           value="{{ product.price_guidance.max if product.price_guidance else '' }}"
                           placeholder="Max" step="0.01" style="flex: 1;">
                </div>
                <small style="color: #666;">Suggested CPM range for non-guaranteed inventory</small>
            </div>

            <div class="form-group">
                <label for="min_spend">Minimum Spend Override</label>
                <input type="number" id="min_spend" name="min_spend"
                       value="{{ product.min_spend if product.min_spend else '' }}"
                       placeholder="Use tenant default{% if tenant_min_spend %} ({{ tenant_min_spend }} {{ tenant_currency or 'USD' }}){% endif %}"
                       step="0.01" min="0">
                <small style="color: #666;">
                    {% if tenant_min_spend %}
                    Override the tenant's global minimum spend ({{ tenant_min_spend }} {{ tenant_currency or 'USD' }}). Leave empty to use global setting.
                    {% else %}
                    Set a minimum spend requirement for this product (no global minimum is set).
                    {% endif %}
                </small>
            </div>
        </div>

        <div class="alert" style="background: #e3f2fd; border-color: #90caf9; color: #1565c0;">
            <strong>Creative Formats & Advanced Configuration:</strong>
            {% if tenant_adapter == 'mock' %}
            <a href="/adapters/mock/config/{{ tenant_id }}/{{ product.product_id }}" class="btn btn-sm"
               style="background: #1565c0; color: white; margin-left: 1rem;">Configure Mock Adapter →</a>
            {% elif tenant_adapter == 'google_ad_manager' %}
            <a href="/adapters/gam/config/{{ tenant_id }}/{{ product.product_id }}" class="btn btn-sm"
               style="background: #1565c0; color: white; margin-left: 1rem;">Configure GAM Adapter →</a>
            {% elif tenant_adapter == 'kevel' %}
            <a href="/adapters/kevel/config/{{ tenant_id }}/{{ product.product_id }}" class="btn btn-sm"
               style="background: #1565c0; color: white; margin-left: 1rem;">Configure Kevel Adapter →</a>
            {% else %}
            <span style="color: #666;">Configure creative formats and advanced settings through the adapter-specific interface.</span>
            {% endif %}
        </div>

        {% if tenant_adapter == 'google_ad_manager' %}
        <div class="alert" style="background: #f3e5f5; border-color: #ce93d8; color: #6a1b9a; margin-top: 1rem;">
            <strong>Inventory Targeting:</strong> Configure which ad units this product targets.
            <a href="/tenant/{{ tenant_id }}/product/{{ product.product_id }}/inventory" class="btn btn-sm"
               style="background: #6a1b9a; color: white; margin-left: 1rem;">Configure Inventory →</a>
        </div>
        {% endif %}

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn">Save Changes</button>
            <a href="{{ url_for('products.list_products', tenant_id=tenant_id) }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
function updatePricingFields() {
    const deliveryType = document.getElementById('delivery_type').value;
    const cpmGroup = document.getElementById('cpm-group');
    const priceGuidanceGroup = document.getElementById('price-guidance-group');
    const cpmInput = document.getElementById('cpm');

    if (deliveryType === 'guaranteed') {
        cpmGroup.style.display = 'block';
        priceGuidanceGroup.style.display = 'none';
        cpmInput.required = true;
    } else {
        cpmGroup.style.display = 'none';
        priceGuidanceGroup.style.display = 'block';
        cpmInput.required = false;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener to delivery type dropdown
    document.getElementById('delivery_type').addEventListener('change', updatePricingFields);
});
</script>
{% endblock %}
