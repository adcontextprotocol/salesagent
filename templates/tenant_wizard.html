{% extends "base.html" %}

{% block title %}Tenant Setup Wizard - AdCP Admin{% endblock %}

{% block content %}
<style>
.wizard-container {
    max-width: 800px;
    margin: 0 auto;
}

.wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3rem;
    padding: 0 2rem;
}

.wizard-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
}

.wizard-step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 60%;
    width: calc(100% - 20%);
    height: 2px;
    background: #e0e0e0;
    z-index: -1;
}

.wizard-step.completed:not(:last-child)::after,
.wizard-step.active:not(:last-child)::after {
    background: #27ae60;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f5f5f5;
    border: 2px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #999;
    margin-bottom: 0.5rem;
}

.wizard-step.active .step-circle {
    background: #3498db;
    border-color: #3498db;
    color: white;
}

.wizard-step.completed .step-circle {
    background: #27ae60;
    border-color: #27ae60;
    color: white;
}

.step-label {
    font-size: 0.9rem;
    color: #666;
    text-align: center;
}

.wizard-step.active .step-label {
    color: #3498db;
    font-weight: 500;
}

.wizard-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.wizard-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e0e0e0;
}

.format-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.format-card {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
}

.format-card:hover {
    border-color: #3498db;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.format-card.selected {
    border-color: #27ae60;
    background: #f0fff4;
}

.format-card h4 {
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.format-card input[type="checkbox"] {
    margin-right: 0.5rem;
}

.custom-format-form {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.product-list {
    margin-top: 1rem;
}

.product-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.principal-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.alert-info {
    background: #e3f2fd;
    color: #1976d2;
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}
</style>

<div class="wizard-container">
    <h1>Tenant Setup Wizard</h1>
    
    <div class="wizard-steps">
        <div class="wizard-step active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Choose Ad Server</div>
        </div>
        <div class="wizard-step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Select Standard Formats</div>
        </div>
        <div class="wizard-step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Add Custom Formats</div>
        </div>
        <div class="wizard-step" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-label">Setup Products</div>
        </div>
        <div class="wizard-step" data-step="5">
            <div class="step-circle">5</div>
            <div class="step-label">Add Principals</div>
        </div>
    </div>
    
    <form id="wizardForm" method="POST">
        <!-- Step 1: Choose Ad Server -->
        <div id="step1" class="wizard-content">
            <h2>Choose Your Ad Server</h2>
            <p>Select the ad server you use to manage your advertising inventory.</p>
            
            <div class="form-group">
                <label>Select Ad Server Platform:</label>
                <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                    <label class="radio-card">
                        <input type="radio" name="adapter" value="google_ad_manager" onchange="showAdapterConfig('google_ad_manager')">
                        <div class="radio-card-content">
                            <h4>Google Ad Manager</h4>
                            <p>Enterprise ad serving platform by Google</p>
                        </div>
                    </label>
                    
                    <label class="radio-card">
                        <input type="radio" name="adapter" value="kevel" onchange="showAdapterConfig('kevel')">
                        <div class="radio-card-content">
                            <h4>Kevel</h4>
                            <p>API-first ad serving platform</p>
                        </div>
                    </label>
                    
                    <label class="radio-card">
                        <input type="radio" name="adapter" value="triton" onchange="showAdapterConfig('triton')">
                        <div class="radio-card-content">
                            <h4>Triton Digital</h4>
                            <p>Audio and podcast advertising platform</p>
                        </div>
                    </label>
                    
                    <label class="radio-card">
                        <input type="radio" name="adapter" value="mock" onchange="showAdapterConfig('mock')">
                        <div class="radio-card-content">
                            <h4>Mock (Development)</h4>
                            <p>For testing and development purposes</p>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Adapter-specific configuration -->
            <div id="adapter-config" style="margin-top: 2rem;">
                <div id="config-google_ad_manager" class="adapter-config" style="display: none;">
                    <h3>Google Ad Manager Configuration</h3>
                    <div class="form-group">
                        <label for="gam_network_code">Network Code *</label>
                        <input type="text" id="gam_network_code" name="gam_network_code" placeholder="e.g., 123456789">
                        <small>Found in GAM under Admin → Global Settings</small>
                    </div>
                </div>
                
                <div id="config-kevel" class="adapter-config" style="display: none;">
                    <h3>Kevel Configuration</h3>
                    <div class="form-group">
                        <label for="kevel_network_id">Network ID *</label>
                        <input type="text" id="kevel_network_id" name="kevel_network_id">
                    </div>
                    <div class="form-group">
                        <label for="kevel_api_key">API Key *</label>
                        <input type="password" id="kevel_api_key" name="kevel_api_key">
                    </div>
                </div>
                
                <div id="config-triton" class="adapter-config" style="display: none;">
                    <h3>Triton Digital Configuration</h3>
                    <div class="form-group">
                        <label for="triton_station_id">Station ID *</label>
                        <input type="text" id="triton_station_id" name="triton_station_id">
                    </div>
                </div>
                
                <div id="config-mock" class="adapter-config" style="display: none;">
                    <div class="alert-info">
                        <strong>Mock Adapter Selected</strong><br>
                        No configuration required. This adapter simulates ad server behavior for testing.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Select Standard Formats -->
        <div id="step2" class="wizard-content" style="display: none;">
            <h2>Select Standard Ad Formats</h2>
            <p>Choose which IAB standard ad formats your site supports. These are the most common formats that advertisers expect.</p>
            
            <h3>Display Formats</h3>
            <div class="format-grid">
                <div class="format-card" onclick="toggleFormat(this, 'display_300x250')">
                    <h4><input type="checkbox" name="standard_formats" value="display_300x250" checked> Medium Rectangle</h4>
                    <div style="color: #666;">300x250</div>
                    <small>Most popular display format</small>
                </div>
                
                <div class="format-card" onclick="toggleFormat(this, 'display_728x90')">
                    <h4><input type="checkbox" name="standard_formats" value="display_728x90" checked> Leaderboard</h4>
                    <div style="color: #666;">728x90</div>
                    <small>Top of page banner</small>
                </div>
                
                <div class="format-card" onclick="toggleFormat(this, 'display_320x50')">
                    <h4><input type="checkbox" name="standard_formats" value="display_320x50" checked> Mobile Banner</h4>
                    <div style="color: #666;">320x50</div>
                    <small>Standard mobile banner</small>
                </div>
                
                <div class="format-card" onclick="toggleFormat(this, 'display_300x600')">
                    <h4><input type="checkbox" name="standard_formats" value="display_300x600"> Half Page</h4>
                    <div style="color: #666;">300x600</div>
                    <small>High-impact sidebar</small>
                </div>
                
                <div class="format-card" onclick="toggleFormat(this, 'display_970x250')">
                    <h4><input type="checkbox" name="standard_formats" value="display_970x250"> Billboard</h4>
                    <div style="color: #666;">970x250</div>
                    <small>Premium large format</small>
                </div>
                
                <div class="format-card" onclick="toggleFormat(this, 'display_320x480')">
                    <h4><input type="checkbox" name="standard_formats" value="display_320x480"> Mobile Interstitial</h4>
                    <div style="color: #666;">320x480</div>
                    <small>Full-screen mobile</small>
                </div>
            </div>
            
            <h3 style="margin-top: 2rem;">Video Formats</h3>
            <div class="format-grid">
                <div class="format-card" onclick="toggleFormat(this, 'video_instream')">
                    <h4><input type="checkbox" name="standard_formats" value="video_instream" checked> In-Stream Video</h4>
                    <div style="color: #666;">VAST 4.0</div>
                    <small>Pre-roll, mid-roll, post-roll</small>
                </div>
                
                <div class="format-card" onclick="toggleFormat(this, 'video_outstream')">
                    <h4><input type="checkbox" name="standard_formats" value="video_outstream"> Out-Stream Video</h4>
                    <div style="color: #666;">In-article player</div>
                    <small>Auto-play in content</small>
                </div>
            </div>
            
            <h3 style="margin-top: 2rem;">Native Formats</h3>
            <div class="format-grid">
                <div class="format-card" onclick="toggleFormat(this, 'native_content')">
                    <h4><input type="checkbox" name="standard_formats" value="native_content"> Native Content</h4>
                    <div style="color: #666;">Flexible layout</div>
                    <small>Matches site design</small>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Add Custom Formats -->
        <div id="step3" class="wizard-content" style="display: none;">
            <h2>Add Custom Ad Formats</h2>
            <p>Define any custom or proprietary ad formats unique to your platform.</p>
            
            <div id="customFormatsList"></div>
            
            <button type="button" class="btn btn-secondary" onclick="addCustomFormat()">+ Add Custom Format</button>
            
            <div id="customFormatTemplate" style="display: none;">
                <div class="custom-format-form">
                    <h4>New Custom Format</h4>
                    <div class="form-group">
                        <label>Format Name *</label>
                        <input type="text" name="custom_format_name[]" placeholder="e.g., Homepage Takeover">
                    </div>
                    <div class="form-group">
                        <label>Format ID *</label>
                        <input type="text" name="custom_format_id[]" placeholder="e.g., homepage_takeover">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="custom_format_description[]" rows="2" placeholder="Describe this ad format"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Specifications</label>
                        <input type="text" name="custom_format_specs[]" placeholder="e.g., 1920x400, max 500KB">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="removeCustomFormat(this)">Remove</button>
                </div>
            </div>
        </div>
        
        <!-- Step 4: Setup Products -->
        <div id="step4" class="wizard-content" style="display: none;">
            <h2>Setup Standard Products</h2>
            <p>Create your initial advertising products. You can always add more products later.</p>
            
            <div class="product-list">
                <div class="product-item">
                    <h4>Run of Network - Display</h4>
                    <p>Standard display advertising across your entire network</p>
                    <div class="form-group">
                        <label><input type="checkbox" name="product_ron_display" checked> Enable this product</label>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>CPM Rate</label>
                            <input type="number" name="ron_display_cpm" value="5.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Minimum Budget</label>
                            <input type="number" name="ron_display_min_budget" value="1000" step="100">
                        </div>
                    </div>
                </div>
                
                <div class="product-item">
                    <h4>Run of Network - Video</h4>
                    <p>Video advertising across your video content</p>
                    <div class="form-group">
                        <label><input type="checkbox" name="product_ron_video" checked> Enable this product</label>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>CPM Rate</label>
                            <input type="number" name="ron_video_cpm" value="15.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Minimum Budget</label>
                            <input type="number" name="ron_video_min_budget" value="2500" step="100">
                        </div>
                    </div>
                </div>
                
                <div class="product-item">
                    <h4>Homepage Premium</h4>
                    <p>Premium placement on your homepage</p>
                    <div class="form-group">
                        <label><input type="checkbox" name="product_homepage"> Enable this product</label>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>CPM Rate</label>
                            <input type="number" name="homepage_cpm" value="25.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Minimum Budget</label>
                            <input type="number" name="homepage_min_budget" value="5000" step="100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 5: Add Principals -->
        <div id="step5" class="wizard-content" style="display: none;">
            <h2>Add Initial Principals</h2>
            <p>Add one or more advertisers (principals) who will be using your platform.</p>
            
            <div id="principalsList">
                <div class="principal-card">
                    <h4>Principal 1</h4>
                    <div class="form-group">
                        <label>Company Name *</label>
                        <input type="text" name="principal_name[]" placeholder="e.g., Acme Corporation" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" name="principal_email[]" placeholder="contact@example.com">
                    </div>
                    <div class="form-group">
                        <label>Ad Server ID (optional)</label>
                        <input type="text" name="principal_adapter_id[]" placeholder="ID in your ad server">
                        <small>If you already have this advertiser in your ad server</small>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="addPrincipal()">+ Add Another Principal</button>
        </div>
        
        <!-- Hidden fields for basic tenant info -->
        <input type="hidden" name="tenant_name" value="{{ tenant_name }}">
        <input type="hidden" name="tenant_id" value="{{ tenant_id }}">
        
        <div class="wizard-footer">
            <button type="button" class="btn btn-secondary" onclick="previousStep()" id="prevBtn" style="display: none;">Previous</button>
            <button type="button" class="btn" onclick="nextStep()" id="nextBtn">Next</button>
            <button type="submit" class="btn" id="submitBtn" style="display: none;">Complete Setup</button>
        </div>
    </form>
</div>

<style>
.radio-card {
    display: block;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
}

.radio-card:hover {
    border-color: #3498db;
}

.radio-card input[type="radio"] {
    display: none;
}

.radio-card input[type="radio"]:checked + .radio-card-content {
    border-color: #3498db;
}

.radio-card-content h4 {
    margin: 0 0 0.5rem 0;
}

.radio-card-content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.radio-card input[type="radio"]:checked ~ .radio-card-content::before {
    content: '✓';
    position: absolute;
    right: 1rem;
    top: 1rem;
    color: #3498db;
    font-weight: bold;
}
</style>

<script>
let currentStep = 1;
const totalSteps = 5;

function showAdapterConfig(adapter) {
    document.querySelectorAll('.adapter-config').forEach(el => {
        el.style.display = 'none';
    });
    const configEl = document.getElementById('config-' + adapter);
    if (configEl) {
        configEl.style.display = 'block';
    }
}

function toggleFormat(card, formatId) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    card.classList.toggle('selected', checkbox.checked);
}

function addCustomFormat() {
    const template = document.getElementById('customFormatTemplate').innerHTML;
    const container = document.getElementById('customFormatsList');
    const div = document.createElement('div');
    div.innerHTML = template;
    container.appendChild(div.firstElementChild);
}

function removeCustomFormat(button) {
    button.closest('.custom-format-form').remove();
}

function addPrincipal() {
    const principalsList = document.getElementById('principalsList');
    const count = principalsList.children.length + 1;
    const principalCard = document.createElement('div');
    principalCard.className = 'principal-card';
    principalCard.innerHTML = `
        <h4>Principal ${count}</h4>
        <div class="form-group">
            <label>Company Name *</label>
            <input type="text" name="principal_name[]" placeholder="e.g., Acme Corporation" required>
        </div>
        <div class="form-group">
            <label>Contact Email</label>
            <input type="email" name="principal_email[]" placeholder="contact@example.com">
        </div>
        <div class="form-group">
            <label>Ad Server ID (optional)</label>
            <input type="text" name="principal_adapter_id[]" placeholder="ID in your ad server">
            <small>If you already have this advertiser in your ad server</small>
        </div>
        <button type="button" class="btn btn-secondary" onclick="this.closest('.principal-card').remove()">Remove</button>
    `;
    principalsList.appendChild(principalCard);
}

function showStep(step) {
    // Hide all steps
    for (let i = 1; i <= totalSteps; i++) {
        document.getElementById('step' + i).style.display = 'none';
    }
    
    // Show current step
    document.getElementById('step' + step).style.display = 'block';
    
    // Update step indicators
    document.querySelectorAll('.wizard-step').forEach(el => {
        const stepNum = parseInt(el.dataset.step);
        el.classList.remove('active');
        if (stepNum < step) {
            el.classList.add('completed');
        } else if (stepNum === step) {
            el.classList.add('active');
            el.classList.remove('completed');
        } else {
            el.classList.remove('completed');
        }
    });
    
    // Update buttons
    document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = step === totalSteps ? 'none' : 'inline-block';
    document.getElementById('submitBtn').style.display = step === totalSteps ? 'inline-block' : 'none';
}

function validateStep(step) {
    switch(step) {
        case 1:
            // Validate ad server selection
            const adapter = document.querySelector('input[name="adapter"]:checked');
            if (!adapter) {
                alert('Please select an ad server platform');
                return false;
            }
            
            // Validate adapter-specific fields
            if (adapter.value === 'google_ad_manager') {
                const networkCode = document.getElementById('gam_network_code').value;
                if (!networkCode) {
                    alert('Please enter your Google Ad Manager network code');
                    return false;
                }
            } else if (adapter.value === 'kevel') {
                const networkId = document.getElementById('kevel_network_id').value;
                const apiKey = document.getElementById('kevel_api_key').value;
                if (!networkId || !apiKey) {
                    alert('Please enter your Kevel network ID and API key');
                    return false;
                }
            }
            break;
            
        case 2:
            // At least one format should be selected
            const formats = document.querySelectorAll('input[name="standard_formats"]:checked');
            if (formats.length === 0) {
                alert('Please select at least one ad format');
                return false;
            }
            break;
            
        case 5:
            // At least one principal with name
            const principalNames = document.querySelectorAll('input[name="principal_name[]"]');
            let hasValidPrincipal = false;
            principalNames.forEach(input => {
                if (input.value.trim()) {
                    hasValidPrincipal = true;
                }
            });
            if (!hasValidPrincipal) {
                alert('Please add at least one principal with a company name');
                return false;
            }
            break;
    }
    return true;
}

function nextStep() {
    if (validateStep(currentStep)) {
        currentStep++;
        showStep(currentStep);
    }
}

function previousStep() {
    currentStep--;
    showStep(currentStep);
}

// Initialize
showStep(1);

// Handle form submission
document.getElementById('wizardForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (validateStep(currentStep)) {
        // Submit the form
        this.submit();
    }
});
</script>
{% endblock %}