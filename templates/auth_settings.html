{% extends "base.html" %}

{% block title %}Authentication Settings - {{ tenant.name }}{% endblock %}

{% block content %}
<style>
    .auth-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        color: #6b7280;
    }

    .breadcrumb {
        margin-bottom: 1rem;
    }

    .breadcrumb a {
        color: #6b7280;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: #111827;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .card-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-enabled {
        background: #d1fae5;
        color: #065f46;
    }

    .status-disabled {
        background: #f3f4f6;
        color: #6b7280;
    }

    .status-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group .help-text {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.375rem;
    }

    .redirect-uri-box {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .redirect-uri-box label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        display: block;
    }

    .redirect-uri-value {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .redirect-uri-value code {
        flex: 1;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
        font-family: monospace;
        word-break: break-all;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .btn-outline {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
    }

    .btn-outline:hover {
        background: #f9fafb;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .button-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }

    .passkey-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .passkey-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }

    .passkey-info h4 {
        font-weight: 500;
        color: #111827;
        margin: 0 0 0.25rem 0;
    }

    .passkey-info p {
        font-size: 0.75rem;
        color: #6b7280;
        margin: 0;
    }

    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .alert-warning {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        color: #92400e;
    }

    .alert-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
    }

    .users-link {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }
</style>

<div class="auth-container">
    <div class="breadcrumb">
        <a href="{{ url_for('tenants.dashboard', tenant_id=tenant.tenant_id) }}">{{ tenant.name }}</a>
        <span style="color: #9ca3af; margin: 0 0.5rem;">/</span>
        <a href="{{ url_for('tenants.tenant_settings', tenant_id=tenant.tenant_id) }}">Settings</a>
        <span style="color: #9ca3af; margin: 0 0.5rem;">/</span>
        <span style="color: #374151;">Authentication</span>
    </div>

    <div class="page-header">
        <h1>Authentication Settings</h1>
        <p>Configure how users authenticate to access {{ tenant.name }}</p>
    </div>

    <!-- Passkeys Section -->
    <div class="card">
        <div class="card-header">
            <h2>Passkeys</h2>
            <span class="status-badge status-enabled">Always Available</span>
        </div>

        <p style="color: #6b7280; margin-bottom: 1rem;">
            Passkeys provide secure, passwordless authentication using your device's built-in security
            (Touch ID, Face ID, Windows Hello, or security keys).
        </p>

        <div id="passkey-list-container">
            <h3 style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.75rem;">Your Passkeys</h3>
            <ul class="passkey-list" id="passkey-list">
                <li class="passkey-item">
                    <div class="passkey-info">
                        <p>Loading...</p>
                    </div>
                </li>
            </ul>
            <button class="btn btn-outline" id="register-passkey-btn" style="margin-top: 0.75rem;">
                + Add Passkey
            </button>
        </div>
    </div>

    <!-- SSO/OIDC Section -->
    <div class="card">
        <div class="card-header">
            <h2>Single Sign-On (SSO)</h2>
            <span class="status-badge" id="oidc-status-badge">
                Loading...
            </span>
        </div>

        <p style="color: #6b7280; margin-bottom: 1rem;">
            Enable SSO to allow users to authenticate with your organization's identity provider
            (Google, Microsoft, Okta, etc.).
        </p>

        <div id="redirect-uri-warning" class="alert alert-warning" style="display: none;">
            <strong>Configuration Required:</strong> Your domain has changed. Please update your OAuth
            provider with the new redirect URI and re-test the connection.
        </div>

        <div class="redirect-uri-box">
            <label>Required Redirect URI</label>
            <div class="redirect-uri-value">
                <code id="redirect-uri">Loading...</code>
                <button class="btn btn-secondary" id="copy-uri-btn" type="button">Copy</button>
            </div>
            <p class="help-text" style="margin-top: 0.5rem;">
                Configure this URI in your OAuth provider's allowed redirect URIs
            </p>
        </div>

        <form id="oidc-form">
            <div class="form-group">
                <label for="provider">Provider</label>
                <select id="provider" name="provider">
                    <option value="">Select a provider...</option>
                    <option value="google">Google</option>
                    <option value="microsoft">Microsoft</option>
                    <option value="custom">Custom OIDC</option>
                </select>
            </div>

            <div id="discovery-url-group" class="form-group" style="display: none;">
                <label for="discovery_url">Discovery URL</label>
                <input type="url" id="discovery_url" name="discovery_url"
                       placeholder="https://your-idp.com/.well-known/openid-configuration">
                <p class="help-text">The OIDC discovery endpoint URL</p>
            </div>

            <div class="form-group">
                <label for="client_id">Client ID</label>
                <input type="text" id="client_id" name="client_id"
                       placeholder="your-client-id.apps.googleusercontent.com">
            </div>

            <div class="form-group">
                <label for="client_secret">Client Secret</label>
                <input type="password" id="client_secret" name="client_secret"
                       placeholder="Enter client secret">
                <p class="help-text">Your secret will be encrypted before storage</p>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary" id="save-oidc-btn">Save Configuration</button>
                <button type="button" class="btn btn-secondary" id="test-oidc-btn" disabled>Test Connection</button>
                <button type="button" class="btn btn-success" id="enable-oidc-btn" style="display: none;">Enable SSO</button>
                <button type="button" class="btn btn-danger" id="disable-oidc-btn" style="display: none;">Disable SSO</button>
            </div>
        </form>
    </div>

    <!-- User Management Link -->
    <div class="card">
        <div class="card-header">
            <h2>User Management</h2>
        </div>

        <p style="color: #6b7280; margin-bottom: 1rem;">
            Manage who can access this tenant. Users must be added before they can log in
            (whether via passkey or SSO).
        </p>

        <a href="{{ url_for('users.list_users', tenant_id=tenant.tenant_id) }}" class="btn btn-primary">
            Manage Users
        </a>
    </div>
</div>

<script>
const tenantId = '{{ tenant.tenant_id }}';
const scriptRoot = '{{ request.script_root }}' || '';

// Load auth config on page load
async function loadAuthConfig() {
    try {
        const response = await fetch(`${scriptRoot}/auth/oidc/config?tenant_id=${tenantId}`, {
            credentials: 'same-origin'
        });
        const data = await response.json();

        // Update redirect URI
        document.getElementById('redirect-uri').textContent = data.redirect_uri || 'Not available';

        // Update status badge
        const statusBadge = document.getElementById('oidc-status-badge');
        if (data.oidc_enabled) {
            statusBadge.textContent = 'Enabled';
            statusBadge.className = 'status-badge status-enabled';
            document.getElementById('disable-oidc-btn').style.display = 'inline-flex';
            document.getElementById('enable-oidc-btn').style.display = 'none';
        } else if (data.oidc_configured) {
            if (data.oidc_valid) {
                statusBadge.textContent = 'Verified - Ready to Enable';
                statusBadge.className = 'status-badge status-warning';
                document.getElementById('enable-oidc-btn').style.display = 'inline-flex';
            } else {
                statusBadge.textContent = 'Not Verified';
                statusBadge.className = 'status-badge status-warning';
            }
        } else {
            statusBadge.textContent = 'Not Configured';
            statusBadge.className = 'status-badge status-disabled';
        }

        // Show warning if redirect URI changed
        if (data.redirect_uri_changed) {
            document.getElementById('redirect-uri-warning').style.display = 'block';
        }

        // Enable test button if configured
        if (data.oidc_configured) {
            document.getElementById('test-oidc-btn').disabled = false;
        }

    } catch (err) {
        console.error('Failed to load auth config:', err);
    }
}

// Load passkeys
async function loadPasskeys() {
    try {
        const response = await fetch(`${scriptRoot}/auth/passkey/list?tenant_id=${tenantId}`, {
            credentials: 'same-origin'
        });
        const data = await response.json();

        const list = document.getElementById('passkey-list');

        if (data.passkeys && data.passkeys.length > 0) {
            list.innerHTML = data.passkeys.map(pk => `
                <li class="passkey-item">
                    <div class="passkey-info">
                        <h4>${pk.name}</h4>
                        <p>Created: ${pk.created_at ? new Date(pk.created_at).toLocaleDateString() : 'Unknown'}
                           ${pk.last_used_at ? ' | Last used: ' + new Date(pk.last_used_at).toLocaleDateString() : ''}</p>
                    </div>
                    <button class="btn btn-danger" onclick="deletePasskey(${pk.id})">Remove</button>
                </li>
            `).join('');
        } else {
            list.innerHTML = `
                <li class="passkey-item">
                    <div class="passkey-info">
                        <p>No passkeys registered yet</p>
                    </div>
                </li>
            `;
        }
    } catch (err) {
        console.error('Failed to load passkeys:', err);
    }
}

// Provider change handler
document.getElementById('provider').addEventListener('change', function() {
    const discoveryGroup = document.getElementById('discovery-url-group');
    discoveryGroup.style.display = this.value === 'custom' ? 'block' : 'none';
});

// Copy redirect URI
document.getElementById('copy-uri-btn').addEventListener('click', function() {
    const uri = document.getElementById('redirect-uri').textContent;
    navigator.clipboard.writeText(uri).then(() => {
        this.textContent = 'Copied!';
        setTimeout(() => { this.textContent = 'Copy'; }, 2000);
    });
});

// Save OIDC config
document.getElementById('oidc-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const provider = document.getElementById('provider').value;
    const clientId = document.getElementById('client_id').value;
    const clientSecret = document.getElementById('client_secret').value;
    const discoveryUrl = document.getElementById('discovery_url').value;

    if (!provider || !clientId || !clientSecret) {
        alert('Please fill in all required fields');
        return;
    }

    try {
        const response = await fetch(`${scriptRoot}/auth/oidc/config?tenant_id=${tenantId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                provider,
                client_id: clientId,
                client_secret: clientSecret,
                discovery_url: provider === 'custom' ? discoveryUrl : undefined
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert('Configuration saved! Please test the connection.');
            loadAuthConfig();
        } else {
            alert('Error: ' + (data.error || 'Failed to save'));
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
});

// Test OIDC
document.getElementById('test-oidc-btn').addEventListener('click', function() {
    window.location.href = `${scriptRoot}/auth/oidc/test/${tenantId}`;
});

// Enable OIDC
document.getElementById('enable-oidc-btn').addEventListener('click', async function() {
    try {
        const response = await fetch(`${scriptRoot}/auth/oidc/enable?tenant_id=${tenantId}`, {
            method: 'POST',
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (response.ok) {
            alert('SSO enabled successfully!');
            loadAuthConfig();
        } else {
            alert('Error: ' + (data.error || 'Failed to enable'));
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
});

// Disable OIDC
document.getElementById('disable-oidc-btn').addEventListener('click', async function() {
    if (!confirm('Are you sure you want to disable SSO? Users will need to use passkeys to log in.')) {
        return;
    }

    try {
        const response = await fetch(`${scriptRoot}/auth/oidc/disable?tenant_id=${tenantId}`, {
            method: 'POST',
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (response.ok) {
            alert('SSO disabled.');
            loadAuthConfig();
        } else {
            alert('Error: ' + (data.error || 'Failed to disable'));
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
});

// Delete passkey
async function deletePasskey(id) {
    if (!confirm('Are you sure you want to remove this passkey?')) {
        return;
    }

    try {
        const response = await fetch(`${scriptRoot}/auth/passkey/${id}?tenant_id=${tenantId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });

        if (response.ok) {
            loadPasskeys();
        } else {
            alert('Failed to remove passkey');
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

// Register new passkey
document.getElementById('register-passkey-btn').addEventListener('click', async function() {
    try {
        // Get registration options
        const optResponse = await fetch(`${scriptRoot}/auth/passkey/register/options?tenant_id=${tenantId}`, {
            method: 'POST',
            credentials: 'same-origin'
        });

        if (!optResponse.ok) {
            const err = await optResponse.json();
            alert('Error: ' + (err.error || 'Failed to start registration'));
            return;
        }

        const options = await optResponse.json();

        // Convert base64url to ArrayBuffer
        function base64urlToBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const padLen = (4 - base64.length % 4) % 4;
            const padded = base64 + '='.repeat(padLen);
            const binary = atob(padded);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function bufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Prepare for WebAuthn
        const publicKey = {
            challenge: base64urlToBuffer(options.challenge),
            rp: options.rp,
            user: {
                id: base64urlToBuffer(options.user.id),
                name: options.user.name,
                displayName: options.user.displayName
            },
            pubKeyCredParams: options.pubKeyCredParams,
            timeout: options.timeout,
            authenticatorSelection: options.authenticatorSelection,
            attestation: options.attestation
        };

        // Create credential
        const credential = await navigator.credentials.create({publicKey});

        // Prepare for server
        const credentialData = {
            id: credential.id,
            rawId: bufferToBase64url(credential.rawId),
            type: credential.type,
            response: {
                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                attestationObject: bufferToBase64url(credential.response.attestationObject)
            }
        };

        // Verify with server
        const name = prompt('Give this passkey a name:', 'My Passkey');
        if (!name) return;

        const verifyResponse = await fetch(`${scriptRoot}/auth/passkey/register/verify?tenant_id=${tenantId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({credential: credentialData, name})
        });

        if (verifyResponse.ok) {
            alert('Passkey registered successfully!');
            loadPasskeys();
        } else {
            const err = await verifyResponse.json();
            alert('Error: ' + (err.error || 'Registration failed'));
        }

    } catch (err) {
        if (err.name === 'NotAllowedError') {
            alert('Passkey registration was cancelled');
        } else {
            alert('Error: ' + err.message);
        }
    }
});

// Initialize
loadAuthConfig();
loadPasskeys();
</script>
{% endblock %}
