{% extends "base.html" %}

{% block title %}Configure Google Ad Manager Settings - {{ product.name }}{% endblock %}

{% block content %}
<div class="card">
    <h2>Google Ad Manager Configuration</h2>
    <h3>{{ product.name }}</h3>

    {% if not inventory_synced %}
    <div class="alert alert-warning" style="margin-bottom: 2rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
        <h4 style="margin-top: 0; color: #856404;">⚠️ Inventory Not Synced</h4>
        <p style="margin-bottom: 1rem;">GAM inventory has not been synced yet. The "Browse Inventory" buttons below will not work until inventory is synced.</p>
        <button type="button" class="btn btn-primary" onclick="syncInventory()" id="syncBtn">
            <i class="bi bi-arrow-clockwise"></i> Sync Inventory Now
        </button>
        <div id="syncStatus" style="margin-top: 0.5rem;"></div>
    </div>
    {% endif %}

    <form id="gam-config-form" method="POST">
        <!-- Order Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Order Settings</h4>

        <div class="form-group">
            <label for="order_name_template">Order Name Template *</label>
            <input type="text" id="order_name_template" name="order_name_template"
                   value="{{ config.order_name_template or 'AdCP-{po_number}-{product_name}-{timestamp}' }}"
                   placeholder="AdCP-{po_number}-{product_name}-{timestamp}" required>
            <small style="color: #666;">Variables: {po_number}, {product_name}, {timestamp}, {principal_name}</small>
        </div>

        <div class="form-group">
            <label for="applied_team_ids">Team IDs (comma-separated)</label>
            <input type="text" id="applied_team_ids" name="applied_team_ids"
                   value="{{ ','.join(config.applied_team_ids|map('string')) if config.applied_team_ids else '' }}"
                   placeholder="12345, 67890">
            <small style="color: #666;">GAM team IDs for access control</small>
        </div>

        <!-- Line Item Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Line Item Settings</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="line_item_type">Line Item Type *</label>
                <select id="line_item_type" name="line_item_type" required>
                    <option value="STANDARD" {% if config.line_item_type == 'STANDARD' %}selected{% endif %}>Standard</option>
                    <option value="SPONSORSHIP" {% if config.line_item_type == 'SPONSORSHIP' %}selected{% endif %}>Sponsorship</option>
                    <option value="NETWORK" {% if config.line_item_type == 'NETWORK' %}selected{% endif %}>Network</option>
                    <option value="HOUSE" {% if config.line_item_type == 'HOUSE' %}selected{% endif %}>House</option>
                    <option value="PRICE_PRIORITY" {% if config.line_item_type == 'PRICE_PRIORITY' %}selected{% endif %}>Price Priority</option>
                </select>
            </div>

            <div class="form-group">
                <label for="priority">Priority (1-16) *</label>
                <input type="number" id="priority" name="priority" min="1" max="16"
                       value="{{ config.priority or 8 }}" required>
                <small style="color: #666;">Lower = higher priority</small>
            </div>

            <div class="form-group">
                <label for="cost_type">Cost Type *</label>
                <select id="cost_type" name="cost_type" required>
                    <option value="CPM" {% if config.cost_type == 'CPM' %}selected{% endif %}>CPM</option>
                    <option value="CPC" {% if config.cost_type == 'CPC' %}selected{% endif %}>CPC</option>
                    <option value="CPD" {% if config.cost_type == 'CPD' %}selected{% endif %}>CPD</option>
                    <option value="CPA" {% if config.cost_type == 'CPA' %}selected{% endif %}>CPA</option>
                </select>
            </div>
        </div>

        <!-- Delivery Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Delivery Settings</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="creative_rotation_type">Creative Rotation (optional - will use defaults)</label>
                <select id="creative_rotation_type" name="creative_rotation_type">
                    <option value="">Use Default</option>
                    <option value="EVEN" {% if config.creative_rotation_type == 'EVEN' %}selected{% endif %}>Even</option>
                    <option value="OPTIMIZED" {% if config.creative_rotation_type == 'OPTIMIZED' %}selected{% endif %}>Optimized</option>
                    <option value="MANUAL" {% if config.creative_rotation_type == 'MANUAL' %}selected{% endif %}>Manual</option>
                    <option value="SEQUENTIAL" {% if config.creative_rotation_type == 'SEQUENTIAL' %}selected{% endif %}>Sequential</option>
                </select>
            </div>

            <div class="form-group">
                <label for="delivery_rate_type">Delivery Pacing (optional - will use defaults)</label>
                <select id="delivery_rate_type" name="delivery_rate_type">
                    <option value="">Use Default</option>
                    <option value="EVENLY" {% if config.delivery_rate_type == 'EVENLY' %}selected{% endif %}>Evenly</option>
                    <option value="FRONTLOADED" {% if config.delivery_rate_type == 'FRONTLOADED' %}selected{% endif %}>Frontloaded</option>
                    <option value="AS_FAST_AS_POSSIBLE" {% if config.delivery_rate_type == 'AS_FAST_AS_POSSIBLE' %}selected{% endif %}>As Fast As Possible</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="primary_goal_type">Primary Goal Type (optional - will use defaults)</label>
                <select id="primary_goal_type" name="primary_goal_type">
                    <option value="">Use Default</option>
                    <option value="LIFETIME" {% if config.primary_goal_type == 'LIFETIME' %}selected{% endif %}>Lifetime</option>
                    <option value="DAILY" {% if config.primary_goal_type == 'DAILY' %}selected{% endif %}>Daily</option>
                    <option value="NONE" {% if config.primary_goal_type == 'NONE' %}selected{% endif %}>None</option>
                </select>
            </div>

            <div class="form-group">
                <label for="primary_goal_unit_type">Goal Unit Type (optional - will use defaults)</label>
                <select id="primary_goal_unit_type" name="primary_goal_unit_type">
                    <option value="">Use Default</option>
                    <option value="IMPRESSIONS" {% if config.primary_goal_unit_type == 'IMPRESSIONS' %}selected{% endif %}>Impressions</option>
                    <option value="CLICKS" {% if config.primary_goal_unit_type == 'CLICKS' %}selected{% endif %}>Clicks</option>
                    <option value="VIEWABLE_IMPRESSIONS" {% if config.primary_goal_unit_type == 'VIEWABLE_IMPRESSIONS' %}selected{% endif %}>Viewable Impressions</option>
                </select>
            </div>
        </div>

        <!-- Automation Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Automation Settings</h4>

        <div id="automation-settings">
            <div class="form-group">
                <label for="non_guaranteed_automation">Non-Guaranteed Order Automation (optional - will use defaults)</label>
                <select id="non_guaranteed_automation" name="non_guaranteed_automation">
                    <option value="manual" {% if config.non_guaranteed_automation == 'manual' %}selected{% endif %}>Manual - Human handles all activation steps</option>
                    <option value="confirmation_required" {% if config.non_guaranteed_automation == 'confirmation_required' %}selected{% endif %}>Confirmation Required - Human approval then auto-activation</option>
                    <option value="automatic" {% if config.non_guaranteed_automation == 'automatic' %}selected{% endif %}>Automatic - Instant activation after creation</option>
                </select>
                <small style="color: #666;">
                    <div id="automation-help-text">
                        <div id="automation-help-manual" style="display: {% if config.non_guaranteed_automation != 'manual' %}none{% else %}block{% endif %};">
                            <strong>Manual Mode:</strong> Orders created but never automatically activated. Publisher must manually activate in GAM.
                        </div>
                        <div id="automation-help-confirmation" style="display: {% if config.non_guaranteed_automation != 'confirmation_required' %}none{% else %}block{% endif %};">
                            <strong>Confirmation Mode:</strong> Order created, workflow task generated for approval, then automatically activated after approval.
                        </div>
                        <div id="automation-help-automatic" style="display: {% if config.non_guaranteed_automation != 'automatic' %}none{% else %}block{% endif %};">
                            <strong>Automatic Mode:</strong> Orders immediately activated after creation. Use with caution!
                        </div>
                    </div>
                </small>
            </div>

            <div class="alert alert-info" style="margin-top: 1rem;">
                <strong>ℹ️ Important Notes:</strong>
                <ul style="margin-bottom: 0; padding-left: 20px;">
                    <li><strong>Guaranteed orders</strong> (Standard, Sponsorship) are ALWAYS manual regardless of this setting</li>
                    <li><strong>Non-guaranteed orders</strong> (Network, House, Price Priority) use this automation setting</li>
                    <li>This setting only applies when the line item type above is non-guaranteed</li>
                    <li>Automatic activation requires proper GAM credentials and permissions</li>
                </ul>
            </div>
        </div>

        <!-- Ad Unit/Placement Targeting -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Ad Unit & Placement Targeting</h4>

        <div class="form-group">
            <label for="ad-unit-search">Targeted Ad Units</label>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="ad-unit-search" placeholder="Search ad units..." style="flex: 1;">
                <button type="button" onclick="openInventoryPicker('ad_unit')" class="btn btn-secondary">Browse Ad Units</button>
            </div>
            <div id="selected-ad-units" style="min-height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: #f9f9f9;">
                <!-- Selected ad units will appear here as badges -->
            </div>
            <small style="color: #666;">Click "Browse Ad Units" to select from your GAM inventory</small>
            <!-- Hidden textarea to submit values -->
            <textarea id="targeted_ad_unit_ids" name="targeted_ad_unit_ids" style="display: none;">{{ '\n'.join(config.targeted_ad_unit_ids) if config.targeted_ad_unit_ids else '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="placement-search">Targeted Placements</label>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="placement-search" placeholder="Search placements..." style="flex: 1;">
                <button type="button" onclick="openInventoryPicker('placement')" class="btn btn-secondary">Browse Placements</button>
            </div>
            <div id="selected-placements" style="min-height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: #f9f9f9;">
                <!-- Selected placements will appear here as badges -->
            </div>
            <small style="color: #666;">Click "Browse Placements" to select from your GAM inventory</small>
            <!-- Hidden textarea to submit values -->
            <textarea id="targeted_placement_ids" name="targeted_placement_ids" style="display: none;">{{ '\n'.join(config.targeted_placement_ids) if config.targeted_placement_ids else '' }}</textarea>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="include_descendants"
                       {% if config.include_descendants != False %}checked{% endif %}>
                Include child ad units in targeting
            </label>
        </div>

        <!-- Creative Placeholders -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Creative Placeholders</h4>

        <div id="creative-placeholders">
            {% if config.creative_placeholders %}
                {% for placeholder in config.creative_placeholders %}
                <div class="creative-placeholder-item" style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label>Width (px)</label>
                            <input type="number" name="placeholder_width[]" value="{{ placeholder.width }}" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Height (px)</label>
                            <input type="number" name="placeholder_height[]" value="{{ placeholder.height }}" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Expected Count</label>
                            <input type="number" name="placeholder_count[]" value="{{ placeholder.expected_creative_count }}" min="1" required>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="removeCreativePlaceholder(this)">Remove</button>
                    </div>
                    <label style="margin-top: 0.5rem;">
                        <input type="checkbox" name="placeholder_is_native[]" {% if placeholder.is_native %}checked{% endif %}>
                        Native creative
                    </label>
                </div>
                {% endfor %}
            {% else %}
                <!-- Default creative placeholders -->
                <div class="creative-placeholder-item" style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label>Width (px)</label>
                            <input type="number" name="placeholder_width[]" value="300" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Height (px)</label>
                            <input type="number" name="placeholder_height[]" value="250" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Expected Count</label>
                            <input type="number" name="placeholder_count[]" value="1" min="1" required>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="removeCreativePlaceholder(this)">Remove</button>
                    </div>
                    <label style="margin-top: 0.5rem;">
                        <input type="checkbox" name="placeholder_is_native[]">
                        Native creative
                    </label>
                </div>
            {% endif %}
        </div>
        <button type="button" class="btn btn-secondary" onclick="addCreativePlaceholder()">Add Creative Size</button>

        <!-- Frequency Capping -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Frequency Capping</h4>

        <div id="frequency-caps">
            {% if config.frequency_caps %}
                {% for cap in config.frequency_caps %}
                <div class="frequency-cap-item" style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label>Max Impressions</label>
                            <input type="number" name="cap_max_impressions[]" value="{{ cap.max_impressions }}" min="1" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Time Unit</label>
                            <select name="cap_time_unit[]" required>
                                <option value="MINUTE" {% if cap.time_unit == 'MINUTE' %}selected{% endif %}>Minute</option>
                                <option value="HOUR" {% if cap.time_unit == 'HOUR' %}selected{% endif %}>Hour</option>
                                <option value="DAY" {% if cap.time_unit == 'DAY' %}selected{% endif %}>Day</option>
                                <option value="WEEK" {% if cap.time_unit == 'WEEK' %}selected{% endif %}>Week</option>
                                <option value="MONTH" {% if cap.time_unit == 'MONTH' %}selected{% endif %}>Month</option>
                                <option value="LIFETIME" {% if cap.time_unit == 'LIFETIME' %}selected{% endif %}>Lifetime</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Time Range</label>
                            <input type="number" name="cap_time_range[]" value="{{ cap.time_range }}" min="1" required>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="removeFrequencyCap(this)">Remove</button>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <button type="button" class="btn btn-secondary" onclick="addFrequencyCap()">Add Frequency Cap</button>

        <!-- Competition & Exclusions -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Competition & Exclusions</h4>

        <div class="form-group">
            <label for="competitive_exclusion_labels">Competitive Exclusion Labels</label>
            <input type="text" id="competitive_exclusion_labels" name="competitive_exclusion_labels"
                   value="{{ ','.join(config.competitive_exclusion_labels) if config.competitive_exclusion_labels else '' }}"
                   placeholder="automotive, finance, travel">
            <small style="color: #666;">Comma-separated labels to prevent competitive ads</small>
        </div>

        <!-- Custom Targeting -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Custom Targeting (Key-Value Pairs)</h4>

        <div class="form-group">
            <label>GAM Custom Targeting Configuration</label>
            <p style="color: #666; font-size: 0.9em;">
                Configure custom targeting structure using existing GAM key-value pairs. These keys and values must already exist in your GAM account.
                <br><small><strong>Note:</strong> This references existing GAM keys - it does NOT create new keys in GAM. Find Key IDs and Value IDs in GAM under Inventory → Key-values.</small>
            </p>

            <!-- Custom Targeting Structure Builder -->
            <div id="keyValueBuilder" class="border rounded p-3 mb-3" style="background: #f8f9fa;">
                <div class="alert alert-info mb-3" style="font-size: 0.85em;">
                    <strong>ℹ️ How to use:</strong>
                    <ul class="mb-0" style="padding-left: 20px;">
                        <li>Build targeting expressions using existing GAM Key IDs and Value IDs</li>
                        <li>Use logical operators (AND/OR) to combine multiple criteria</li>
                        <li>The structure will be applied exactly as configured to each line item</li>
                    </ul>
                </div>

                <div id="customTargetingStructure">
                    <!-- Custom targeting structure will be built here -->
                </div>

                <button type="button" class="btn btn-sm btn-primary" onclick="addTargetingNode()">
                    + Add Targeting Criteria
                </button>
            </div>

            <!-- Hidden field to store the custom targeting structure -->
            <input type="hidden" id="custom_targeting_keys" name="custom_targeting_keys" value='{{ config.custom_targeting_keys|tojson if config.custom_targeting_keys else "{}" }}'>

            <!-- Raw JSON view (collapsible) -->
            <details>
                <summary style="cursor: pointer; color: #666; font-size: 0.9em;">View/Edit Raw GAM Targeting Structure</summary>
                <textarea id="custom_targeting_keys_raw" rows="8" class="form-control mt-2"
                          placeholder='{
  "logicalOperator": "OR",
  "children": [
    {
      "logicalOperator": "AND",
      "children": [
        {"keyId": 12345, "valueIds": [67890, 67891], "operator": "IS"}
      ]
    }
  ]
}'
                          onblur="updateFromRawJson()">{{ config.custom_targeting_keys|tojson(indent=2) if config.custom_targeting_keys else '{}' }}</textarea>
                <small class="text-muted">Enter the exact GAM custom targeting structure with Key IDs and Value IDs from your GAM account.</small>
            </details>
        </div>

        <!-- Advanced Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Advanced Settings</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="environment_type">Environment Type</label>
                <select id="environment_type" name="environment_type">
                    <option value="BROWSER" {% if config.environment_type == 'BROWSER' %}selected{% endif %}>Browser</option>
                    <option value="VIDEO_PLAYER" {% if config.environment_type == 'VIDEO_PLAYER' %}selected{% endif %}>Video Player</option>
                </select>
            </div>

            <div class="form-group">
                <label for="discount_type">Discount Type</label>
                <select id="discount_type" name="discount_type">
                    <option value="" {% if not config.discount_type %}selected{% endif %}>No discount</option>
                    <option value="PERCENTAGE" {% if config.discount_type == 'PERCENTAGE' %}selected{% endif %}>Percentage</option>
                    <option value="ABSOLUTE_VALUE" {% if config.discount_type == 'ABSOLUTE_VALUE' %}selected{% endif %}>Absolute Value</option>
                </select>
            </div>
        </div>

        <div class="form-group" id="discount_value_group" style="{% if not config.discount_type %}display: none;{% endif %}">
            <label for="discount_value">Discount Value</label>
            <input type="number" id="discount_value" name="discount_value" step="0.01"
                   value="{{ config.discount_value or '' }}"
                   placeholder="Enter percentage or absolute value">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label>
                    <input type="checkbox" name="allow_overbook"
                           {% if config.allow_overbook %}checked{% endif %}>
                    Allow Overbooking
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="skip_inventory_check"
                           {% if config.skip_inventory_check %}checked{% endif %}>
                    Skip Inventory Check
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="disable_viewability_avg_revenue_optimization"
                           {% if config.disable_viewability_avg_revenue_optimization %}checked{% endif %}>
                    Disable Viewability Optimization
                </label>
            </div>
        </div>

        <!-- Video-Specific Settings -->
        <div id="video-settings" style="{% if config.environment_type != 'VIDEO_PLAYER' %}display: none;{% endif %}">
            <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Video Settings</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="companion_delivery_option">Companion Delivery</label>
                    <select id="companion_delivery_option" name="companion_delivery_option">
                        <option value="" {% if not config.companion_delivery_option %}selected{% endif %}>None</option>
                        <option value="OPTIONAL" {% if config.companion_delivery_option == 'OPTIONAL' %}selected{% endif %}>Optional</option>
                        <option value="AT_LEAST_ONE" {% if config.companion_delivery_option == 'AT_LEAST_ONE' %}selected{% endif %}>At Least One</option>
                        <option value="ALL" {% if config.companion_delivery_option == 'ALL' %}selected{% endif %}>All</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="video_max_duration">Max Duration (seconds)</label>
                    <input type="number" id="video_max_duration" name="video_max_duration"
                           value="{{ (config.video_max_duration // 1000) if config.video_max_duration else '' }}"
                           placeholder="30">
                </div>

                <div class="form-group">
                    <label for="skip_offset">Skip Offset (seconds)</label>
                    <input type="number" id="skip_offset" name="skip_offset"
                           value="{{ (config.skip_offset // 1000) if config.skip_offset else '' }}"
                           placeholder="5">
                </div>
            </div>
        </div>

        <!-- Native Ad Settings -->
        <div class="form-group">
            <label for="native_style_id">Native Style ID</label>
            <input type="text" id="native_style_id" name="native_style_id"
                   value="{{ config.native_style_id or '' }}"
                   placeholder="GAM native style ID (if applicable)">
        </div>

        <!-- Actions -->
        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn">Save Configuration</button>
            <button type="button" class="btn btn-secondary" onclick="validateConfig()">Validate</button>
            <a href="{{ url_for('products.edit_product', tenant_id=tenant_id, product_id=product.product_id) }}"
               class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Custom Targeting Structure Builder Functions
let customTargetingData = null;

// Initialize custom targeting builder on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load existing custom targeting structure from the hidden field
    const existingData = document.getElementById('custom_targeting_keys').value;
    if (existingData && existingData !== '{}') {
        try {
            customTargetingData = JSON.parse(existingData);
            // Display existing structure
            displayCustomTargetingStructure(customTargetingData);
        } catch (e) {
            console.error('Error parsing existing custom targeting data:', e);
        }
    }
});

function displayCustomTargetingStructure(structure) {
    const container = document.getElementById('customTargetingStructure');
    if (!structure) {
        container.innerHTML = '<p class="text-muted">No custom targeting configured</p>';
        return;
    }

    // For now, just show the structure in a readable format
    // In a full implementation, this would be an interactive tree editor
    container.innerHTML = `
        <div class="alert alert-warning">
            <strong>Current Configuration:</strong>
            <pre style="margin-top: 10px; background: white; padding: 10px; border-radius: 4px;">
${JSON.stringify(structure, null, 2)}
            </pre>
            <small>Edit the raw JSON below to modify the targeting structure.</small>
        </div>
    `;
}

function addTargetingNode() {
    // Simplified for now - in production this would open a modal to build the structure
    alert('To configure custom targeting:\n\n1. Use the "View/Edit Raw GAM Targeting Structure" section below\n2. Enter your GAM Key IDs and Value IDs\n3. Use the structure shown in the placeholder\n\nNote: Key IDs and Value IDs must exist in your GAM account.');

    // Expand the raw editor
    const details = document.querySelector('details');
    if (details) {
        details.open = true;
    }
}

// Keep old function name for compatibility but update behavior
function addKeyValuePair(existingKey = '', existingValue = '') {
    const container = document.getElementById('keyValuePairs');
    const pairId = 'kvp_' + Date.now();

    const pairDiv = document.createElement('div');
    pairDiv.className = 'key-value-pair mb-2 p-2 border rounded';
    pairDiv.id = pairId;
    pairDiv.style.background = '#fff';

    pairDiv.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm"
                       placeholder="Key (e.g., category)"
                       value="${escapeHtml(existingKey)}"
                       onchange="updateKeyValue('${pairId}')"
                       data-role="key">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control form-control-sm"
                       placeholder="Value (e.g., sports)"
                       value="${escapeHtml(existingValue)}"
                       onchange="updateKeyValue('${pairId}')"
                       data-role="value">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeKeyValuePair('${pairId}')">
                    Remove
                </button>
            </div>
        </div>
    `;

    container.appendChild(pairDiv);

    // If this is a new pair (not loading existing), update the data
    if (!existingKey && !existingValue) {
        updateKeyValue(pairId);
    }
}

function displayKeyValuePair(key, value) {
    addKeyValuePair(key, value);
}

function removeKeyValuePair(pairId) {
    const pairDiv = document.getElementById(pairId);
    if (pairDiv) {
        const keyInput = pairDiv.querySelector('[data-role="key"]');
        if (keyInput && keyInput.value) {
            delete keyValueData[keyInput.value];
        }
        pairDiv.remove();
        updateHiddenField();
    }
}

function updateKeyValue(pairId) {
    const pairDiv = document.getElementById(pairId);
    if (!pairDiv) return;

    const keyInput = pairDiv.querySelector('[data-role="key"]');
    const valueInput = pairDiv.querySelector('[data-role="value"]');

    if (keyInput && valueInput) {
        const key = keyInput.value.trim();
        const value = valueInput.value.trim();

        if (key) {
            // Remove old key if it was changed
            const oldKey = keyInput.getAttribute('data-old-key');
            if (oldKey && oldKey !== key) {
                delete keyValueData[oldKey];
            }

            // Set new key-value
            keyValueData[key] = value;
            keyInput.setAttribute('data-old-key', key);

            updateHiddenField();
        }
    }
}

function updateHiddenField() {
    // Update the hidden field with the current key-value data
    document.getElementById('custom_targeting_keys').value = JSON.stringify(keyValueData);

    // Also update the raw JSON textarea if it's visible
    const rawTextarea = document.getElementById('custom_targeting_keys_raw');
    if (rawTextarea) {
        rawTextarea.value = JSON.stringify(keyValueData, null, 2);
    }
}

function updateFromRawJson() {
    const rawTextarea = document.getElementById('custom_targeting_keys_raw');
    if (!rawTextarea) return;

    try {
        const newData = JSON.parse(rawTextarea.value || '{}');
        customTargetingData = newData;

        // Update the hidden field
        document.getElementById('custom_targeting_keys').value = JSON.stringify(customTargetingData);

        // Update the display
        displayCustomTargetingStructure(customTargetingData);
    } catch (e) {
        alert('Invalid JSON format. Please check your syntax and ensure you have valid GAM targeting structure.');
        // Revert to current data
        if (customTargetingData) {
            rawTextarea.value = JSON.stringify(customTargetingData, null, 2);
        }
    }
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function validateConfig() {
    // Validate creative placeholders
    const placeholders = document.querySelectorAll('.creative-placeholder-item');
    if (placeholders.length === 0) {
        alert('Please add at least one creative placeholder');
        return false;
    }

    // Validate custom targeting JSON
    const customTargeting = document.getElementById('custom_targeting_keys').value;
    if (customTargeting) {
        try {
            JSON.parse(customTargeting);
        } catch (e) {
            alert('Invalid JSON in custom targeting keys');
            return false;
        }
    }

    alert('Configuration is valid!');
    return true;
}

// Creative Placeholder Management
function addCreativePlaceholder() {
    const container = document.getElementById('creative-placeholders');
    const newItem = document.createElement('div');
    newItem.className = 'creative-placeholder-item';
    newItem.style = 'background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;';
    newItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin: 0;">
                <label>Width (px)</label>
                <input type="number" name="placeholder_width[]" value="300" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Height (px)</label>
                <input type="number" name="placeholder_height[]" value="250" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Expected Count</label>
                <input type="number" name="placeholder_count[]" value="1" min="1" required>
            </div>
            <button type="button" class="btn btn-secondary" onclick="removeCreativePlaceholder(this)">Remove</button>
        </div>
        <label style="margin-top: 0.5rem;">
            <input type="checkbox" name="placeholder_is_native[]">
            Native creative
        </label>
    `;
    container.appendChild(newItem);
}

function removeCreativePlaceholder(button) {
    button.closest('.creative-placeholder-item').remove();
}

// Frequency Cap Management
function addFrequencyCap() {
    const container = document.getElementById('frequency-caps');
    const newItem = document.createElement('div');
    newItem.className = 'frequency-cap-item';
    newItem.style = 'background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;';
    newItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin: 0;">
                <label>Max Impressions</label>
                <input type="number" name="cap_max_impressions[]" value="3" min="1" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Time Unit</label>
                <select name="cap_time_unit[]" required>
                    <option value="MINUTE">Minute</option>
                    <option value="HOUR">Hour</option>
                    <option value="DAY" selected>Day</option>
                    <option value="WEEK">Week</option>
                    <option value="MONTH">Month</option>
                    <option value="LIFETIME">Lifetime</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Time Range</label>
                <input type="number" name="cap_time_range[]" value="1" min="1" required>
            </div>
            <button type="button" class="btn btn-secondary" onclick="removeFrequencyCap(this)">Remove</button>
        </div>
    `;
    container.appendChild(newItem);
}

function removeFrequencyCap(button) {
    button.closest('.frequency-cap-item').remove();
}

// Show/hide video settings based on environment type
document.getElementById('environment_type').addEventListener('change', function() {
    const videoSettings = document.getElementById('video-settings');
    if (this.value === 'VIDEO_PLAYER') {
        videoSettings.style.display = 'block';
    } else {
        videoSettings.style.display = 'none';
    }
});

// Show/hide discount value based on discount type
document.getElementById('discount_type').addEventListener('change', function() {
    const discountValueGroup = document.getElementById('discount_value_group');
    if (this.value) {
        discountValueGroup.style.display = 'block';
    } else {
        discountValueGroup.style.display = 'none';
    }
});

// Handle automation settings visibility and help text based on line item type
function updateAutomationDisplay() {
    const lineItemType = document.getElementById('line_item_type').value;
    const automationSettings = document.getElementById('automation-settings');
    const automationSelect = document.getElementById('non_guaranteed_automation');

    // Define guaranteed vs non-guaranteed types
    const guaranteedTypes = ['STANDARD', 'SPONSORSHIP'];
    const nonGuaranteedTypes = ['NETWORK', 'HOUSE', 'PRICE_PRIORITY'];

    if (guaranteedTypes.includes(lineItemType)) {
        // For guaranteed types, show but disable automation settings
        automationSettings.style.display = 'block';
        automationSelect.disabled = true;
        automationSelect.value = 'manual'; // Force manual for guaranteed

        // Update alert to show guaranteed behavior
        const alert = automationSettings.querySelector('.alert');
        alert.className = 'alert alert-warning';
        alert.innerHTML = `
            <strong>⚠️ Guaranteed Order Type Selected:</strong>
            <ul style="margin-bottom: 0; padding-left: 20px;">
                <li><strong>${lineItemType}</strong> orders are always manual activation regardless of automation setting</li>
                <li>This is a GAM requirement for guaranteed inventory types</li>
                <li>Publisher must manually review and activate these orders in GAM</li>
            </ul>
        `;
    } else if (nonGuaranteedTypes.includes(lineItemType)) {
        // For non-guaranteed types, show and enable automation settings
        automationSettings.style.display = 'block';
        automationSelect.disabled = false;

        // Restore normal alert
        const alert = automationSettings.querySelector('.alert');
        alert.className = 'alert alert-info';
        alert.innerHTML = `
            <strong>ℹ️ Non-Guaranteed Order Type Selected:</strong>
            <ul style="margin-bottom: 0; padding-left: 20px;">
                <li><strong>${lineItemType}</strong> orders can use automation for faster campaign launch</li>
                <li>Choose automation mode based on your operational preferences</li>
                <li>Automatic activation requires proper GAM credentials and permissions</li>
                <li>Test in development environment before using automatic mode</li>
            </ul>
        `;
    } else {
        // Unknown type, hide automation settings
        automationSettings.style.display = 'none';
    }

    // Update help text
    updateAutomationHelpText();
}

// Update automation help text based on selected mode
function updateAutomationHelpText() {
    const automationMode = document.getElementById('non_guaranteed_automation').value;

    // Hide all help divs
    document.getElementById('automation-help-manual').style.display = 'none';
    document.getElementById('automation-help-confirmation').style.display = 'none';
    document.getElementById('automation-help-automatic').style.display = 'none';

    // Show relevant help div
    const helpDiv = document.getElementById('automation-help-' + automationMode);
    if (helpDiv) {
        helpDiv.style.display = 'block';
    }
}

// Add event listeners for automation settings
document.getElementById('line_item_type').addEventListener('change', updateAutomationDisplay);
document.getElementById('non_guaranteed_automation').addEventListener('change', updateAutomationHelpText);

// Initialize automation display on page load
document.addEventListener('DOMContentLoaded', function() {
    updateAutomationDisplay();
    initializeInventoryPickers();
});

// ===== Inventory Picker Functions =====
let inventoryCache = {}; // Cache loaded inventory

function initializeInventoryPickers() {
    // Load existing selected ad units
    const existingAdUnits = document.getElementById('targeted_ad_unit_ids').value;
    if (existingAdUnits) {
        const ids = existingAdUnits.split('\n').filter(id => id.trim());
        ids.forEach(id => addSelectedItem('ad_unit', id, `Ad Unit ${id}`));
    }

    // Load existing selected placements
    const existingPlacements = document.getElementById('targeted_placement_ids').value;
    if (existingPlacements) {
        const ids = existingPlacements.split('\n').filter(id => id.trim());
        ids.forEach(id => addSelectedItem('placement', id, `Placement ${id}`));
    }

    // Setup search inputs
    let searchTimeout;
    document.getElementById('ad-unit-search').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchInventory('ad_unit', e.target.value), 300);
    });

    document.getElementById('placement-search').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchInventory('placement', e.target.value), 300);
    });
}

async function searchInventory(type, query) {
    const tenantId = '{{ tenant_id }}';
    const url = `{{ script_name }}/api/tenant/${tenantId}/inventory-list?type=${type}&search=${encodeURIComponent(query)}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch inventory');
        const data = await response.json();

        // Show results in a dropdown below the search input
        showSearchResults(type, data.items);
    } catch (error) {
        console.error('Error searching inventory:', error);
    }
}

function showSearchResults(type, items) {
    const searchInput = type === 'ad_unit' ? document.getElementById('ad-unit-search') : document.getElementById('placement-search');
    const containerId = type === 'ad_unit' ? 'ad-unit-results' : 'placement-results';

    // Remove existing results dropdown
    const existingDropdown = document.getElementById(containerId);
    if (existingDropdown) existingDropdown.remove();

    if (items.length === 0) return;

    // Create results dropdown
    const dropdown = document.createElement('div');
    dropdown.id = containerId;
    dropdown.style.cssText = 'position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: calc(100% - 140px);';

    items.forEach(item => {
        const resultItem = document.createElement('div');
        resultItem.style.cssText = 'padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;';
        resultItem.innerHTML = `
            <strong>${item.name}</strong>
            <div style="font-size: 0.85em; color: #666;">${(item.path || []).join(' > ')}</div>
        `;
        resultItem.addEventListener('mouseover', () => resultItem.style.background = '#f5f5f5');
        resultItem.addEventListener('mouseout', () => resultItem.style.background = 'white');
        resultItem.addEventListener('click', () => {
            addSelectedItem(type, item.id, item.name);
            searchInput.value = '';
            dropdown.remove();
        });
        dropdown.appendChild(resultItem);
    });

    searchInput.parentElement.style.position = 'relative';
    searchInput.parentElement.appendChild(dropdown);
}

function openInventoryPicker(type) {
    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';

    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;';

    modalContent.innerHTML = `
        <h3 style="margin-top: 0;">Select ${type === 'ad_unit' ? 'Ad Units' : 'Placements'}</h3>
        <input type="text" id="modal-search" placeholder="Search..." style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;">
        <div id="modal-results" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            <div style="text-align: center; color: #666;">Loading...</div>
        </div>
        <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
            <button type="button" onclick="closeInventoryModal()" class="btn btn-secondary">Close</button>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Load inventory
    loadInventoryForModal(type);

    // Setup search
    setTimeout(() => {
        document.getElementById('modal-search').addEventListener('input', (e) => {
            loadInventoryForModal(type, e.target.value);
        });
    }, 100);

    window.closeInventoryModal = () => modal.remove();
}

async function loadInventoryForModal(type, query = '') {
    const tenantId = '{{ tenant_id }}';
    const url = `{{ script_name }}/api/tenant/${tenantId}/inventory-list?type=${type}&search=${encodeURIComponent(query)}`;

    const resultsDiv = document.getElementById('modal-results');
    resultsDiv.innerHTML = '<div style="text-align: center; color: #666;">Loading...</div>';

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch inventory');
        const data = await response.json();

        if (data.items.length === 0) {
            resultsDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No inventory found. Try syncing your GAM inventory first.</div>';
            return;
        }

        resultsDiv.innerHTML = '';
        data.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.style.cssText = 'padding: 0.75rem; border-bottom: 1px solid #eee; cursor: pointer;';
            itemDiv.innerHTML = `
                <strong>${item.name}</strong>
                <div style="font-size: 0.85em; color: #666;">${(item.path || []).join(' > ')}</div>
                <div style="font-size: 0.8em; color: #999;">ID: ${item.id}</div>
            `;
            itemDiv.addEventListener('mouseover', () => itemDiv.style.background = '#f5f5f5');
            itemDiv.addEventListener('mouseout', () => itemDiv.style.background = 'white');
            itemDiv.addEventListener('click', () => {
                addSelectedItem(type, item.id, item.name);
                closeInventoryModal();
            });
            resultsDiv.appendChild(itemDiv);
        });

    } catch (error) {
        console.error('Error loading inventory:', error);
        resultsDiv.innerHTML = '<div style="text-align: center; color: #d32f2f; padding: 2rem;">Error loading inventory. Please try again.</div>';
    }
}

function addSelectedItem(type, id, name) {
    const containerId = type === 'ad_unit' ? 'selected-ad-units' : 'selected-placements';
    const textareaId = type === 'ad_unit' ? 'targeted_ad_unit_ids' : 'targeted_placement_ids';
    const container = document.getElementById(containerId);
    const textarea = document.getElementById(textareaId);

    // Check if already added
    const existing = container.querySelector(`[data-id="${id}"]`);
    if (existing) return;

    // Create badge
    const badge = document.createElement('span');
    badge.setAttribute('data-id', id);
    badge.style.cssText = 'display: inline-flex; align-items: center; gap: 0.5rem; background: #2196F3; color: white; padding: 0.25rem 0.75rem; border-radius: 16px; margin: 0.25rem; font-size: 0.9rem;';
    badge.innerHTML = `
        ${name}
        <button type="button" onclick="removeSelectedItem('${type}', '${id}')" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 1.2rem; line-height: 1;">×</button>
    `;
    container.appendChild(badge);

    // Update hidden textarea
    const currentIds = textarea.value.split('\n').filter(i => i.trim());
    if (!currentIds.includes(id)) {
        currentIds.push(id);
        textarea.value = currentIds.join('\n');
    }
}

function removeSelectedItem(type, id) {
    const containerId = type === 'ad_unit' ? 'selected-ad-units' : 'selected-placements';
    const textareaId = type === 'ad_unit' ? 'targeted_ad_unit_ids' : 'targeted_placement_ids';
    const container = document.getElementById(containerId);
    const textarea = document.getElementById(textareaId);

    // Remove badge
    const badge = container.querySelector(`[data-id="${id}"]`);
    if (badge) badge.remove();

    // Update hidden textarea
    const currentIds = textarea.value.split('\n').filter(i => i.trim() && i !== id);
    textarea.value = currentIds.join('\n');
}

async function syncInventory() {
    const btn = document.getElementById('syncBtn');
    const statusDiv = document.getElementById('syncStatus');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
    statusDiv.innerHTML = '<p style="color: #666;">Syncing inventory from GAM... This may take a minute.</p>';

    try {
        const response = await fetch('{{ script_name }}/api/tenant/{{ tenant_id }}/inventory/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Sync failed');
        }

        const data = await response.json();
        statusDiv.innerHTML = `<p style="color: #28a745;">✅ Sync completed! Found ${data.ad_units?.total || 0} ad units and ${data.placements?.total || 0} placements. Reloading page...</p>`;

        // Reload page after 2 seconds to update the UI
        setTimeout(() => {
            window.location.reload();
        }, 2000);

    } catch (error) {
        console.error('Sync error:', error);
        statusDiv.innerHTML = '<p style="color: #d32f2f;">❌ Sync failed. Please try again or contact support.</p>';
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Retry Sync';
    }
}
</script>
{% endblock %}
