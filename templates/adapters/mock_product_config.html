{% extends "base.html" %}

{% block title %}Mock Adapter Configuration - {{ product.name }}{% endblock %}

{% block content %}
<div class="card">
    <h2>Mock Adapter Configuration</h2>
    <p>Configure testing parameters for: <strong>{{ product.name }}</strong></p>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success">Configuration saved successfully!</div>
    {% endif %}

    <form method="POST" id="mockConfigForm">
        <h3 style="margin-top: 2rem;">Traffic Simulation</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="daily_impressions">Daily Impressions</label>
                <input type="number" id="daily_impressions" name="daily_impressions"
                       value="{{ config.get('daily_impressions', 100000) }}" min="1000" step="1000">
                <small style="color: #666;">Simulated daily impression volume</small>
            </div>

            <div class="form-group">
                <label for="fill_rate">Fill Rate (%)</label>
                <input type="number" id="fill_rate" name="fill_rate"
                       value="{{ config.get('fill_rate', 85) }}" min="0" max="100" step="1">
                <small style="color: #666;">Percentage of requests that will be filled</small>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="ctr">Click-Through Rate (%)</label>
                <input type="number" id="ctr" name="ctr"
                       value="{{ config.get('ctr', 0.5) }}" min="0" max="10" step="0.1">
                <small style="color: #666;">Simulated CTR for performance testing</small>
            </div>

            <div class="form-group">
                <label for="viewability_rate">Viewability Rate (%)</label>
                <input type="number" id="viewability_rate" name="viewability_rate"
                       value="{{ config.get('viewability_rate', 70) }}" min="0" max="100" step="1">
                <small style="color: #666;">Percentage of impressions marked as viewable</small>
            </div>
        </div>

        <h3 style="margin-top: 2rem;">Performance Simulation</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="latency_ms">API Latency (ms)</label>
                <input type="number" id="latency_ms" name="latency_ms"
                       value="{{ config.get('latency_ms', 50) }}" min="0" max="5000" step="10">
                <small style="color: #666;">Simulated API response time</small>
            </div>

            <div class="form-group">
                <label for="error_rate">Error Rate (%)</label>
                <input type="number" id="error_rate" name="error_rate"
                       value="{{ config.get('error_rate', 0.1) }}" min="0" max="50" step="0.1">
                <small style="color: #666;">Percentage of requests that will fail</small>
            </div>
        </div>

        <h3 style="margin-top: 2rem;">Test Scenarios</h3>

        <div class="form-group">
            <label for="test_mode">Test Mode</label>
            <select id="test_mode" name="test_mode">
                <option value="normal" {% if config.get('test_mode') == 'normal' %}selected{% endif %}>
                    Normal Operation
                </option>
                <option value="high_demand" {% if config.get('test_mode') == 'high_demand' %}selected{% endif %}>
                    High Demand (Low Fill)
                </option>
                <option value="degraded" {% if config.get('test_mode') == 'degraded' %}selected{% endif %}>
                    Degraded Performance
                </option>
                <option value="outage" {% if config.get('test_mode') == 'outage' %}selected{% endif %}>
                    Service Outage
                </option>
            </select>
            <small style="color: #666;">Simulate different operational scenarios</small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="price_variance">Price Variance (%)</label>
                <input type="number" id="price_variance" name="price_variance"
                       value="{{ config.get('price_variance', 10) }}" min="0" max="50" step="1">
                <small style="color: #666;">Random price variation for non-guaranteed inventory</small>
            </div>

            <div class="form-group">
                <label for="seasonal_factor">Seasonal Factor</label>
                <input type="number" id="seasonal_factor" name="seasonal_factor"
                       value="{{ config.get('seasonal_factor', 1.0) }}" min="0.1" max="5.0" step="0.1">
                <small style="color: #666;">Multiplier for seasonal demand simulation</small>
            </div>
        </div>

        <h3 style="margin-top: 2rem;">Delivery Simulation</h3>
        <div class="alert alert-info" style="background-color: #e3f2fd; border-left: 4px solid #2196F3; padding: 1rem; margin-bottom: 1rem;">
            <strong>üìä Real-Time Delivery Webhooks</strong><br>
            Enable accelerated campaign delivery simulation with automatic webhook notifications. Perfect for testing AI agent responses to delivery updates.
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="delivery_simulation_enabled"
                       {% if config.get('delivery_simulation', {}).get('enabled') %}checked{% endif %}>
                Enable Delivery Simulation
            </label>
            <small style="color: #666; display: block; margin-left: 1.5rem;">
                Automatically simulate campaign delivery with webhook notifications
            </small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="time_acceleration">Time Acceleration (seconds)</label>
                <select id="time_acceleration" name="time_acceleration">
                    <option value="60" {% if config.get('delivery_simulation', {}).get('time_acceleration') == 60 %}selected{% endif %}>
                        1 second = 1 minute
                    </option>
                    <option value="600" {% if config.get('delivery_simulation', {}).get('time_acceleration') == 600 %}selected{% endif %}>
                        1 second = 10 minutes
                    </option>
                    <option value="3600" {% if config.get('delivery_simulation', {}).get('time_acceleration', 3600) == 3600 %}selected{% endif %}>
                        1 second = 1 hour (default)
                    </option>
                    <option value="7200" {% if config.get('delivery_simulation', {}).get('time_acceleration') == 7200 %}selected{% endif %}>
                        1 second = 2 hours
                    </option>
                    <option value="14400" {% if config.get('delivery_simulation', {}).get('time_acceleration') == 14400 %}selected{% endif %}>
                        1 second = 4 hours
                    </option>
                    <option value="86400" {% if config.get('delivery_simulation', {}).get('time_acceleration') == 86400 %}selected{% endif %}>
                        1 second = 1 day
                    </option>
                </select>
                <small style="color: #666;">How fast to simulate campaign time</small>
            </div>

            <div class="form-group">
                <label for="update_interval_seconds">Update Interval (seconds)</label>
                <input type="number" id="update_interval_seconds" name="update_interval_seconds"
                       value="{{ config.get('delivery_simulation', {}).get('update_interval_seconds', 1.0) }}"
                       min="0.1" max="60" step="0.1">
                <small style="color: #666;">How often to fire webhooks (real-time seconds)</small>
            </div>
        </div>

        <div class="alert alert-info" style="background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 1rem; margin-top: 1rem;">
            <strong>Example:</strong> With time acceleration = 3600 and interval = 1.0:<br>
            ‚Ä¢ Every 1 second (real time) fires a webhook<br>
            ‚Ä¢ Each webhook represents 1 hour of campaign progress<br>
            ‚Ä¢ A 7-day campaign completes in 168 seconds (~2.8 minutes)
        </div>

        <h3 style="margin-top: 2rem;">Creative Formats</h3>
        <div class="alert" style="background: #e3f2fd; border-color: #90caf9; color: #1565c0; margin-bottom: 1rem;">
            <strong>‚ÑπÔ∏è Configure Creative Formats:</strong> Select the creative formats this product supports.
            Formats are fetched from the reference creative agent (https://creative.adcontextprotocol.org).
        </div>

        {% if formats %}
        <div style="margin-bottom: 1rem;">
            <input type="text" id="format-search" placeholder="Search formats by name, type, or size..."
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                   onkeyup="filterFormats()">
        </div>

        <div id="formats-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; max-height: 400px; overflow-y: auto; padding: 1rem; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
            {% for format in formats %}
            <label class="format-card"
                   data-format-id="{{ format.format_id }}"
                   data-search="{{ format.name|lower }} {{ format.type|lower }} {{ format.dimensions or '' }}"
                   style="border: 2px solid #ddd; border-radius: 4px; padding: 0.75rem; cursor: pointer; transition: all 0.2s; background: white;">
                <input type="checkbox" name="formats" value="{{ format.format_id }}"
                       {% if format.format_id in selected_formats %}checked{% endif %}
                       style="margin-right: 0.5rem;">
                <strong>{{ format.name }}</strong><br>
                <small style="color: #666;">
                    {{ format.type }}
                    {% if format.dimensions %} - {{ format.dimensions }}{% endif %}
                    {% if format.duration %} - {{ format.duration }}{% endif %}
                </small>
            </label>
            {% endfor %}
        </div>

        <div id="format-summary" style="padding: 0.75rem; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; margin-top: 1rem;">
            <strong style="color: #155724;">Selected:</strong>
            <span id="format-count" style="font-weight: 600;">{{ selected_formats|length }}</span> format(s)
        </div>
        {% else %}
        <div class="alert alert-warning" style="background: #fff3cd; border-color: #ffc107;">
            <strong>‚ö†Ô∏è No formats available:</strong> Could not fetch formats from creative agents.
            Please check your network connection or creative agent configuration.
        </div>
        {% endif %}

        <h3 style="margin-top: 2rem;">Debug Settings</h3>

        <div class="form-group">
            <label>
                <input type="checkbox" name="verbose_logging"
                       {% if config.get('verbose_logging') %}checked{% endif %}>
                Enable Verbose Logging
            </label>
            <small style="color: #666; display: block; margin-left: 1.5rem;">
                Log detailed mock adapter operations
            </small>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="predictable_ids"
                       {% if config.get('predictable_ids') %}checked{% endif %}>
                Use Predictable IDs
            </label>
            <small style="color: #666; display: block; margin-left: 1.5rem;">
                Generate deterministic IDs for easier testing
            </small>
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn">Save Configuration</button>
            <a href="{{ url_for('products.list_products', tenant_id=tenant_id) }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
document.getElementById('test_mode').addEventListener('change', function() {
    const mode = this.value;
    // Auto-adjust settings based on test mode
    if (mode === 'high_demand') {
        document.getElementById('fill_rate').value = 30;
        document.getElementById('error_rate').value = 0.5;
    } else if (mode === 'degraded') {
        document.getElementById('latency_ms').value = 500;
        document.getElementById('error_rate').value = 5;
    } else if (mode === 'outage') {
        document.getElementById('error_rate').value = 100;
    }
});

// Format search and filtering
function filterFormats() {
    const searchInput = document.getElementById('format-search');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const formatCards = document.querySelectorAll('.format-card');

    formatCards.forEach(card => {
        const searchData = card.getAttribute('data-search') || '';
        if (searchData.includes(searchTerm)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// Update format count on checkbox change
function updateFormatCount() {
    const checkedBoxes = document.querySelectorAll('input[name="formats"]:checked');
    const countElement = document.getElementById('format-count');
    if (countElement) {
        countElement.textContent = checkedBoxes.length;
    }
}

// Add event listeners for format checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const formatCheckboxes = document.querySelectorAll('input[name="formats"]');
    formatCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateFormatCount);

        // Visual feedback on selection
        checkbox.addEventListener('change', function() {
            const card = this.closest('.format-card');
            if (this.checked) {
                card.style.borderColor = '#28a745';
                card.style.backgroundColor = '#d4edda';
            } else {
                card.style.borderColor = '#ddd';
                card.style.backgroundColor = 'white';
            }
        });

        // Initialize visual state
        if (checkbox.checked) {
            const card = checkbox.closest('.format-card');
            card.style.borderColor = '#28a745';
            card.style.backgroundColor = '#d4edda';
        }
    });
});
</script>
{% endblock %}
