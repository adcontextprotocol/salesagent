{% extends "base.html" %}

{% block title %}{{ tenant.name }} - Settings{% endblock %}

{% block content %}
<style>
    .settings-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 2rem;
        min-height: 600px;
    }

    .settings-nav {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        margin-bottom: 0.25rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        color: #4b5563;
        text-decoration: none;
    }

    .settings-nav-item:hover {
        background: #f3f4f6;
        color: #111827;
    }

    .settings-nav-item.active {
        background: #eff6ff;
        color: #2563eb;
        font-weight: 600;
    }

    .settings-nav-icon {
        width: 20px;
        text-align: center;
    }

    .settings-nav-separator {
        height: 1px;
        background: #e5e7eb;
        margin: 1rem 0;
    }

    .settings-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .settings-section {
        display: none;
    }

    .settings-section.active {
        display: block;
    }

    .settings-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .settings-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }

    .settings-header p {
        margin: 0;
        color: #6b7280;
        font-size: 0.875rem;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    .checkbox-group label {
        margin: 0;
        font-size: 0.875rem;
        color: #374151;
    }

    .status-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .status-card.success {
        background: #f0fdf4;
        border-color: #86efac;
    }

    .status-card.warning {
        background: #fffbeb;
        border-color: #fde047;
    }

    .status-card.error {
        background: #fef2f2;
        border-color: #fca5a5;
    }

    .status-card.danger {
        background: #fef2f2;
        border: 2px solid #dc2626;
        border-left: 4px solid #dc2626;
    }

    .adapter-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .adapter-card {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .adapter-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .adapter-card.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .adapter-card.current {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .adapter-card.disabled {
        border-color: #d1d5db;
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .adapter-card.disabled:hover {
        border-color: #d1d5db;
        box-shadow: none;
    }

    .adapter-card .prerequisite-notice {
        font-size: 0.75rem;
        color: #ef4444;
        margin-top: 0.5rem;
        font-weight: 500;
    }

    .adapter-card h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .adapter-card p {
        margin: 0;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .adapter-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.125rem 0.5rem;
        background: #10b981;
        color: white;
        font-size: 0.625rem;
        font-weight: 600;
        border-radius: 4px;
        text-transform: uppercase;
    }

    .button-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e5e7eb;
    }

    .config-code {
        background: #1f2937;
        color: #f3f4f6;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.75rem;
        overflow-x: auto;
        position: relative;
    }

    .copy-button {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: #374151;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
    }

    .copy-button:hover {
        background: #4b5563;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid;
    }

    .alert-warning {
        background: #fffbeb;
        border-color: #fde047;
        color: #92400e;
    }

    .alert-info {
        background: #eff6ff;
        border-color: #93c5fd;
        color: #1e40af;
    }

    .stat-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .settings-layout {
            grid-template-columns: 1fr;
        }

        .settings-nav {
            position: static;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr !important;
        }
    }

    /* Virtual Host now uses simple text input - complex widget styling removed */
</style>

<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1 style="margin: 0; font-size: 1.875rem; font-weight: 700; color: #111827;">Settings</h1>
        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">
            Configure {{ tenant.name }}
        </p>
    </div>
    <a href="/tenant/{{ tenant.tenant_id }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
</div>

<div class="settings-layout">
    <!-- Settings Navigation -->
    <nav class="settings-nav">
        <a class="settings-nav-item active" data-section="account">
            <span class="settings-nav-icon">üè¢</span>
            <span>Account</span>
        </a>

        <a class="settings-nav-item" data-section="adserver">
            <span class="settings-nav-icon">üñ•Ô∏è</span>
            <span>Ad Server</span>
        </a>

        <a class="settings-nav-item" data-section="business-rules">
            <span class="settings-nav-icon">üìã</span>
            <span>Policies & Workflows</span>
        </a>

        <div class="settings-nav-separator"></div>

        <a class="settings-nav-item" data-section="inventory">
            <span class="settings-nav-icon">üìä</span>
            <span>Inventory</span>
        </a>

        <a class="settings-nav-item" data-section="products">
            <span class="settings-nav-icon">üì¶</span>
            <span>Products</span>
        </a>

        <a class="settings-nav-item" data-section="advertisers">
            <span class="settings-nav-icon">üë•</span>
            <span>Advertisers</span>
        </a>

        <div class="settings-nav-separator"></div>

        <a class="settings-nav-item" data-section="integrations">
            <span class="settings-nav-icon">üîó</span>
            <span>Integrations</span>
        </a>

        <a class="settings-nav-item" data-section="danger-zone">
            <span class="settings-nav-icon">‚ö†Ô∏è</span>
            <span>Danger Zone</span>
        </a>
    </nav>

    <!-- Settings Content -->
    <div class="settings-content">
        <!-- Account Settings (renamed from General) -->
        <div id="account" class="settings-section active">
            <div class="settings-header">
                <h2>Account</h2>
                <p>Organization identity and access control</p>
            </div>

            <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/general">
                <div class="form-section">
                    <h3>Organization Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tenant_name">Organization Name</label>
                            <input type="text" id="tenant_name" name="name" value="{{ tenant.name }}" required>
                        </div>

                        <div class="form-group">
                            <label for="subdomain">Subdomain</label>
                            <input type="text" id="subdomain" name="subdomain" value="{{ tenant.subdomain }}" readonly>
                            <small>Cannot be changed after creation</small>
                        </div>

                        <div class="form-group">
                            <label for="virtual_host">Virtual Host (Optional)</label>
                            <input type="text" id="virtual_host" name="virtual_host" value="{{ tenant.virtual_host or '' }}" placeholder="e.g. ad-sales.yourcompany.com">
                            <small>
                                <p><strong>To use a custom domain:</strong></p>
                                <ol style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.9em;">
                                    <li>Enter your custom domain above (e.g., ad-sales.yourcompany.com)</li>
                                    <li>Create a CNAME record pointing your domain to: <code>sales-agent.scope3.com</code></li>
                                    <li>Save your settings below</li>
                                    <li>Wait for DNS propagation (5-30 minutes)</li>
                                </ol>
                                <p style="margin-top: 0.5rem; color: #666; font-size: 0.85em;">
                                    üí° Your custom domain will route to this tenant's MCP server and admin interface.
                                </p>
                            </small>
                        </div>

                    </div>
                </div>

                <!-- Budget & Limits moved to Business Rules section -->
                <!-- Features moved to Business Rules section -->

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save Account Settings</button>
                    <button type="reset" class="btn btn-secondary">Reset</button>
                </div>
            </form>
        </div>

        <!-- Ad Server Settings -->
        <div id="adserver" class="settings-section">
            <div class="settings-header">
                <h2>Ad Server Configuration</h2>
                <p>Connect and configure your ad serving platform</p>
            </div>

            {% if active_adapter %}
            <div class="status-card success">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>‚úÖ Connected to {{ active_adapter|title|replace('_', ' ') }}</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            Last synced: {{ last_sync_time or 'Never' }}
                        </p>
                    </div>
                    {% if active_adapter == 'google_ad_manager' %}
                    <button onclick="syncGAMInventory()" class="btn btn-small btn-primary">
                        <span id="sync-icon">üîÑ</span> Sync Inventory
                    </button>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="status-card warning">
                <strong>‚ö†Ô∏è No Ad Server Connected</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Select an ad server below to get started
                </p>
            </div>
            {% endif %}

            <div class="form-section">
                <h3>Available Ad Servers</h3>
                <div class="adapter-cards">
                    <div class="adapter-card {% if active_adapter == 'mock' %}current{% endif %}"
                         onclick="selectAdapter('mock')">
                        {% if active_adapter == 'mock' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Mock (Testing)</h4>
                        <p>Perfect for development and testing. No external setup required.</p>
                    </div>

                    <div id="gam-adapter-card" class="adapter-card {% if active_adapter == 'google_ad_manager' %}current{% endif %}"
                         onclick="selectGAMAdapter()">
                        {% if active_adapter == 'google_ad_manager' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Google Ad Manager</h4>
                        <p>Enterprise ad serving platform from Google</p>
                        <div id="gam-prerequisite-notice" class="prerequisite-notice" style="display: none;">
                            OAuth setup required in super admin settings
                        </div>
                    </div>

                    <div class="adapter-card {% if active_adapter == 'kevel' %}current{% endif %}"
                         onclick="selectAdapter('kevel')">
                        {% if active_adapter == 'kevel' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Kevel</h4>
                        <p>API-first ad serving for developers</p>
                    </div>

                    <div class="adapter-card {% if active_adapter == 'triton' %}current{% endif %}"
                         onclick="selectAdapter('triton')">
                        {% if active_adapter == 'triton' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Triton Digital</h4>
                        <p>Audio and podcast advertising platform</p>
                    </div>
                </div>
            </div>

            <!-- Adapter-specific configuration will be loaded here -->
            <div id="adapter-config">
                {% if active_adapter == 'google_ad_manager' %}
                <div class="form-section" style="margin-top: 2rem;">
                    <h3>Google Ad Manager Configuration</h3>

                    <!-- OAuth Prerequisites Check -->
                    <div id="oauth-status" class="status-card" style="background: #f5f5f5; border-left: 4px solid #666; margin-bottom: 1rem;">
                        <h4>OAuth Setup Status</h4>
                        <p>Checking OAuth configuration...</p>
                    </div>

                    {% if adapter_config %}
                    <div class="status-card" style="background: #f0f9ff; border-left: 4px solid #0066cc;">
                        <h4>Current Configuration</h4>
                        <ul style="list-style: none; padding: 0; margin: 0.5rem 0;">
                            {% if adapter_config.get('network_code') %}
                            <li>‚úÖ Network Code: {{ adapter_config.get('network_code') }}</li>
                            {% else %}
                            <li>‚ùå Network Code: Not configured</li>
                            {% endif %}

                            {% if adapter_config.get('refresh_token') %}
                            <li>‚úÖ OAuth Refresh Token: Configured</li>
                            {% else %}
                            <li>‚ùå OAuth Refresh Token: Not configured</li>
                            {% endif %}

                            {% if adapter_config.get('application_name') %}
                            <li>‚úÖ Application Name: {{ adapter_config.get('application_name') }}</li>
                            {% else %}
                            <li>‚ÑπÔ∏è Application Name: Using default</li>
                            {% endif %}
                        </ul>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <strong>Not Configured</strong>
                        <p>Google Ad Manager adapter needs configuration. Please set up your GAM credentials below.</p>
                    </div>
                    {% endif %}

                    <div class="form-group" style="margin-top: 1rem;">
                        <label>OAuth Setup</label>
                        {% if adapter_config and adapter_config.get('refresh_token') %}
                        <div class="status-card success">
                            <strong>‚úÖ OAuth Token Configured</strong>
                            <p>Your refresh token is active and ready to use.</p>
                            <button onclick="startGAMOAuth()" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;">
                                Refresh OAuth Token
                            </button>
                        </div>
                        {% else %}
                        <div class="status-card warning">
                            <strong>OAuth Setup Required</strong>
                            <p>Click the button below to authorize AdCP access to your Google Ad Manager account.</p>
                            <button onclick="startGAMOAuth()" class="btn btn-primary" style="margin-top: 0.5rem;">
                                üîë Get OAuth Token
                            </button>
                        </div>
                        {% endif %}

                        <!-- Advanced option for manual token entry -->
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; color: #666; font-size: 0.9em;">Advanced: Manual Token Entry</summary>
                            <div style="margin-top: 0.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                <label for="gam_refresh_token">Manual OAuth Refresh Token</label>
                                <input type="text" id="gam_refresh_token" class="form-control"
                                       value="{{ adapter_config.get('refresh_token', '') if adapter_config else '' }}"
                                       placeholder="Paste your OAuth refresh token here">
                                <small class="form-text text-muted">For advanced users: manually enter a refresh token if you have one.</small>
                            </div>
                        </details>
                    </div>

                    <div class="form-group">
                        <label for="gam_network_code">Network Code</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="gam_network_code" class="form-control"
                                   value="{{ adapter_config.get('network_code', '') if adapter_config else '' }}"
                                   placeholder="Will be auto-detected" readonly>
                            <button onclick="detectGAMNetwork()" class="btn btn-secondary"
                                    id="detect-network-btn">Auto-detect Network</button>
                        </div>
                        <small class="form-text text-muted">Automatically retrieved from your GAM account</small>
                    </div>

                    <div class="form-group">
                        <label for="gam_trafficker_id">Trafficker User ID</label>
                        <input type="text" id="gam_trafficker_id" class="form-control"
                               value="{{ adapter_config.get('trafficker_id', '') if adapter_config else '' }}"
                               placeholder="Your GAM user ID (will be auto-detected)">
                        <small class="form-text text-muted">The GAM user ID who will create line items. Auto-detected when you click "Auto-detect Network" above.</small>
                    </div>

                    <div class="form-group" style="margin-top: 2rem;">
                        <button onclick="saveGAMConfig()" class="btn btn-primary">Save GAM Configuration</button>
                        {% if adapter_config and adapter_config.get('refresh_token') %}
                        <button onclick="testGAMConnection()" class="btn btn-secondary" style="margin-left: 0.5rem;">Test Connection</button>
                        {% endif %}
                    </div>
                </div>
                {% elif active_adapter == 'mock' %}
                <div class="form-section" style="margin-top: 2rem;">
                    <div class="alert alert-info">
                        <strong>Mock Adapter Active</strong>
                        <p>The mock adapter is configured and ready for testing. No additional setup required.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Policies & Workflows Section -->
        <div id="business-rules" class="settings-section">
            <div class="settings-header">
                <h2>Policies & Workflows</h2>
                <p>Configure how your organization operates: budgets, naming conventions, approval workflows</p>
            </div>

            <form id="business-rules-form">
                <!-- Budget Controls -->
                <div class="form-section">
                    <h3>Budget Controls</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="max_daily_budget">Maximum Daily Budget (USD)</label>
                            <input type="number" id="max_daily_budget" name="max_daily_budget"
                                   value="{{ tenant.max_daily_budget }}" min="0" step="100">
                            <small>Maximum daily spend limit across all campaigns</small>
                        </div>
                    </div>
                </div>

                <!-- Naming Conventions -->
                <div class="form-section">
                    <h3>Naming Conventions</h3>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Configure how orders and line items are named. <strong>Works across all ad servers</strong> (GAM, Mock, Kevel).
                    </p>

                    <!-- Adapter Support Indicator -->
                    <div class="alert alert-info" style="font-size: 0.875rem; padding: 0.75rem; margin-bottom: 1.5rem; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;">
                        <strong>Adapter Support:</strong>
                        ‚úÖ Google Ad Manager &nbsp;&nbsp;
                        ‚úÖ Mock Adapter &nbsp;&nbsp;
                        ‚è≥ Kevel (coming soon)
                    </div>

                    <!-- Quick Start Presets -->
                    <div class="form-group">
                        <label>Quick Start Templates</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useNamingPreset('simple')">
                                üìä Simple
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useNamingPreset('campaign')">
                                üéØ Campaign-First
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useNamingPreset('detailed')">
                                üìÖ Detailed
                            </button>
                        </div>
                    </div>

                    <!-- Order Name Template -->
                    <div class="form-group">
                        <label for="order_name_template">Order Name Template</label>
                        <input type="text" id="order_name_template" name="order_name_template"
                               value="{{ tenant.order_name_template or '{campaign_name|promoted_offering} - {date_range}' }}"
                               placeholder="{campaign_name|promoted_offering} - {date_range}"
                               oninput="updateNamingPreview()">
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #666; font-size: 0.875rem;">Show available variables</summary>
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.875rem;">
                                <strong>Available variables:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li><code>{campaign_name}</code> - Campaign name (optional - may be empty)</li>
                                    <li><code>{promoted_offering}</code> - What's being advertised (always present)</li>
                                    <li><code>{buyer_ref}</code> - Buyer's internal reference (optional)</li>
                                    <li><code>{date_range}</code> - Flight dates (e.g., "Oct 7-14, 2025")</li>
                                    <li><code>{month_year}</code> - Month and year (e.g., "Oct 2025")</li>
                                    <li><code>{package_count}</code> - Number of packages in order</li>
                                </ul>
                                <strong>Fallback syntax:</strong> <code>{var1|var2}</code> uses var1 if present, otherwise var2
                                <br><strong>Example:</strong> <code>{campaign_name|promoted_offering}</code> tries campaign_name first, falls back to promoted_offering
                            </div>
                        </details>
                    </div>

                    <!-- Line Item Name Template -->
                    <div class="form-group">
                        <label for="line_item_name_template">Line Item Name Template</label>
                        <input type="text" id="line_item_name_template" name="line_item_name_template"
                               value="{{ tenant.line_item_name_template or '{order_name} - {product_name}' }}"
                               placeholder="{order_name} - {product_name}"
                               oninput="updateNamingPreview()">
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #666; font-size: 0.875rem;">Show available variables</summary>
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.875rem;">
                                <strong>Available variables:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li><code>{product_name}</code> - Product/inventory name (e.g., "Display 300x250")</li>
                                    <li><code>{order_name}</code> - Parent order name (provides campaign context)</li>
                                    <li><code>{package_index}</code> - Package position number (1, 2, 3...)</li>
                                </ul>
                                <strong>Tip:</strong> Including <code>{order_name}</code> helps identify campaigns in line-item reports
                            </div>
                        </details>
                    </div>

                    <!-- Live Preview -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>Preview with Sample Data</label>
                        <div id="naming-preview" style="padding: 1rem; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px;">
                            <div style="margin-bottom: 0.75rem;">
                                <strong style="color: #1e40af;">Order Name:</strong>
                                <div id="order-preview" style="padding: 0.5rem; background: white; border-radius: 4px; margin-top: 0.25rem; font-family: monospace; color: #059669;">
                                    Nike Shoes Q1 - Oct 7-14, 2025
                                </div>
                            </div>
                            <div>
                                <strong style="color: #1e40af;">Line Item Names:</strong>
                                <div id="lineitem-preview" style="padding: 0.5rem; background: white; border-radius: 4px; margin-top: 0.25rem; font-family: monospace; color: #059669;">
                                    1. Nike Shoes Q1 - Oct 7-14, 2025 - Display 300x250<br>
                                    2. Nike Shoes Q1 - Oct 7-14, 2025 - Video Pre-roll<br>
                                    3. Nike Shoes Q1 - Oct 7-14, 2025 - Native Article
                                </div>
                            </div>
                            <div id="validation-messages" style="margin-top: 0.75rem; font-size: 0.875rem;">
                                <!-- Validation messages will appear here -->
                            </div>
                            <small style="color: #64748b; display: block; margin-top: 0.5rem;">
                                Using sample: campaign_name=null, promoted_offering="Nike Shoes Q1", dates=Oct 7-14, 2025, 3 products
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Approval Workflow -->
                <div class="form-section">
                    <h3>Approval Workflow</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="human_review_required" name="human_review_required"
                               {% if tenant.human_review_required %}checked{% endif %}>
                        <label for="human_review_required">Require manual approval for order activation</label>
                        <small>Orders will be created in draft state and require human approval before activation</small>
                    </div>
                </div>

                <!-- Creative Review -->
                <div class="form-section">
                    <h3>Creative Review</h3>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Configure how uploaded creatives are reviewed and approved
                    </p>

                    <div class="form-group">
                        <label for="approval_mode">Creative Approval Mode</label>
                        <select id="approval_mode" name="approval_mode" class="form-control" onchange="updateApprovalModeUI()">
                            <option value="auto-approve" {% if tenant.approval_mode == 'auto-approve' %}selected{% endif %}>
                                ‚úÖ Auto-approve all creatives
                            </option>
                            <option value="require-human" {% if tenant.approval_mode == 'require-human' or not tenant.approval_mode %}selected{% endif %}>
                                üë§ Require human approval
                            </option>
                            <option value="ai-powered" {% if tenant.approval_mode == 'ai-powered' %}selected{% endif %}>
                                ü§ñ AI-powered review
                            </option>
                        </select>
                        <small>Choose how creatives are handled when uploaded</small>
                    </div>

                    <!-- Mode Descriptions -->
                    <div id="mode-description" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2563eb;">
                        <div id="desc-auto-approve" style="display: none;">
                            <strong>‚úÖ Auto-approve Mode:</strong>
                            <p style="margin: 0.5rem 0 0 0;">All uploaded creatives are immediately approved and ready to use.</p>
                        </div>
                        <div id="desc-require-human" style="display: none;">
                            <strong>üë§ Human Review Mode:</strong>
                            <p style="margin: 0.5rem 0 0 0;">All creatives remain pending until manually reviewed and approved by a human.</p>
                        </div>
                        <div id="desc-ai-powered" style="display: none;">
                            <strong>ü§ñ AI-Powered Mode:</strong>
                            <p style="margin: 0.5rem 0 0 0;">Creatives are automatically reviewed by AI based on your criteria below.</p>
                        </div>
                    </div>

                    <!-- AI Configuration (shown only for ai-powered mode) -->
                    <div id="ai-config-section" style="display: none; margin-top: 1rem;">
                        {% if not has_gemini_key %}
                        <div class="alert alert-warning" style="padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; margin-bottom: 1rem;">
                            <strong>‚ö†Ô∏è Gemini API Key Required</strong>
                            <p style="margin: 0.5rem 0 0;">AI review requires a Gemini API key. Please set your key in <a href="#" onclick="event.preventDefault(); switchSettingsSection('integrations')">Integrations ‚Üí AI Services</a>.</p>
                        </div>
                        {% else %}
                        <div class="alert alert-success" style="padding: 0.75rem; background: #d1fae5; border: 1px solid #34d399; border-radius: 6px; margin-bottom: 1rem;">
                            <strong>‚úÖ Gemini API Key Configured</strong>
                            <p style="margin: 0.5rem 0 0; font-size: 0.875rem; color: #059669;">AI-powered creative review is enabled.</p>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="creative_review_criteria">AI Review Criteria</label>
                            <textarea id="creative_review_criteria" name="creative_review_criteria" class="form-control" rows="6"
                                      placeholder="Enter your creative review criteria..."
                                      style="font-family: monospace; font-size: 0.875rem;">{{ tenant.creative_review_criteria or '' }}</textarea>
                            <small>Define when to <strong>approve</strong>, <strong>require human approval</strong>, or <strong>reject</strong> creatives. The AI will use these criteria to make three-state decisions.</small>
                        </div>

                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #2563eb; font-weight: 500; font-size: 0.875rem;">üìù Show Example Criteria</summary>
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; font-size: 0.875rem;">
                                <strong>Example 1: Simple Three-State Review</strong>
                                <pre style="background: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; white-space: pre-wrap;">APPROVE if:
‚úì Creative clearly matches promoted offering
‚úì Professional quality (clear, readable)
‚úì Appropriate for general audiences

REQUIRE HUMAN APPROVAL if:
‚ö†Ô∏è Unsure about promoted offering match
‚ö†Ô∏è Borderline quality or unclear messaging
‚ö†Ô∏è Contains sensitive content that may need review
‚ö†Ô∏è Novel or unusual creative approach

REJECT if:
‚úó Wrong product/service advertised
‚úó Poor quality or unprofessional
‚úó Inappropriate or offensive content
‚úó Misleading claims</pre>

                                <strong>Example 2: Brand Safety Focus</strong>
                                <pre style="background: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; white-space: pre-wrap;">APPROVE if all conditions met:
- Clearly promotes the advertised product
- No offensive, violent, or inappropriate content
- No false or misleading claims
- Professional image quality

REQUIRE HUMAN APPROVAL if:
- Contains claims that need fact-checking
- Uses controversial themes or messaging
- Quality is acceptable but not ideal
- Uncertain about brand guideline compliance

REJECT if any condition met:
- Violates advertising standards
- Contains competitor branding
- Promotes wrong or unrelated products
- Unprofessional or low quality</pre>

                                <strong>Example 3: Detailed Guidelines</strong>
                                <pre style="background: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; white-space: pre-wrap;">Review each creative and respond with one of three actions:

APPROVE - Creative is ready to go live:
‚úì Promoted offering matches creative content
‚úì Professional quality (clear images, readable text)
‚úì Appropriate for all audiences
‚úì No misleading claims or fine print issues
‚úì Brand/product clearly visible
‚úì Meets industry advertising standards

REQUIRE HUMAN APPROVAL - Needs manual review:
‚ö†Ô∏è Uncertain about promoted offering alignment
‚ö†Ô∏è Questionable claims that may need verification
‚ö†Ô∏è Sensitive topics or mature themes
‚ö†Ô∏è Unusual format or creative approach
‚ö†Ô∏è Borderline quality or professionalism
‚ö†Ô∏è Potential legal or compliance concerns

REJECT - Creative cannot be approved:
‚úó Wrong product/service advertised
‚úó Poor quality or unprofessional appearance
‚úó Inappropriate, offensive, or explicit content
‚úó Misleading, deceptive, or false claims
‚úó Violates advertising regulations
‚úó Contains competitor branding or logos</pre>
                            </div>
                        </details>

                        <!-- AI Policy Configuration -->
                        <div class="form-group" style="margin-top: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: #111827;">AI Confidence Thresholds</h4>
                            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                                Configure how confident the AI must be before automatically approving or rejecting creatives.
                                Lower confidence decisions will require human review.
                            </p>

                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label for="auto_approve_threshold">
                                        Auto-Approve Threshold
                                        <span style="color: #10b981; font-weight: 600; margin-left: 0.5rem;" id="approve_threshold_value">90%</span>
                                    </label>
                                    <input type="range" id="auto_approve_threshold" name="auto_approve_threshold"
                                           min="0.5" max="1.0" step="0.05"
                                           value="{{ (tenant.ai_policy.auto_approve_threshold if tenant.ai_policy else 0.90) }}"
                                           class="form-control" style="margin-bottom: 0.5rem;"
                                           oninput="document.getElementById('approve_threshold_value').textContent = Math.round(this.value * 100) + '%'">
                                    <small>AI must be at least this confident to auto-approve (default: 90%)</small>
                                </div>

                                <div class="form-group" style="margin-top: 1rem;">
                                    <label for="auto_reject_threshold">
                                        Auto-Reject Threshold
                                        <span style="color: #ef4444; font-weight: 600; margin-left: 0.5rem;" id="reject_threshold_value">10%</span>
                                    </label>
                                    <input type="range" id="auto_reject_threshold" name="auto_reject_threshold"
                                           min="0.0" max="0.5" step="0.05"
                                           value="{{ (tenant.ai_policy.auto_reject_threshold if tenant.ai_policy else 0.10) }}"
                                           class="form-control" style="margin-bottom: 0.5rem;"
                                           oninput="document.getElementById('reject_threshold_value').textContent = Math.round(this.value * 100) + '%'">
                                    <small>AI must be this certain or less to auto-reject (default: 10%)</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="sensitive_categories">Always Require Human Review For</label>
                                <input type="text" id="sensitive_categories" name="sensitive_categories"
                                       value="{{ (tenant.ai_policy.always_require_human_for|join(', ') if tenant.ai_policy and tenant.ai_policy.always_require_human_for else 'political, healthcare, financial') }}"
                                       class="form-control"
                                       placeholder="political, healthcare, financial">
                                <small>Categories that always require human review, regardless of AI confidence (comma-separated)</small>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="learn_from_overrides" name="learn_from_overrides"
                                           {% if not tenant.ai_policy or tenant.ai_policy.learn_from_overrides != False %}checked{% endif %}>
                                    Track when humans disagree with AI decisions
                                </label>
                                <small style="display: block; margin-top: 0.25rem;">
                                    Enable learning from human overrides to improve AI accuracy over time
                                </small>
                            </div>

                            <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #2563eb; margin-top: 1rem;">
                                <strong>How It Works:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem;">
                                    <li><strong>High Confidence (‚â•90%):</strong> AI approvals/rejections are automatic</li>
                                    <li><strong>Medium Confidence (10%-90%):</strong> Sent to human review queue with AI recommendation</li>
                                    <li><strong>Sensitive Categories:</strong> Always require human review, regardless of confidence</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" onclick="saveBusinessRules()" class="btn btn-primary">
                        Save Business Rules
                    </button>
                    <button type="reset" class="btn btn-secondary">Reset</button>
                </div>
            </form>
        </div>
        <!-- Inventory Settings -->
        <div id="inventory" class="settings-section">
            <div class="settings-header">
                <h2>Inventory Management</h2>
                <p>Sync and manage ad units, placements, and targeting options from your ad server</p>
            </div>

            {% if active_adapter == 'google_ad_manager' %}
            <div class="form-section">
                <h3>Inventory Sync Status</h3>

                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value">{{ inventory_count|default(0) }}</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ ad_units_count|default(0) }}</div>
                        <div class="stat-label">Ad Units</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ placements_count|default(0) }}</div>
                        <div class="stat-label">Placements</div>
                    </div>
                </div>

                <div class="status-card {% if last_sync_time %}success{% else %}warning{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{% if last_sync_time %}Last synced: {{ last_sync_time }}{% else %}No sync performed yet{% endif %}</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                Syncing imports ad units, placements, and targeting options from Google Ad Manager.
                            </p>
                        </div>
                        <button onclick="syncGAMInventory()" class="btn btn-primary" style="white-space: nowrap;">
                            <span id="sync-icon">üîÑ</span> Sync Now
                        </button>
                    </div>
                </div>

                <div class="form-section" style="margin-top: 1.5rem;">
                    <h3>Actions</h3>
                    <div style="display: flex; gap: 1rem;">
                        <a href="/admin/tenant/{{ tenant_id }}/inventory?type=all" class="btn btn-secondary">
                            üìä Browse Inventory
                        </a>
                        <a href="/admin/tenant/{{ tenant_id }}/targeting" class="btn btn-secondary">
                            üéØ Browse Targeting
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <strong>Ad Server Required</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                    Connect to Google Ad Manager in the Ad Server settings to enable inventory sync.
                </p>
                <a href="#" onclick="event.preventDefault(); switchSettingsSection('adserver')" class="btn btn-primary" style="margin-top: 1rem;">
                    Configure Ad Server
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Products Settings -->
        <div id="products" class="settings-section">
            <div class="settings-header">
                <h2>Product Management</h2>
                <p>Define advertising products available for purchase</p>
            </div>

            {% if product_count == 0 %}
            <!-- Show wizard prominently for new tenants -->
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-info-circle" style="font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                        <strong>No Products Configured Yet</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                            Create your first advertising product to start offering inventory to buyers.
                        </p>
                    </div>
                    <a href="/tenant/{{ tenant.tenant_id }}/products/add" class="btn btn-success">
                        <i class="fas fa-plus"></i> Create Product
                    </a>
                </div>
            </div>
            {% endif %}

            <div class="status-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ product_count }} Products Configured</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            {{ active_products }} active, {{ draft_products }} draft
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="/tenant/{{ tenant.tenant_id }}/products" class="btn btn-small">Manage</a>
                        <a href="/tenant/{{ tenant.tenant_id }}/products/add" class="btn btn-primary btn-small">Add New</a>
                    </div>
                </div>
            </div>

        </div>

        <!-- Creative Formats Settings -->
        <div id="creatives" class="settings-section">
            <div class="settings-header">
                <h2>Creative Formats</h2>
                <p>Manage accepted creative formats and auto-approval rules</p>
            </div>

            <div class="form-section">
                <h3>Auto-Approval Settings</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Select formats that can be automatically approved without human review
                </p>

                <div class="form-grid">
                    {% for format in creative_formats %}
                    <div class="checkbox-group">
                        <input type="checkbox" id="format_{{ format.id }}" name="auto_approve_{{ format.id }}"
                               {% if format.auto_approve %}checked{% endif %}>
                        <label for="format_{{ format.id }}">{{ format.name }} ({{ format.dimensions }})</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="button-group">
                <a href="/tenant/{{ tenant.tenant_id }}/creative-formats" class="btn btn-primary">
                    Manage Creative Formats
                </a>
            </div>
        </div>

        <!-- Advertisers Settings -->
        <div id="advertisers" class="settings-section">
            <div class="settings-header">
                <h2>Advertiser Management</h2>
                <p>Manage advertisers who can access your inventory</p>
            </div>

            <div class="status-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ advertiser_count }} Advertisers Registered</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            {{ active_advertisers }} active this month
                        </p>
                    </div>
                    <a href="/tenant/{{ tenant.tenant_id }}/principals/create" class="btn btn-primary btn-small">
                        Add Advertiser
                    </a>
                </div>
            </div>

            <!-- Advertisers List -->
            {% if principals %}
            <div class="card" style="margin-top: 1rem;">
                <div class="card-body">
                    <h5 class="card-title">Current Advertisers</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Principal ID</th>
                                    <th>Platform Mappings</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for principal in principals %}
                                <tr>
                                    <td><strong>{{ principal.name }}</strong></td>
                                    <td><code>{{ principal.principal_id }}</code></td>
                                    <td>
                                        {% if principal.platform_mappings %}
                                            {% set mappings = principal.platform_mappings | from_json %}
                                            {% for platform, config in mappings.items() %}
                                                {% if platform == 'gam_advertiser_id' %}
                                                    <small class="badge bg-primary me-1" title="Google Ad Manager Advertiser ID">GAM: {{ config }}</small>
                                                {% elif platform == 'google_ad_manager' %}
                                                    {% if config is mapping and (config.advertiser_id or config.company_id) %}
                                                        <small class="badge bg-primary me-1" title="Google Ad Manager Advertiser">GAM: {{ config.advertiser_id or config.company_id }}</small>
                                                    {% else %}
                                                        <small class="badge bg-primary me-1" title="Google Ad Manager (not configured)">GAM: Not configured</small>
                                                    {% endif %}
                                                {% elif platform == 'mock' %}
                                                    {% if config is mapping and config.advertiser_id %}
                                                        <small class="badge bg-secondary me-1" title="Mock Adapter">Mock: {{ config.advertiser_id }}</small>
                                                    {% else %}
                                                        <small class="badge bg-secondary me-1" title="Mock Adapter">Mock</small>
                                                    {% endif %}
                                                {% else %}
                                                    <small class="badge bg-info me-1" title="{{ platform }}">{{ platform }}: {{ config if config is string else config|first if config is iterable else config }}</small>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                        <small class="text-muted">None</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if principal.created_at %}
                                            {{ principal.created_at.strftime('%Y-%m-%d') }}
                                            {% else %}
                                            Unknown
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm"
                                                    onclick="copyA2AConfig('{{ principal.principal_id }}', '{{ principal.name }}', '{{ principal.access_token }}')"
                                                    title="Copy A2A Configuration">
                                                üìã A2A
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm"
                                                    onclick="editPrincipalMappings('{{ principal.principal_id }}', '{{ principal.name }}')"
                                                    title="Edit Platform Mappings">
                                                ‚úèÔ∏è Edit
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm"
                                                    onclick="deletePrincipal('{{ principal.principal_id }}', '{{ principal.name }}')"
                                                    title="Delete Advertiser">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card" style="margin-top: 1rem;">
                <div class="card-body text-center text-muted">
                    <p>No advertisers registered yet.</p>
                    <a href="/tenant/{{ tenant.tenant_id }}/principals/create" class="btn btn-primary">
                        Create First Advertiser
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Integrations Settings -->
        <div id="integrations" class="settings-section">
            <div class="settings-header">
                <h2>Integrations</h2>
                <p>Connect external services and configure webhooks</p>
            </div>

            <div class="form-section">
                <h3>Slack Integration</h3>
                <p class="form-section-description">
                    Receive real-time notifications for creative approvals, tasks, and audit logs in your Slack workspace.
                </p>

                <details style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <summary style="cursor: pointer; font-weight: 500; color: #374151;">
                        üìñ How to set up a Slack webhook
                    </summary>
                    <div style="margin-top: 1rem; padding-left: 0.5rem;">
                        <ol style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>Go to <a href="https://api.slack.com/apps" target="_blank" rel="noopener">api.slack.com/apps</a> and create a new app (or select an existing one)</li>
                            <li>Click on <strong>Incoming Webhooks</strong> in the left sidebar</li>
                            <li>Toggle <strong>Activate Incoming Webhooks</strong> to On</li>
                            <li>Click <strong>Add New Webhook to Workspace</strong></li>
                            <li>Select the channel where you want notifications</li>
                            <li>Copy the webhook URL (starts with <code>https://hooks.slack.com/services/...</code>)</li>
                            <li>Paste it into the fields below</li>
                        </ol>
                        <img src="/static/images/slack-webhook-setup.png" alt="Slack Incoming Webhooks setup page" style="max-width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; margin-top: 1rem;">
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;">
                            üí° <strong>Tip:</strong> You can use the same webhook for both notifications and audit logs, or create separate webhooks for different channels.
                        </p>
                    </div>
                </details>

                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/slack">
                    <div class="form-group">
                        <label for="slack_webhook_url">Task Notifications Webhook URL</label>
                        <input type="url" id="slack_webhook_url" name="slack_webhook_url"
                               value="{{ tenant.slack_webhook_url or '' }}"
                               placeholder="https://hooks.slack.com/services/YOUR/WEBHOOK/URL">
                        <small>Receives notifications for new tasks and creative approvals</small>
                    </div>

                    <div class="form-group">
                        <label for="slack_audit_webhook_url">Audit Log Webhook URL (Optional)</label>
                        <input type="url" id="slack_audit_webhook_url" name="slack_audit_webhook_url"
                               value="{{ tenant.slack_audit_webhook_url or '' }}"
                               placeholder="https://hooks.slack.com/services/YOUR/AUDIT/WEBHOOK">
                        <small>Separate channel for audit logs and security alerts</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Slack Settings</button>
                        <button type="button" onclick="testSlack()" class="btn btn-secondary">Test Connection</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>AI Services</h3>
                <p class="form-section-description">
                    Configure AI-powered features like creative review. Each tenant must provide their own API keys.
                </p>

                {% if not tenant.gemini_api_key %}
                <div class="alert alert-warning" style="padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; margin-bottom: 1rem;">
                    <strong>‚ö†Ô∏è Gemini API Key Required</strong>
                    <p style="margin: 0.5rem 0 0;">AI-powered creative review is not available without a Gemini API key. Please add your key below.</p>
                </div>
                {% else %}
                <div class="alert alert-success" style="padding: 0.75rem; background: #d1fae5; border: 1px solid #34d399; border-radius: 6px; margin-bottom: 1rem;">
                    <strong>‚úÖ Gemini API Key Configured</strong>
                    <p style="margin: 0.5rem 0 0;">AI-powered creative review is enabled.</p>
                </div>
                {% endif %}

                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/ai">
                    <div class="form-group">
                        <label for="gemini_api_key">Gemini API Key <span style="color: #ef4444;">*</span></label>
                        <input type="password" id="gemini_api_key" name="gemini_api_key"
                               value="{{ tenant.gemini_api_key or '' }}"
                               placeholder="Enter your Gemini API key"
                               required>
                        <small>
                            Required for AI-powered creative review. Each tenant provides their own key for usage tracking and billing.
                            <a href="https://aistudio.google.com/app/apikey" target="_blank">Get an API key from Google AI Studio</a>
                        </small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save AI Settings</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>AdCP Signals Discovery</h3>
                <p class="form-section-description">
                    Connect an upstream AdCP signals discovery agent to enhance product recommendations with intelligent signal-based targeting.
                </p>

                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/signals">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="signals_enabled" name="signals_enabled"
                                   {% if tenant.signals_agent_config and tenant.signals_agent_config.enabled %}checked{% endif %}>
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-text">Enable Signals Discovery</span>
                        </label>
                        <small>When enabled, the sales agent will query the upstream signals agent for intelligent product customization</small>
                    </div>

                    <div id="signals-config" class="signals-config-section"
                         style="{% if not (tenant.signals_agent_config and tenant.signals_agent_config.enabled) %}display: none;{% endif %}">

                        <div class="form-group">
                            <label for="signals_upstream_url">Upstream Signals Agent URL</label>
                            <input type="url" id="signals_upstream_url" name="signals_upstream_url"
                                   value="{{ (tenant.signals_agent_config.upstream_url if tenant.signals_agent_config else '') or '' }}"
                                   placeholder="http://signals-agent:8080/mcp/"
                                   required>
                            <small>The MCP endpoint URL of your AdCP signals discovery agent</small>
                        </div>

                        <div class="form-group">
                            <label for="signals_auth_token">Authentication Token</label>
                            <input type="text" id="signals_auth_token" name="signals_auth_token"
                                   value="{{ (tenant.signals_agent_config.upstream_token if tenant.signals_agent_config else '') or '' }}"
                                   placeholder="your-signals-agent-token">
                            <small>Token for authenticating with the signals discovery agent (optional)</small>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="signals_auth_header">Auth Header Name</label>
                                <input type="text" id="signals_auth_header" name="signals_auth_header"
                                       value="{{ (tenant.signals_agent_config.auth_header if tenant.signals_agent_config else '') or 'x-adcp-auth' }}"
                                       placeholder="x-adcp-auth">
                                <small>HTTP header name for token authentication</small>
                            </div>

                            <div class="form-group">
                                <label for="signals_timeout">Timeout (seconds)</label>
                                <input type="number" id="signals_timeout" name="signals_timeout"
                                       value="{{ (tenant.signals_agent_config.timeout if tenant.signals_agent_config else '') or '30' }}"
                                       min="5" max="120" placeholder="30">
                                <small>Request timeout for signals discovery calls</small>
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="signals_forward_offering" name="signals_forward_offering"
                                       {% if not tenant.signals_agent_config or tenant.signals_agent_config.forward_promoted_offering != False %}checked{% endif %}>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Forward Promoted Offering</span>
                            </label>
                            <small>Include the promoted offering in signals discovery requests</small>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="signals_fallback" name="signals_fallback"
                                       {% if not tenant.signals_agent_config or tenant.signals_agent_config.fallback_to_database != False %}checked{% endif %}>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Fallback to Database Products</span>
                            </label>
                            <small>Use database products if signals discovery fails or returns no results</small>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Signals Settings</button>
                        <button type="button" onclick="testSignalsConnection()" class="btn btn-secondary">Test Connection</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- API Settings -->
        <div id="api" class="settings-section">
            <div class="settings-header">
                <h2>API & Tokens</h2>
                <p>Manage API access and authentication tokens</p>
            </div>

            <div class="form-section">
                <h3>MCP Server Endpoint</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">{% if tenant.virtual_host %}https://{{ tenant.virtual_host }}/mcp/{% elif is_production %}https://{{ tenant.subdomain }}.sales-agent.scope3.com/mcp/{% else %}http://localhost:{{ mcp_port }}/mcp/{% endif %}</pre>
                </div>
            </div>

            <div class="form-section">
                <h3>Python Client Example</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">from fastmcp.client import Client
from fastmcp.client.transports import StreamableHttpTransport

headers = {
    "x-adcp-auth": "YOUR_ACCESS_TOKEN",
    "x-adcp-tenant": "{{ tenant.subdomain }}"
}
transport = StreamableHttpTransport(
    url="{% if tenant.virtual_host %}https://{{ tenant.virtual_host }}/mcp/{% elif is_production %}https://{{ tenant.subdomain }}.sales-agent.scope3.com/mcp/{% else %}http://localhost:{{ mcp_port }}/mcp/{% endif %}",
    headers=headers
)
client = Client(transport=transport)

# Discover products
result = await client.tools.get_products(brief="video ads")</pre>
                </div>
            </div>

            <div class="form-section">
                <h3>Active Tokens</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Each advertiser has their own API token
                </p>
                <!-- Token list would go here -->
            </div>
        </div>

        <!-- Users Settings -->
        <div id="users" class="settings-section">
            <div class="settings-header">
                <h2>Users & Access</h2>
                <p>Manage who can access this tenant's admin interface</p>
            </div>

            <!-- Authorized Domains Section -->
            <div class="form-section">
                <h3>üè¢ Authorized Domains</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                    Users from these domains get automatic admin access via OAuth
                </p>

                <!-- Current Domains -->
                {% if authorized_domains %}
                <div class="domain-list" style="margin-bottom: 1rem;">
                    {% for domain in authorized_domains %}
                    <div class="domain-item" style="display: flex; align-items: center; justify-content: between; padding: 0.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>{{ domain }}</strong>
                            <small style="color: #6b7280; margin-left: 0.5rem;">@{{ domain }} users</small>
                        </div>
                        <form method="POST" action="{{ url_for('settings.remove_authorized_domain', tenant_id=tenant.tenant_id) }}" style="margin: 0;">
                            <input type="hidden" name="domain" value="{{ domain }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                    onclick="return confirm('Remove domain {{ domain }}? Users from this domain will lose access.')">Remove</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; color: #9ca3af; font-style: italic; margin-bottom: 1rem;">
                    No authorized domains configured
                </div>
                {% endif %}

                <!-- Add Domain Form -->
                <form method="POST" action="{{ url_for('settings.add_authorized_domain', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label for="new_domain" style="font-size: 0.875rem; font-weight: 500;">Add Domain</label>
                        <input type="text" id="new_domain" name="domain" placeholder="company.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>

            <!-- Authorized Emails Section -->
            <div class="form-section">
                <h3>üìß Authorized Emails</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                    External users requiring explicit access (contractors, agencies, etc.)
                </p>

                <!-- Current Emails -->
                {% if authorized_emails %}
                <div class="email-list" style="margin-bottom: 1rem;">
                    {% for email in authorized_emails %}
                    <div class="email-item" style="display: flex; align-items: center; justify-content: between; padding: 0.5rem; background: #fef7ec; border: 1px solid #fed7aa; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>{{ email }}</strong>
                            <small style="color: #92400e; margin-left: 0.5rem;">External user</small>
                        </div>
                        <form method="POST" action="{{ url_for('settings.remove_authorized_email', tenant_id=tenant.tenant_id) }}" style="margin: 0;">
                            <input type="hidden" name="email" value="{{ email }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                    onclick="return confirm('Remove {{ email }}? This user will lose access.')">Remove</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; color: #9ca3af; font-style: italic; margin-bottom: 1rem;">
                    No external emails configured
                </div>
                {% endif %}

                <!-- Add Email Form -->
                <form method="POST" action="{{ url_for('settings.add_authorized_email', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label for="new_email" style="font-size: 0.875rem; font-weight: 500;">Add Email</label>
                        <input type="email" id="new_email" name="email" placeholder="contractor@agency.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>

            <!-- Test Access Section -->
            <div class="form-section">
                <h3>üß™ Test Access</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                    Test if an email address would have access to this tenant
                </p>

                <form method="POST" action="{{ url_for('settings.test_domain_access', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label for="test_email" style="font-size: 0.875rem; font-weight: 500;">Email to Test</label>
                        <input type="email" id="test_email" name="test_email" placeholder="user@example.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <button type="submit" class="btn btn-secondary">Test</button>
                </form>
            </div>

            <div class="form-section">
                <h3>Tenant Login URL</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">http://localhost:{{ admin_port }}/tenant/{{ tenant.tenant_id }}/login</pre>
                </div>
                <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                    Share this URL with authorized users to access this tenant directly
                </p>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div id="advanced" class="settings-section">
            <div class="settings-header">
                <h2>Advanced Settings</h2>
                <p>Expert configuration and raw JSON editing</p>
            </div>

            <div class="status-card warning">
                <strong>‚ö†Ô∏è Warning</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Modifying these settings incorrectly may break your configuration
                </p>
            </div>

            <div class="form-section">
                <h3>Raw Configuration (JSON)</h3>
                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/raw">
                    <div class="form-group">
                        <textarea id="raw_config" name="config" rows="20"
                                  style="font-family: monospace;">{{ tenant.config_json }}</textarea>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                        <button type="button" onclick="formatJSON()" class="btn btn-secondary">Format JSON</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Danger Zone -->
        <div id="danger-zone" class="settings-section">
            <div class="settings-header">
                <h2>‚ö†Ô∏è Danger Zone</h2>
                <p>Irreversible and destructive actions</p>
            </div>

            <div class="status-card danger">
                <strong>‚ö†Ô∏è Warning</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Actions in this section are permanent and cannot be easily undone
                </p>
            </div>

            <div class="form-section" style="border: 2px solid #dc2626; border-radius: 8px; padding: 1.5rem; background: #fef2f2;">
                <h3 style="color: #991b1b;">Deactivate Sales Agent</h3>
                <p style="color: #7f1d1d; margin-bottom: 1rem;">
                    Deactivating your sales agent will:
                </p>
                <ul style="color: #7f1d1d; margin-bottom: 1.5rem;">
                    <li>Stop all active media buys immediately</li>
                    <li>Disable API access for all principals</li>
                    <li>Hide this tenant from all user dashboards</li>
                    <li>Prevent new signups or logins</li>
                    <li><strong>Preserve all data</strong> - you can reactivate later by contacting support</li>
                </ul>

                <form id="deactivate-form" method="POST" action="/tenant/{{ tenant.tenant_id }}/deactivate" onsubmit="return confirmDeactivation()">
                    <div class="form-group">
                        <label for="confirm-name" style="color: #991b1b;">
                            Type <strong>{{ tenant.name }}</strong> to confirm:
                        </label>
                        <input type="text" id="confirm-name" name="confirm_name" required
                               placeholder="Enter tenant name to confirm"
                               style="border: 2px solid #dc2626;">
                    </div>

                    <button type="submit" class="btn" style="background: #dc2626; color: white;">
                        Deactivate Sales Agent
                    </button>
                </form>
            </div>

            {% if not tenant.is_active %}
            <div class="form-section" style="border: 2px solid #059669; border-radius: 8px; padding: 1.5rem; background: #f0fdf4;">
                <h3 style="color: #065f46;">Sales Agent Currently Inactive</h3>
                <p style="color: #047857; margin-bottom: 1rem;">
                    This sales agent is currently deactivated. To reactivate, please contact support at
                    <a href="mailto:support@scope3.com">support@scope3.com</a>.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Navigation
document.querySelectorAll('.settings-nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();

        // Update active nav
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');

        // Show corresponding section
        const sectionId = this.dataset.section;
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');

        // Update URL without reload
        history.pushState(null, '', `#${sectionId}`);
    });
});

// Load section from URL hash
window.addEventListener('load', function() {
    const hash = window.location.hash.substring(1);
    if (hash) {
        const navItem = document.querySelector(`[data-section="${hash}"]`);
        if (navItem) {
            navItem.click();
        }
    }
});

// Helper function to switch to a specific section
function switchSettingsSection(sectionId) {
    const navItem = document.querySelector(`[data-section="${sectionId}"]`);
    if (navItem) {
        navItem.click();
    }
}

// Copy to clipboard
function copyToClipboard(buttonOrText) {
    let textToCopy;
    let buttonElement;

    if (typeof buttonOrText === 'string') {
        // Direct text passed
        textToCopy = buttonOrText;
        buttonElement = event.target; // Get the button that was clicked
    } else {
        // Button element passed (existing behavior)
        textToCopy = buttonOrText.parentElement.querySelector('pre').textContent;
        buttonElement = buttonOrText;
    }

    navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'Copied!';
        setTimeout(() => {
            buttonElement.textContent = originalText;
        }, 2000);
    });
}

// Format JSON
function formatJSON() {
    const textarea = document.getElementById('raw_config');
    try {
        const json = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(json, null, 2);
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
    }
}

// Test Slack
function testSlack() {
    const webhookUrl = document.getElementById('slack_webhook_url').value;
    if (!webhookUrl) {
        alert('Please enter a webhook URL first');
        return;
    }

    fetch('{{ script_name }}/tenant/{{ tenant.tenant_id }}/test_slack', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            webhook_url: webhookUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Test message sent successfully! Check your Slack channel.');
        } else {
            alert('Failed to send test message: ' + (data.error || 'Unknown error'));
        }
    });
}

// Select adapter
function selectAdapter(adapterName) {
    console.log('Switching to adapter:', adapterName);

    // Create friendly adapter name for confirmation
    const friendlyNames = {
        'google_ad_manager': 'Google Ad Manager',
        'mock': 'Mock (Testing)',
        'kevel': 'Kevel',
        'triton': 'Triton Digital'
    };

    const friendlyName = friendlyNames[adapterName] || adapterName;

    // Show confirmation dialog
    if (!confirm(`Switch to ${friendlyName}?\n\nThis will change how ads are served for your organization.`)) {
        console.log('User cancelled adapter switch');
        return;
    }

    console.log('User confirmed adapter switch, proceeding...');

    // Send request to update adapter
    fetch(`{{ script_name }}/tenant/{{ tenant.tenant_id }}/settings/adapter`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            adapter: adapterName
        })
    })
    .then(response => {
        if (response.ok) {
            console.log('Adapter switch successful, reloading page...');
            // Simple reload to show the updated adapter
            window.location.reload();
        } else {
            return response.text().then(text => {
                throw new Error(text || 'Failed to switch adapter');
            });
        }
    })
    .catch(error => {
        console.error('Error switching adapter:', error);
        alert('Failed to switch adapter: ' + error.message);
    });
}

// Check OAuth configuration on page load
window.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('oauth-status')) {
        checkOAuthConfig();
    }
    // Always check OAuth status for adapter selection
    checkOAuthForAdapterSelection();
});

// Check if OAuth is properly configured
function checkOAuthConfig() {
    fetch('{{ script_name }}/api/oauth/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('oauth-status');
            if (data.configured) {
                statusDiv.style.background = '#f0f9ff';
                statusDiv.style.borderLeftColor = '#0066cc';
                statusDiv.innerHTML = `
                    <h4>‚úÖ OAuth Setup Complete</h4>
                    <p>OAuth credentials are configured. You can proceed with GAM setup.</p>
                    <small>Client ID: ${data.client_id_prefix}...</small>
                `;
            } else {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.borderLeftColor = '#ffc107';
                statusDiv.innerHTML = `
                    <h4>‚ö†Ô∏è OAuth Setup Required</h4>
                    <p><strong>Before configuring GAM, you need to set up OAuth credentials:</strong></p>
                    <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Set <code>GOOGLE_CLIENT_ID</code> and <code>GOOGLE_CLIENT_SECRET</code> environment variables</li>
                        <li>Ensure the OAuth app has Google Ad Manager API access enabled</li>
                        <li>The OAuth app must be authorized for your Google Workspace domain</li>
                    </ol>
                    <p><strong>Error:</strong> ${data.error || 'OAuth credentials not found'}</p>
                `;
                // Disable GAM configuration if OAuth not set up
                const gamFields = document.querySelectorAll('#gam_refresh_token, #detect-network-btn, button[onclick="saveGAMConfig()"]');
                gamFields.forEach(field => field.disabled = true);
            }
        })
        .catch(error => {
            console.error('Error checking OAuth config:', error);
            const statusDiv = document.getElementById('oauth-status');
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeftColor = '#dc3545';
            statusDiv.innerHTML = `
                <h4>‚ùå Error Checking OAuth Status</h4>
                <p>Could not verify OAuth configuration: ${error.message}</p>
            `;
        });
}

// Start GAM OAuth flow
function startGAMOAuth() {
    // Open OAuth flow in a new window/tab
    const tenantId = '{{ tenant.tenant_id }}';
    const oauthUrl = '{{ script_name }}/auth/gam/authorize/' + tenantId;

    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Starting OAuth...';

    // Store original button state for restoration
    const restoreButton = () => {
        button.disabled = false;
        button.textContent = originalText;
    };

    // Navigate to OAuth URL
    try {
        window.location.href = oauthUrl;
    } catch (error) {
        console.error('Error starting OAuth flow:', error);
        alert('Error starting OAuth flow. Please try again.');
        restoreButton();
    }
}

// Auto-detect GAM network code from refresh token
function detectGAMNetwork() {
    const refreshToken = document.getElementById('gam_refresh_token').value;

    if (!refreshToken) {
        alert('Please enter a refresh token first');
        return;
    }

    const detectBtn = document.getElementById('detect-network-btn');
    detectBtn.disabled = true;
    detectBtn.textContent = 'Detecting...';

    fetch('{{ script_name }}/tenant/{{ tenant.tenant_id }}/gam/detect-network', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ refresh_token: refreshToken })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the network code field
            document.getElementById('gam_network_code').value = data.network_code;
            document.getElementById('gam_network_code').removeAttribute('readonly');

            // Update trafficker_id field if detected
            if (data.trafficker_id) {
                document.getElementById('gam_trafficker_id').value = data.trafficker_id;
            }

            // Show success message inline instead of alert
            const networkField = document.getElementById('gam_network_code').parentElement.parentElement;

            // Remove any existing alerts
            const existingAlert = networkField.querySelector('.alert-success');
            if (existingAlert) existingAlert.remove();

            // Create success message
            const networkInfo = document.createElement('div');
            networkInfo.className = 'alert alert-success';
            networkInfo.style.marginTop = '1rem';
            networkInfo.innerHTML = `
                <strong>‚úÖ Network Detected Successfully!</strong><br>
                <strong>Network:</strong> ${data.network_name}<br>
                <strong>Code:</strong> ${data.network_code}
                ${data.trafficker_id ? `<br><strong>User ID:</strong> ${data.trafficker_id}` : ''}
                ${data.network_count > 1 ? `<br><small>Note: You have access to ${data.network_count} networks. Using the primary one.</small>` : ''}
            `;
            networkField.appendChild(networkInfo);
        } else {
            // Show error inline instead of alert
            const networkField = document.getElementById('gam_network_code').parentElement.parentElement;

            // Remove any existing alerts
            const existingAlert = networkField.querySelector('.alert-danger');
            if (existingAlert) existingAlert.remove();

            // Create error message
            const errorInfo = document.createElement('div');
            errorInfo.className = 'alert alert-danger';
            errorInfo.style.marginTop = '1rem';
            errorInfo.innerHTML = `
                <strong>‚ùå Failed to detect network</strong><br>
                ${data.error || 'Unknown error'}
            `;
            networkField.appendChild(errorInfo);
        }
    })
    .catch(error => {
        console.error('Error detecting network:', error);
        alert('Failed to detect network: ' + error.message);
    })
    .finally(() => {
        detectBtn.disabled = false;
        detectBtn.textContent = 'Auto-detect Network';
    });
}

// Naming template preset configurations
const NAMING_PRESETS = {
    simple: {
        order: '{promoted_offering} - {date_range}',
        lineItem: '{product_name}'
    },
    campaign: {
        order: '{campaign_name|promoted_offering} - {month_year}',
        lineItem: '{order_name} - {product_name}'
    },
    detailed: {
        order: '{campaign_name|promoted_offering} - {date_range} - {package_count}pkg',
        lineItem: '{order_name} - {product_name}'
    }
};

// Apply a naming preset
function useNamingPreset(presetName) {
    const preset = NAMING_PRESETS[presetName];
    if (!preset) return;

    // Support both GAM section and Business Rules section
    const orderTemplateElement = document.getElementById('order_name_template') || document.getElementById('gam_order_name_template');
    const lineItemTemplateElement = document.getElementById('line_item_name_template') || document.getElementById('gam_line_item_name_template');

    if (orderTemplateElement) {
        orderTemplateElement.value = preset.order;
    }
    if (lineItemTemplateElement) {
        lineItemTemplateElement.value = preset.lineItem;
    }

    updateNamingPreview();
}

// Simple template variable substitution
function applyTemplateVariables(template, context) {
    let result = template;

    // Handle fallback syntax {var1|var2|var3}
    const pattern = /\{([^}]+)\}/g;
    result = result.replace(pattern, (match, variables) => {
        const varList = variables.split('|').map(v => v.trim());

        for (const varName of varList) {
            if (context[varName] !== null && context[varName] !== undefined && context[varName] !== '') {
                return context[varName];
            }
        }

        return ''; // No value found
    });

    return result;
}

// Validate template variables against known variables
function validateTemplateVariables(template, knownVars) {
    const warnings = [];
    const pattern = /\{([^}]+)\}/g;
    let match;

    while ((match = pattern.exec(template)) !== null) {
        const variables = match[1].split('|').map(v => v.trim());
        const hasValidVar = variables.some(v => knownVars.includes(v));

        if (!hasValidVar) {
            warnings.push(`Unknown variable: ${match[0]} (available: ${variables.map(v => knownVars.includes(v) ? v : v + '?').join('|')})`);
        }
    }

    return warnings;
}

// Update live preview
function updateNamingPreview() {
    // Support both GAM section (gam_* IDs) and Business Rules section (no prefix)
    const orderTemplateElement = document.getElementById('order_name_template') || document.getElementById('gam_order_name_template');
    const lineItemTemplateElement = document.getElementById('line_item_name_template') || document.getElementById('gam_line_item_name_template');

    if (!orderTemplateElement || !lineItemTemplateElement) {
        console.warn('Naming template elements not found');
        return;
    }

    const orderTemplate = orderTemplateElement.value;
    const lineItemTemplate = lineItemTemplateElement.value;

    // Sample context data
    const orderContext = {
        campaign_name: null,  // Intentionally null to show fallback behavior
        promoted_offering: 'Nike Shoes Q1',
        buyer_ref: 'nike_q1_ref',
        date_range: 'Oct 7-14, 2025',
        month_year: 'Oct 2025',
        package_count: '3',
        start_date: '2025-10-07',
        end_date: '2025-10-14'
    };

    // Generate order name
    const orderName = applyTemplateVariables(orderTemplate, orderContext);

    // Generate line item names
    const products = ['Display 300x250', 'Video Pre-roll', 'Native Article'];
    const lineItemNames = products.map((product, index) => {
        const lineItemContext = {
            order_name: orderName,
            product_name: product,
            package_index: String(index + 1)
        };
        return applyTemplateVariables(lineItemTemplate, lineItemContext);
    });

    // Update preview display
    document.getElementById('order-preview').textContent = orderName || '(empty)';
    document.getElementById('lineitem-preview').innerHTML = lineItemNames
        .map((name, i) => `${i + 1}. ${name || '(empty)'}`)
        .join('<br>');

    // Validation
    const validationDiv = document.getElementById('validation-messages');
    const errors = [];

    // Known variables for validation
    const orderKnownVars = ['campaign_name', 'promoted_offering', 'buyer_ref', 'date_range', 'month_year', 'package_count', 'start_date', 'end_date'];
    const lineItemKnownVars = ['order_name', 'product_name', 'package_index'];

    // Check for unknown variables
    const orderVarWarnings = validateTemplateVariables(orderTemplate, orderKnownVars);
    const lineItemVarWarnings = validateTemplateVariables(lineItemTemplate, lineItemKnownVars);

    orderVarWarnings.forEach(warning => {
        errors.push('‚ö†Ô∏è Order template: ' + warning);
    });

    lineItemVarWarnings.forEach(warning => {
        errors.push('‚ö†Ô∏è Line item template: ' + warning);
    });

    // Check result length and content
    if (!orderName || orderName.trim() === '') {
        errors.push('‚ö†Ô∏è Order template produces empty name - add fallback variables');
    }

    if (orderName.length > 255) {
        errors.push('‚ùå Order name too long (' + orderName.length + ' chars, max 255)');
    }

    lineItemNames.forEach((name, i) => {
        if (!name || name.trim() === '') {
            errors.push(`‚ö†Ô∏è Line item ${i + 1} template produces empty name`);
        }
        if (name.length > 255) {
            errors.push(`‚ùå Line item ${i + 1} name too long (${name.length} chars, max 255)`);
        }
    });

    // Check for risky patterns
    if (orderTemplate.includes('{campaign_name}') && !orderTemplate.includes('|')) {
        errors.push('üí° Tip: {campaign_name} is optional - consider adding fallback like {campaign_name|promoted_offering}');
    }

    if (errors.length > 0) {
        validationDiv.innerHTML = errors.map(err => `<div style="color: ${err.startsWith('‚ùå') ? '#dc2626' : '#f59e0b'};">${err}</div>`).join('');
    } else {
        validationDiv.innerHTML = '<div style="color: #059669;">‚úÖ Templates look good (' + orderName.length + ' chars for order, ' + Math.max(...lineItemNames.map(n => n.length)) + ' chars max for line items)</div>';
    }
}

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize preview if templates section exists (GAM or Business Rules)
    if (document.getElementById('gam_order_name_template') || document.getElementById('order_name_template')) {
        updateNamingPreview();
    }
});

// Save Business Rules
function saveBusinessRules() {
    const data = {
        max_daily_budget: document.getElementById('max_daily_budget').value,
        order_name_template: document.getElementById('order_name_template').value,
        line_item_name_template: document.getElementById('line_item_name_template').value,
        human_review_required: document.getElementById('human_review_required').checked,
        approval_mode: document.getElementById('approval_mode').value,
        creative_review_criteria: document.getElementById('creative_review_criteria').value,
    };

    fetch('{{ script_name }}/tenant/{{ tenant.tenant_id }}/settings/business-rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-success';
            messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-width: 400px;';
            messageDiv.textContent = '‚úì Business rules updated successfully';
            document.body.appendChild(messageDiv);

            // Remove message after 3 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        } else {
            alert('Error updating business rules: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error details:', error);
        alert('Error updating business rules: ' + error.message);
    });
}

// Save GAM configuration
function saveGAMConfig() {
    const networkCode = document.getElementById('gam_network_code').value;
    const refreshToken = document.getElementById('gam_refresh_token').value;
    const traffickerId = document.getElementById('gam_trafficker_id').value;
    const orderNameTemplate = (document.getElementById('gam_order_name_template') || document.getElementById('order_name_template'))?.value || '';
    const lineItemNameTemplate = (document.getElementById('gam_line_item_name_template') || document.getElementById('line_item_name_template'))?.value || '';

    if (!refreshToken) {
        alert('Please provide a Refresh Token');
        return;
    }

    // Network code is optional - can be auto-detected
    if (!networkCode && !confirm('Network code not set. Would you like to auto-detect it first?')) {
        detectGAMNetwork();
        return;
    }

    // Trafficker ID is required for creating line items
    if (!traffickerId) {
        if (confirm('Trafficker ID is not set. This is required for creating line items. Would you like to auto-detect it?')) {
            detectGAMNetwork();
        }
        return;
    }

    fetch('{{ script_name }}/tenant/{{ tenant.tenant_id }}/gam/configure', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            network_code: networkCode,
            refresh_token: refreshToken,
            trafficker_id: traffickerId,
            order_name_template: orderNameTemplate,
            line_item_name_template: lineItemNameTemplate
        })
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(text || 'Failed to save configuration');
            });
        }
    })
    .then(data => {
        alert('GAM configuration saved successfully!');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error saving GAM config:', error);
        alert('Failed to save configuration: ' + error.message);
    });
}

// Test GAM connection
function testGAMConnection() {
    const refreshToken = document.getElementById('gam_refresh_token').value;

    if (!refreshToken) {
        alert('Please provide a refresh token first');
        return;
    }

    fetch('{{ script_name }}/api/gam/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            refresh_token: refreshToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = '‚úÖ GAM connection successful!';
            if (data.networks && data.networks.length > 0) {
                message += '\nNetwork: ' + data.networks[0].displayName;
                message += '\nCode: ' + data.networks[0].networkCode;
                if (data.networks.length > 1) {
                    message += '\n(You have access to ' + data.networks.length + ' networks)';
                }
            }
            alert(message);
        } else {
            alert('‚ùå GAM connection failed:\n' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error testing connection: ' + error.message);
    });
}

// Load product template
function loadTemplate(templateType) {
    // Would load product template
    console.log('Loading template:', templateType);
}

// Sync GAM inventory
function syncGAMInventory() {
    const button = event.target.closest('button');
    const syncIcon = document.getElementById('sync-icon');
    const originalText = button.innerHTML;

    button.disabled = true;
    button.innerHTML = '<span id="sync-icon">‚è≥</span> Syncing...';

    fetch('{{ script_name }}/tenant/{{ tenant.tenant_id }}/gam/sync-inventory', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(text || 'Failed to sync inventory');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('‚úÖ Inventory synced successfully!\n\n' +
                  'Ad Units: ' + (data.ad_units_count || 0) + '\n' +
                  'Placements: ' + (data.placements_count || 0) + '\n' +
                  'Custom Targeting: ' + (data.targeting_count || 0));
            window.location.reload();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error syncing inventory:', error);
        alert('‚ùå Failed to sync inventory:\n\n' + error.message);
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// Check OAuth status for adapter selection (runs on page load)
function checkOAuthForAdapterSelection() {
    fetch('{{ script_name }}/api/oauth/status')
        .then(response => response.json())
        .then(data => {
            const gamCard = document.getElementById('gam-adapter-card');
            const gamNotice = document.getElementById('gam-prerequisite-notice');

            if (!data.configured) {
                // OAuth not configured - disable GAM card
                gamCard.classList.add('disabled');
                gamNotice.style.display = 'block';
                gamCard.setAttribute('title', 'OAuth credentials must be configured in super admin settings before using Google Ad Manager');
            } else {
                // OAuth configured - enable GAM card
                gamCard.classList.remove('disabled');
                gamNotice.style.display = 'none';
                gamCard.removeAttribute('title');
            }
        })
        .catch(error => {
            console.error('Error checking OAuth for adapter selection:', error);
            // On error, disable GAM as a precaution
            const gamCard = document.getElementById('gam-adapter-card');
            const gamNotice = document.getElementById('gam-prerequisite-notice');
            gamCard.classList.add('disabled');
            gamNotice.style.display = 'block';
            gamNotice.textContent = 'Unable to verify OAuth setup';
        });
}

// Handle GAM adapter selection (with OAuth prerequisite check)
function selectGAMAdapter() {
    console.log('selectGAMAdapter() called');
    const gamCard = document.getElementById('gam-adapter-card');

    if (!gamCard) {
        console.error('GAM adapter card not found!');
        return;
    }

    console.log('GAM card classes:', gamCard.className);

    if (gamCard.classList.contains('disabled')) {
        console.log('GAM card is disabled - showing OAuth alert');
        alert('Google Ad Manager requires OAuth setup in super admin settings first.\n\nPlease contact your administrator to configure OAuth credentials.');
        return;
    }

    console.log('GAM card is enabled - proceeding with adapter selection');
    // OAuth is configured, proceed with normal adapter selection
    selectAdapter('google_ad_manager');
}

// Copy A2A configuration for a principal
function copyA2AConfig(principalId, principalName, accessToken) {
    {% if tenant.virtual_host %}
    // Use external domain if configured
    const agentUri = "{% if is_production %}https://{{ tenant.virtual_host }}{% else %}http://localhost:{{ a2a_port }}{% endif %}";
    {% else %}
    // Use subdomain as fallback
    const agentUri = "{% if is_production %}https://{{ tenant.subdomain }}.sales-agent.scope3.com{% else %}http://localhost:{{ a2a_port }}{% endif %}";
    {% endif %}

    const a2aConfig = {
        "id": principalId,
        "name": principalName,
        "agent_uri": agentUri,
        "protocol": "a2a",
        "auth_token": accessToken,
        "requiresAuth": true
    };

    const configText = JSON.stringify(a2aConfig, null, 2);

    navigator.clipboard.writeText(configText).then(() => {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = 'üìã Copied!';
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    });
}

// Delete a principal/advertiser
function deletePrincipal(principalId, principalName) {
    if (!confirm(`Are you sure you want to delete advertiser "${principalName}"?\n\nThis action cannot be undone and will fail if there are active media buys.`)) {
        return;
    }

    fetch(`{{ script_name }}/tenant/{{ tenant.tenant_id }}/principals/${principalId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || `Advertiser "${principalName}" deleted successfully`);
            // Reload the page to update the advertisers list
            window.location.reload();
        } else {
            alert('Failed to delete advertiser: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting principal:', error);
        alert('Failed to delete advertiser: ' + error.message);
    });
}

// Signals Discovery Functions
function testSignalsConnection() {
    const upstreamUrl = document.getElementById('signals_upstream_url').value;
    const authToken = document.getElementById('signals_auth_token').value;

    if (!upstreamUrl) {
        alert('Please enter the upstream signals agent URL first');
        return;
    }

    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Testing...';
    button.disabled = true;

    fetch('{{ script_name }}/tenant/{{ tenant.tenant_id }}/settings/test_signals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            upstream_url: upstreamUrl,
            upstream_token: authToken,
            auth_header: document.getElementById('signals_auth_header').value || 'x-adcp-auth'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Signals agent connection successful!\n\n' +
                  'Server: ' + data.server_info + '\n' +
                  'Response time: ' + data.response_time + 'ms');
        } else {
            alert('‚ùå Signals agent connection failed:\n\n' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error testing signals connection:', error);
        alert('Error testing connection: ' + error.message);
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

// Toggle signals configuration visibility
document.addEventListener('DOMContentLoaded', function() {
    const enableCheckbox = document.getElementById('signals_enabled');
    const configSection = document.getElementById('signals-config');

    if (enableCheckbox && configSection) {
        enableCheckbox.addEventListener('change', function() {
            if (this.checked) {
                configSection.style.display = 'block';
                // Make required fields actually required
                document.getElementById('signals_upstream_url').required = true;
            } else {
                configSection.style.display = 'none';
                // Remove required attribute when disabled
                document.getElementById('signals_upstream_url').required = false;
            }
        });
    }
});

// Debug: Log the current adapter state from backend
console.log('Backend says active_adapter is:', '{{ active_adapter }}');
console.log('Backend says tenant.ad_server is:', '{{ tenant.ad_server }}');
console.log('Current URL params:', window.location.search);

// Virtual host is now managed via simple text input
// No widget integration needed

// JavaScript widget functions removed - virtual host now uses simple manual input

// ========== Principal Mappings Editor ==========
let currentPrincipalId = null;
let currentPrincipalName = null;

function editPrincipalMappings(principalId, principalName) {
    currentPrincipalId = principalId;
    currentPrincipalName = principalName;

    // Show loading state
    document.getElementById('editPrincipalModalTitle').textContent = `Edit ${principalName}`;
    document.getElementById('editPrincipalForm').innerHTML = '<p class="text-center">Loading...</p>';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editPrincipalModal'));
    modal.show();

    // Fetch principal data
    fetch(`{{ script_name }}/tenant/{{ tenant.tenant_id }}/principal/${principalId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderPrincipalEditor(data.principal);
        } else {
            document.getElementById('editPrincipalForm').innerHTML =
                `<div class="alert alert-danger">${data.error || 'Failed to load principal'}</div>`;
        }
    })
    .catch(error => {
        console.error('Error loading principal:', error);
        document.getElementById('editPrincipalForm').innerHTML =
            `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
}

function renderPrincipalEditor(principal) {
    const mappings = principal.platform_mappings || {};
    const gamMapping = mappings.google_ad_manager || {};
    const mockMapping = mappings.mock || {};
    const activeAdapter = '{{ active_adapter }}';

    let adapterSection = '';

    if (activeAdapter === 'google_ad_manager') {
        // GAM tenant - only show GAM fields
        adapterSection = `
            <h5 class="mt-4 mb-3">Google Ad Manager Configuration</h5>
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Note:</strong> This tenant uses Google Ad Manager. All campaigns will be executed through GAM.
            </div>
            <div class="mb-3">
                <label for="gam_company_id" class="form-label">GAM Advertiser <span style="color: red;">*</span></label>
                <select class="form-control" id="gam_company_id">
                    <option value="">Loading advertisers...</option>
                </select>
                <small class="form-text text-muted">Select which advertiser company this represents in Google Ad Manager</small>
                <div id="edit-advertiser-loading-error" style="display: none; color: red; margin-top: 0.5rem;"></div>
            </div>

            <div class="mb-3">
                <label for="gam_trafficker_id" class="form-label">Trafficker ID (Optional)</label>
                <input type="text" class="form-control" id="gam_trafficker_id"
                       value="${gamMapping.trafficker_id || ''}"
                       placeholder="e.g., 9876543210">
                <small class="form-text text-muted">The GAM user ID for trafficking operations</small>
            </div>`;
    } else {
        // Mock tenant - only show mock fields
        adapterSection = `
            <h5 class="mt-4 mb-3">Mock Adapter Configuration</h5>
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Note:</strong> This tenant uses the Mock adapter for testing. No real ad server API calls will be made.
                <br><strong>To use a real ad server</strong>, configure GAM or another adapter in the Ad Server settings tab.
            </div>
            <div class="mb-3">
                <label for="mock_advertiser_id" class="form-label">Mock Advertiser ID</label>
                <input type="text" class="form-control" id="mock_advertiser_id"
                       value="${mockMapping.advertiser_id || principal.principal_id}"
                       placeholder="e.g., mock_${principal.principal_id}">
                <small class="form-text text-muted">Mock ID for testing (auto-populated with principal ID)</small>
            </div>`;
    }

    const html = `
        <form id="mappingsForm">
            <div class="mb-3">
                <label class="form-label"><strong>Principal ID:</strong> <code>${principal.principal_id}</code></label>
            </div>

            ${adapterSection}
        </form>
    `;

    document.getElementById('editPrincipalForm').innerHTML = html;

    // Load GAM advertisers if this is a GAM tenant
    if (activeAdapter === 'google_ad_manager') {
        loadGAMAdvertisersForEdit(gamMapping.company_id || gamMapping.advertiser_id || '');
    }
}

function loadGAMAdvertisersForEdit(currentAdvertiserId) {
    const selectElement = document.getElementById('gam_company_id');
    const errorDiv = document.getElementById('edit-advertiser-loading-error');

    if (!selectElement) {
        return; // Element not found, probably not a GAM tenant
    }

    // Show loading state
    selectElement.innerHTML = '<option value="">Loading advertisers...</option>';
    selectElement.disabled = true;
    errorDiv.style.display = 'none';

    // Fetch advertisers from API (same endpoint as create form)
    fetch('{{ script_name }}/tenant/{{ tenant.tenant_id }}/api/gam/get-advertisers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tenant_id: '{{ tenant.tenant_id }}'
        }),
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        // Clear loading state
        selectElement.innerHTML = '';
        selectElement.disabled = false;

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select an advertiser...';
        selectElement.appendChild(defaultOption);

        // Add advertiser options
        if (data.advertisers && data.advertisers.length > 0) {
            data.advertisers.forEach(advertiser => {
                const option = document.createElement('option');
                option.value = advertiser.id;
                option.textContent = advertiser.name;
                selectElement.appendChild(option);
            });

            // Restore current selection if provided
            if (currentAdvertiserId) {
                selectElement.value = currentAdvertiserId;
            }
        } else {
            // No advertisers found
            const noAdvertisersOption = document.createElement('option');
            noAdvertisersOption.value = '';
            noAdvertisersOption.textContent = 'No advertisers found in GAM';
            noAdvertisersOption.disabled = true;
            selectElement.appendChild(noAdvertisersOption);

            errorDiv.textContent = 'No advertisers found. Please create an advertiser in Google Ad Manager first.';
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error loading advertisers for edit:', error);
        selectElement.innerHTML = '<option value="">Failed to load advertisers</option>';
        selectElement.disabled = false;
        errorDiv.textContent = 'Error loading advertisers: ' + error.message;
        errorDiv.style.display = 'block';
    });
}

function savePrincipalMappings() {
    const activeAdapter = '{{ active_adapter }}';

    // Build platform mappings - ONLY for the active adapter
    // This ensures we don't store useless mappings for inactive adapters
    const platformMappings = {};

    if (activeAdapter === 'google_ad_manager') {
        // GAM tenant - only save GAM mapping
        const gamCompanyIdEl = document.getElementById('gam_company_id');
        const gamTraffickerIdEl = document.getElementById('gam_trafficker_id');

        const gamCompanyId = gamCompanyIdEl ? gamCompanyIdEl.value.trim() : '';
        const gamTraffickerId = gamTraffickerIdEl ? gamTraffickerIdEl.value.trim() : '';

        // Client-side validation for GAM advertiser ID
        if (gamCompanyId) {
            // Check if it's numeric
            if (!/^\d+$/.test(gamCompanyId)) {
                alert(`‚ùå GAM Advertiser ID must be numeric (got: '${gamCompanyId}'). Please select a valid advertiser from the dropdown.`);
                return;
            }
        }

        // Create GAM mapping (only active adapter)
        if (gamCompanyId || gamTraffickerId) {
            platformMappings.google_ad_manager = {
                enabled: true  // Always enabled for GAM tenants
            };
            if (gamCompanyId) {
                platformMappings.google_ad_manager.advertiser_id = gamCompanyId;
                platformMappings.google_ad_manager.company_id = gamCompanyId; // Both for compatibility
            }
            if (gamTraffickerId) {
                platformMappings.google_ad_manager.trafficker_id = gamTraffickerId;
            }
        }
    } else {
        // Mock tenant - only save mock mapping
        const mockAdvertiserIdEl = document.getElementById('mock_advertiser_id');
        const mockAdvertiserId = mockAdvertiserIdEl ? mockAdvertiserIdEl.value.trim() : '';

        if (mockAdvertiserId) {
            platformMappings.mock = {
                enabled: true,  // Always enabled for mock tenants
                advertiser_id: mockAdvertiserId
            };
        }
    }

    // Show saving state
    const saveBtn = document.getElementById('saveMappingsBtn');
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    // Send update request
    fetch(`{{ script_name }}/tenant/{{ tenant.tenant_id }}/principal/${currentPrincipalId}/update_mappings`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            platform_mappings: platformMappings
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Platform mappings updated successfully for ${currentPrincipalName}`);
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPrincipalModal'));
            modal.hide();
            // Reload page to show updated data
            window.location.reload();
        } else {
            alert('‚ùå Failed to update mappings: ' + (data.error || 'Unknown error'));
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error updating mappings:', error);
        alert('‚ùå Error: ' + error.message);
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
    });
}

// Tenant deactivation confirmation
function confirmDeactivation() {
    const confirmName = document.getElementById('confirm-name').value.trim();
    const expectedName = "{{ tenant.name }}".trim();

    if (confirmName !== expectedName) {
        alert('‚ùå The name you entered does not match. Please type the exact tenant name to confirm.');
        return false;
    }

    return confirm(
        '‚ö†Ô∏è FINAL WARNING\n\n' +
        'This will immediately deactivate your sales agent and stop all active campaigns.\n\n' +
        'Are you absolutely sure you want to proceed?'
    );
}

// Creative Review: Update UI based on selected approval mode
function updateApprovalModeUI() {
    const mode = document.getElementById('approval_mode').value;
    const aiConfigSection = document.getElementById('ai-config-section');

    // Hide all mode descriptions
    document.getElementById('desc-auto-approve').style.display = 'none';
    document.getElementById('desc-require-human').style.display = 'none';
    document.getElementById('desc-ai-powered').style.display = 'none';

    // Show selected mode description
    if (mode === 'auto-approve') {
        document.getElementById('desc-auto-approve').style.display = 'block';
        aiConfigSection.style.display = 'none';
    } else if (mode === 'require-human') {
        document.getElementById('desc-require-human').style.display = 'block';
        aiConfigSection.style.display = 'none';
    } else if (mode === 'ai-powered') {
        document.getElementById('desc-ai-powered').style.display = 'block';
        aiConfigSection.style.display = 'block';
    }
}

// Initialize approval mode UI on page load
document.addEventListener('DOMContentLoaded', function() {
    updateApprovalModeUI();
});
</script>

<!-- Edit Principal Mappings Modal -->
<div class="modal fade" id="editPrincipalModal" tabindex="-1" aria-labelledby="editPrincipalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPrincipalModalTitle">Edit Platform Mappings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editPrincipalForm">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMappingsBtn" onclick="savePrincipalMappings()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
