{% extends "base.html" %}

{% block title %}{{ tenant.name }} - Settings{% endblock %}

{% block content %}
<style>
    /* Spinning animation for sync button */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .settings-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 2rem;
        min-height: 600px;
    }

    .settings-nav {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        margin-bottom: 0.25rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        color: #4b5563;
        text-decoration: none;
    }

    .settings-nav-item:hover {
        background: #f3f4f6;
        color: #111827;
    }

    .settings-nav-item.active {
        background: #eff6ff;
        color: #2563eb;
        font-weight: 600;
    }

    .settings-nav-icon {
        width: 20px;
        text-align: center;
    }

    .settings-nav-separator {
        height: 1px;
        background: #e5e7eb;
        margin: 1rem 0;
    }

    .settings-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .settings-section {
        display: none;
    }

    .settings-section.active {
        display: block;
    }

    .settings-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .settings-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }

    .settings-header p {
        margin: 0;
        color: #6b7280;
        font-size: 0.875rem;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    .checkbox-group label {
        margin: 0;
        font-size: 0.875rem;
        color: #374151;
    }

    .status-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .status-card.success {
        background: #f0fdf4;
        border-color: #86efac;
    }

    .status-card.warning {
        background: #fffbeb;
        border-color: #fde047;
    }

    .status-card.error {
        background: #fef2f2;
        border-color: #fca5a5;
    }

    .status-card.danger {
        background: #fef2f2;
        border: 2px solid #dc2626;
        border-left: 4px solid #dc2626;
    }

    .adapter-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .adapter-card {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .adapter-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .adapter-card.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .adapter-card.current {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .adapter-card.disabled {
        border-color: #d1d5db;
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .adapter-card.disabled:hover {
        border-color: #d1d5db;
        box-shadow: none;
    }

    .adapter-card .prerequisite-notice {
        font-size: 0.75rem;
        color: #ef4444;
        margin-top: 0.5rem;
        font-weight: 500;
    }

    .adapter-card h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .adapter-card p {
        margin: 0;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .adapter-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.125rem 0.5rem;
        background: #10b981;
        color: white;
        font-size: 0.625rem;
        font-weight: 600;
        border-radius: 4px;
        text-transform: uppercase;
    }

    .button-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e5e7eb;
    }

    .config-code {
        background: #1f2937;
        color: #f3f4f6;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.75rem;
        overflow-x: auto;
        position: relative;
    }

    .copy-button {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: #374151;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
    }

    .copy-button:hover {
        background: #4b5563;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid;
    }

    .alert-warning {
        background: #fffbeb;
        border-color: #fde047;
        color: #92400e;
    }

    .alert-info {
        background: #eff6ff;
        border-color: #93c5fd;
        color: #1e40af;
    }

    .stat-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .settings-layout {
            grid-template-columns: 1fr;
        }

        .settings-nav {
            position: static;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr !important;
        }
    }

    /* Virtual Host now uses simple text input - complex widget styling removed */
</style>

<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1 style="margin: 0; font-size: 1.875rem; font-weight: 700; color: #111827;">Settings</h1>
        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">
            Configure {{ tenant.name }}
        </p>
    </div>
    <a href="/tenant/{{ tenant.tenant_id }}" class="btn btn-secondary">
        ‚Üê Back to Dashboard
    </a>
</div>

<div class="settings-layout">
    <!-- Settings Navigation -->
    <nav class="settings-nav">
        <a class="settings-nav-item active" data-section="account">
            <span class="settings-nav-icon">üè¢</span>
            <span>Account</span>
        </a>

        <a class="settings-nav-item" href="{{ url_for('tenants.setup_checklist', tenant_id=tenant.tenant_id) }}">
            <span class="settings-nav-icon">‚úÖ</span>
            <span>Setup Checklist</span>
        </a>

        <div class="settings-nav-separator"></div>

        <a class="settings-nav-item" data-section="adserver">
            <span class="settings-nav-icon">üñ•Ô∏è</span>
            <span>Ad Server</span>
        </a>

        <a class="settings-nav-item" data-section="business-rules">
            <span class="settings-nav-icon">üìã</span>
            <span>Policies & Workflows</span>
        </a>

        <div class="settings-nav-separator"></div>

        <a class="settings-nav-item" data-section="inventory">
            <span class="settings-nav-icon">üìä</span>
            <span>Inventory</span>
        </a>

        <a class="settings-nav-item" href="{{ url_for('authorized_properties.list_authorized_properties', tenant_id=tenant.tenant_id) }}">
            <span class="settings-nav-icon">üîë</span>
            <span>Authorized Properties</span>
        </a>

        <a class="settings-nav-item" data-section="products">
            <span class="settings-nav-icon">üì¶</span>
            <span>Products</span>
        </a>

        <a class="settings-nav-item" data-section="advertisers">
            <span class="settings-nav-icon">üë•</span>
            <span>Advertisers</span>
        </a>

        <div class="settings-nav-separator"></div>

        <a class="settings-nav-item" data-section="integrations">
            <span class="settings-nav-icon">üîó</span>
            <span>Integrations</span>
        </a>

        <a class="settings-nav-item" data-section="danger-zone">
            <span class="settings-nav-icon">‚ö†Ô∏è</span>
            <span>Danger Zone</span>
        </a>
    </nav>

    <!-- Settings Content -->
    <div class="settings-content">
        <!-- Account Settings (renamed from General) -->
        <div id="account" class="settings-section active">
            <div class="settings-header">
                <h2>Account</h2>
                <p>Organization identity, virtual host configuration, and access control</p>
            </div>

            <form id="account-settings-form" method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/general">
                <div class="form-section">
                    <h3>Organization Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tenant_name">Organization Name</label>
                            <input type="text" id="tenant_name" name="name" value="{{ tenant.name }}" required>
                        </div>

                        <div class="form-group">
                            <label for="subdomain">Subdomain</label>
                            <input type="text" id="subdomain" name="subdomain" value="{{ tenant.subdomain }}" readonly>
                            <small>Cannot be changed after creation</small>
                        </div>

                        <div class="form-group">
                            <label for="virtual_host">Virtual Host (Optional)</label>
                            <input type="text" id="virtual_host" name="virtual_host" value="{{ tenant.virtual_host or '' }}" placeholder="e.g. ad-sales.yourcompany.com">
                            <small>
                                <p style="margin-top: 0.5rem; color: #666; font-size: 0.85em;">
                                    üí° Your custom domain will route to this tenant's MCP server and admin interface. Enter a domain above to see DNS setup instructions.
                                </p>
                            </small>
                        </div>

                        <!-- DNS Configuration Widget -->
                        <div id="dns-widget-container" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">üìù Configure DNS Records</h4>
                            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                                Follow the steps below to configure your DNS records. The widget will automatically detect your DNS provider and verify your configuration.
                            </p>

                            <!-- Success message (hidden by default) -->
                            <div id="dns-success-message" style="display: none; padding: 1rem; background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">‚úÖ</span>
                                    <div>
                                        <div style="font-weight: 600; color: #065f46; font-size: 1rem;">DNS Records Verified!</div>
                                        <div style="color: #047857; font-size: 0.875rem;">Your custom domain is properly configured and pointing to sales-agent.scope3.com</div>
                                    </div>
                                </div>
                            </div>

                            <div id="apxdnswidget"></div>
                        </div>

                        <!-- Domain Registration Status (Approximated Backend) -->
                        <div id="domain-registration-container" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">üîí Domain Registration Status</h4>
                            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                                Your domain must be registered with the backend to enable HTTPS/TLS and traffic routing.
                            </p>

                            <!-- Status display -->
                            <div id="domain-status-display" style="margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px;">
                                    <span id="domain-status-icon" style="font-size: 1.25rem;">‚è≥</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.875rem;" id="domain-status-text">Checking status...</div>
                                        <div style="color: #6b7280; font-size: 0.75rem;" id="domain-status-details"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action buttons -->
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" class="btn btn-secondary btn-sm" id="check-domain-status-btn" onclick="checkDomainRegistrationStatus()">
                                    Check Status
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" id="register-domain-btn" onclick="registerDomain()" style="display: none;">
                                    Register Domain
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="unregister-domain-btn" onclick="unregisterDomain()" style="display: none;">
                                    Unregister Domain
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Budget & Limits moved to Business Rules section -->
                <!-- Features moved to Business Rules section -->

                <!-- DNS Verification Warning -->
                <div id="dns-warning-banner" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <div style="font-weight: 600; color: #92400e; font-size: 1rem;">DNS Records Not Verified</div>
                            <div style="color: #78350f; font-size: 0.875rem;">Your custom domain DNS records have not been verified yet. The domain may not work until DNS is properly configured.</div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save Account Settings</button>
                    <button type="reset" class="btn btn-secondary">Reset</button>
                </div>
            </form>

            <!-- Access Control (Domain & Email Authorization) -->
            <div class="form-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                <h3>üîê Access Control</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem;">
                    Control who can access this tenant's admin interface
                </p>

                <!-- Authorized Domains -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">üè¢ Authorized Domains</h4>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Users from these domains get automatic admin access via OAuth
                    </p>

                    {% if authorized_domains %}
                    <div class="domain-list" style="margin-bottom: 1rem;">
                        {% for domain in authorized_domains %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <strong>{{ domain }}</strong>
                                <small style="color: #6b7280; margin-left: 0.5rem;">@{{ domain }} users</small>
                            </div>
                            <form method="POST" action="{{ url_for('settings.remove_authorized_domain', tenant_id=tenant.tenant_id) }}" style="margin: 0;">
                                <input type="hidden" name="domain" value="{{ domain }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm"
                                        onclick="return confirm('Remove domain {{ domain }}? Users from this domain will lose access.')">Remove</button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; color: #9ca3af; font-style: italic; margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                        No authorized domains configured
                    </div>
                    {% endif %}

                    <form method="POST" action="{{ url_for('settings.add_authorized_domain', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                        <div style="flex: 1;">
                            <label for="new_domain" style="font-size: 0.875rem; font-weight: 500;">Add Domain</label>
                            <input type="text" id="new_domain" name="domain" placeholder="company.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Domain</button>
                    </form>
                </div>

                <!-- Authorized Emails -->
                <div>
                    <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">üìß Authorized Emails</h4>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        External users requiring explicit access (contractors, agencies, etc.)
                    </p>

                    {% if authorized_emails %}
                    <div class="email-list" style="margin-bottom: 1rem;">
                        {% for email in authorized_emails %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: #fef7ec; border: 1px solid #fed7aa; border-radius: 6px; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <strong>{{ email }}</strong>
                                <small style="color: #92400e; margin-left: 0.5rem;">External user</small>
                            </div>
                            <form method="POST" action="{{ url_for('settings.remove_authorized_email', tenant_id=tenant.tenant_id) }}" style="margin: 0;">
                                <input type="hidden" name="email" value="{{ email }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm"
                                        onclick="return confirm('Remove {{ email }}? This user will lose access.')">Remove</button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; color: #9ca3af; font-style: italic; margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                        No external emails configured
                    </div>
                    {% endif %}

                    <form method="POST" action="{{ url_for('settings.add_authorized_email', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                        <div style="flex: 1;">
                            <label for="new_email" style="font-size: 0.875rem; font-weight: 500;">Add Email</label>
                            <input type="email" id="new_email" name="email" placeholder="contractor@agency.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Email</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Ad Server Settings -->
        <div id="adserver" class="settings-section">
            <div class="settings-header">
                <h2>Ad Server Configuration</h2>
                <p>Connect and configure your ad serving platform</p>
            </div>

            {% if active_adapter %}
            <div class="status-card success">
                <strong>‚úÖ Connected to {{ active_adapter|title|replace('_', ' ') }}</strong>
            </div>
            {% else %}
            <div class="status-card warning">
                <strong>‚ö†Ô∏è No Ad Server Connected</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Select an ad server below to get started
                </p>
            </div>
            {% endif %}

            <div class="form-section">
                <h3>Available Ad Servers</h3>
                <div class="adapter-cards">
                    <div class="adapter-card {% if active_adapter == 'mock' %}current{% endif %}"
                         onclick="selectAdapter('mock')">
                        {% if active_adapter == 'mock' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Mock (Testing)</h4>
                        <p>Perfect for development and testing. No external setup required.</p>
                    </div>

                    <div id="gam-adapter-card" class="adapter-card {% if active_adapter == 'google_ad_manager' %}current{% endif %}"
                         onclick="selectGAMAdapter()">
                        {% if active_adapter == 'google_ad_manager' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Google Ad Manager</h4>
                        <p>Enterprise ad serving platform from Google</p>
                        <div id="gam-prerequisite-notice" class="prerequisite-notice" style="display: none;">
                            OAuth setup required in super admin settings
                        </div>
                    </div>

                    <div class="adapter-card {% if active_adapter == 'kevel' %}current{% endif %}"
                         onclick="selectAdapter('kevel')">
                        {% if active_adapter == 'kevel' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Kevel</h4>
                        <p>API-first ad serving for developers</p>
                    </div>

                    <div class="adapter-card {% if active_adapter == 'triton' %}current{% endif %}"
                         onclick="selectAdapter('triton')">
                        {% if active_adapter == 'triton' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Triton Digital</h4>
                        <p>Audio and podcast advertising platform</p>
                    </div>
                </div>
            </div>

            <!-- Adapter-specific configuration will be loaded here -->
            <div id="adapter-config">
                {% if active_adapter == 'google_ad_manager' %}
                <div class="form-section" style="margin-top: 2rem;">
                    <h3>Google Ad Manager Configuration</h3>

                    {% if adapter_config and adapter_config.get('refresh_token') and adapter_config.get('network_code') %}
                    <!-- Fully configured - show success state -->
                    <div class="status-card" style="background: #f0fdf4; border-left: 4px solid #10b981;">
                        <h4>‚úÖ Configuration Complete</h4>
                        <ul style="list-style: none; padding: 0; margin: 0.5rem 0;">
                            <li>‚úÖ OAuth Token: Configured</li>
                            <li>‚úÖ Network Code: {{ adapter_config.get('network_code') }}</li>
                            {% if adapter_config.get('trafficker_id') %}
                            <li>‚úÖ Trafficker ID: {{ adapter_config.get('trafficker_id') }}</li>
                            {% endif %}
                        </ul>
                        <button onclick="testGAMConnection()" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;">
                            Test Connection
                        </button>
                        <button onclick="initiateGAMAuth()" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem; margin-left: 0.5rem;">
                            Refresh OAuth Token
                        </button>
                    </div>
                    {% else %}
                    <!-- Not configured or partially configured -->

                    <!-- Step 1: Get OAuth Token -->
                    <div class="form-group">
                        <label><strong>Step 1:</strong> Get OAuth Token</label>
                        {% if adapter_config and adapter_config.get('refresh_token') %}
                        <div class="status-card" style="background: #f0fdf4; border-left: 4px solid #10b981;">
                            <strong>‚úÖ OAuth Token Configured</strong>
                            <p>Your refresh token is active.</p>
                            <button onclick="initiateGAMAuth()" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;">
                                Refresh OAuth Token
                            </button>
                        </div>
                        {% else %}
                        <div class="status-card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                            <strong>‚ö†Ô∏è OAuth Setup Required</strong>
                            <p>Click the button below to authorize AdCP access to your Google Ad Manager account.</p>
                            <button onclick="initiateGAMAuth()" class="btn btn-primary" style="margin-top: 0.5rem;">
                                üîë Get OAuth Token
                            </button>
                        </div>
                        {% endif %}

                        <!-- Advanced option for manual token entry -->
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; color: #666; font-size: 0.9em;">‚ñ∏ Advanced: Manual Token Entry</summary>
                            <div style="margin-top: 0.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                <label for="gam_refresh_token">Manual OAuth Refresh Token</label>
                                <input type="text" id="gam_refresh_token" class="form-control"
                                       value="{{ adapter_config.get('refresh_token', '') if adapter_config else '' }}"
                                       placeholder="Paste your OAuth refresh token here">
                                <small class="form-text text-muted">For advanced users: manually enter a refresh token if you have one.</small>
                                <button onclick="saveManualToken()" class="btn btn-primary" style="margin-top: 0.5rem;">
                                    Save Token
                                </button>
                            </div>
                        </details>
                    </div>

                    <!-- Step 2: Auto-detect Network (only show if token exists) -->
                    {% if adapter_config and adapter_config.get('refresh_token') %}
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label><strong>Step 2:</strong> Auto-detect Network Code</label>
                        {% if adapter_config.get('network_code') %}
                        <div class="status-card" style="background: #f0fdf4; border-left: 4px solid #10b981;">
                            <strong>‚úÖ Network Code Detected: {{ adapter_config.get('network_code') }}</strong>
                            {% if adapter_config.get('trafficker_id') %}
                            <p>Trafficker ID: {{ adapter_config.get('trafficker_id') }}</p>
                            {% endif %}
                        </div>
                        {% else %}
                        <div style="display: flex; gap: 0.5rem; align-items: start;">
                            <div style="flex: 1;">
                                <input type="text" id="gam_network_code" class="form-control"
                                       value="{{ adapter_config.get('network_code', '') if adapter_config else '' }}"
                                       placeholder="Click button to auto-detect ‚Üí" readonly>
                            </div>
                            <button onclick="detectGAMNetwork()" class="btn btn-primary" id="detect-network-btn">
                                Auto-detect Network
                            </button>
                        </div>
                        <small class="form-text text-muted">Uses your OAuth token to automatically retrieve your GAM network code and trafficker ID.</small>

                        <input type="hidden" id="gam_trafficker_id"
                               value="{{ adapter_config.get('trafficker_id', '') if adapter_config else '' }}">
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endif %}

                    <!-- Service Account Integration Option -->
                    <div class="form-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                        <h3>üîß Alternative: Service Account Integration (Recommended for Partners)</h3>
                        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                            For partner integrations, we can create and manage a service account for you. This is more secure and doesn't require sharing credentials.
                        </p>

                        {% if adapter_config and adapter_config.get('service_account_email') %}
                        <!-- Service account already created -->
                        <div class="status-card" style="background: #f0fdf4; border-left: 4px solid #10b981;">
                            <h4>‚úÖ Service Account Created</h4>
                            <p style="margin: 0.5rem 0;">
                                <strong>Service Account Email:</strong><br>
                                <code style="background: #e5e7eb; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9em;">{{ adapter_config.get('service_account_email') }}</code>
                            </p>
                            <div style="margin-top: 1rem; padding: 1rem; background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 4px;">
                                <p style="margin: 0; font-size: 0.875rem;"><strong>‚ö†Ô∏è Next Steps:</strong></p>
                                <ol style="margin: 0.5rem 0 0 1.5rem; padding: 0; font-size: 0.875rem;">
                                    <li>Log into your Google Ad Manager account</li>
                                    <li>Go to <strong>Admin ‚Üí Access & authorization ‚Üí Users</strong></li>
                                    <li>Click <strong>New user</strong></li>
                                    <li>Add the service account email above</li>
                                    <li>Assign the <strong>Trafficker</strong> role</li>
                                    <li>Click <strong>Save</strong></li>
                                    <li>Enter your GAM Network Code below</li>
                                    <li>Click "Save Network Code"</li>
                                    <li>Click "Test Connection" to verify</li>
                                </ol>
                            </div>

                            <!-- Network Code Configuration -->
                            <div style="margin-top: 1.5rem;">
                                <label style="font-weight: 600; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">
                                    GAM Network Code <span style="color: #dc2626;">*</span>
                                </label>
                                {% if adapter_config.get('network_code') %}
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="text" id="service_account_network_code"
                                           value="{{ adapter_config.get('network_code') }}"
                                           style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace;"
                                           placeholder="e.g., 12345678">
                                    <button onclick="saveServiceAccountNetworkCode()" class="btn btn-primary btn-sm">
                                        Save Network Code
                                    </button>
                                </div>
                                <small style="color: #10b981; display: block; margin-top: 0.25rem;">‚úÖ Network code configured</small>
                                {% else %}
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="text" id="service_account_network_code"
                                           style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace;"
                                           placeholder="e.g., 12345678">
                                    <button onclick="saveServiceAccountNetworkCode()" class="btn btn-primary btn-sm">
                                        Save Network Code
                                    </button>
                                </div>
                                <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                                    Find this in GAM under Admin ‚Üí Global Settings ‚Üí Network Code
                                </small>
                                {% endif %}
                            </div>

                            <div style="margin-top: 1rem;">
                                <button onclick="testGAMServiceAccountConnection()" class="btn btn-primary btn-sm"
                                        {% if not adapter_config.get('network_code') %}disabled title="Save network code first"{% endif %}>
                                    Test Connection
                                </button>
                                <button onclick="copyServiceAccountEmail()" class="btn btn-secondary btn-sm" style="margin-left: 0.5rem;">
                                    üìã Copy Email
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <!-- No service account yet -->
                        <div class="status-card" style="background: #f9fafb; border-left: 4px solid #9ca3af;">
                            <p style="margin: 0 0 1rem 0; font-size: 0.875rem;">
                                We'll create a service account in our GCP project and provide you with the email address. You then add this email as a user in your Google Ad Manager with the Trafficker role.
                            </p>
                            <button onclick="createServiceAccount()" class="btn btn-success" id="create-service-account-btn">
                                üîë Create Service Account
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group" style="margin-top: 2rem;">
                        {% if adapter_config and adapter_config.get('refresh_token') %}
                        <button onclick="saveGAMConfig()" class="btn btn-primary">Save Configuration</button>
                        {% else %}
                        <button onclick="saveGAMConfig()" class="btn btn-primary" disabled title="Get OAuth token first">
                            Save Configuration
                        </button>
                        <small class="form-text text-muted">Complete Step 1 to enable saving</small>
                        {% endif %}
                    </div>
                </div>
                {% elif active_adapter == 'mock' %}
                <div class="form-section" style="margin-top: 2rem;">
                    <div class="alert alert-info">
                        <strong>Mock Adapter Active</strong>
                        <p>The mock adapter is configured and ready for testing. No additional setup required.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Policies & Workflows Section -->
        <div id="business-rules" class="settings-section">
            <div class="settings-header">
                <h2>Policies & Workflows</h2>
                <p>Configure how your organization operates: budgets, naming conventions, approval workflows</p>
            </div>

            <form id="business-rules-form">
                <!-- Budget Controls -->
                <div class="form-section">
                    <h3>Budget Controls</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="max_daily_budget">Maximum Daily Budget (USD)</label>
                            <input type="number" id="max_daily_budget" name="max_daily_budget"
                                   value="{{ tenant.max_daily_budget }}" min="0" step="100">
                            <small>Maximum daily spend limit across all campaigns</small>
                        </div>
                    </div>
                </div>

                <!-- Naming Conventions -->
                <div class="form-section">
                    <h3>Naming Conventions</h3>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Configure how orders and line items are named. <strong>Works across all ad servers</strong> (GAM, Mock, Kevel).
                    </p>

                    <!-- Adapter Support Indicator -->
                    <div class="alert alert-info" style="font-size: 0.875rem; padding: 0.75rem; margin-bottom: 1.5rem; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;">
                        <strong>Adapter Support:</strong>
                        ‚úÖ Google Ad Manager &nbsp;&nbsp;
                        ‚úÖ Mock Adapter &nbsp;&nbsp;
                        ‚è≥ Kevel (coming soon)
                    </div>

                    <!-- Quick Start Presets -->
                    <div class="form-group">
                        <label>Quick Start Templates</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useNamingPreset('simple')">
                                üìä Simple
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useNamingPreset('campaign')">
                                üéØ Campaign-First
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="useNamingPreset('detailed')">
                                üìÖ Detailed
                            </button>
                        </div>
                    </div>

                    <!-- Order Name Template -->
                    <div class="form-group">
                        <label for="order_name_template">Order Name Template</label>
                        <input type="text" id="order_name_template" name="order_name_template"
                               value="{{ tenant.order_name_template or '{campaign_name|promoted_offering} - {date_range}' }}"
                               placeholder="{campaign_name|promoted_offering} - {date_range}"
                               oninput="updateNamingPreview()">
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #666; font-size: 0.875rem;">Show available variables</summary>
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.875rem;">
                                <strong>Available variables:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li><code>{campaign_name}</code> - Campaign name (optional - may be empty)</li>
                                    <li><code>{promoted_offering}</code> - What's being advertised (always present)</li>
                                    <li><code>{buyer_ref}</code> - Buyer's internal reference (optional)</li>
                                    <li><code>{auto_name}</code> - ü§ñ AI-generated name from full context (requires Gemini API key)</li>
                                    <li><code>{date_range}</code> - Flight dates (e.g., "Oct 7-14, 2025")</li>
                                    <li><code>{month_year}</code> - Month and year (e.g., "Oct 2025")</li>
                                    <li><code>{package_count}</code> - Number of packages in order</li>
                                </ul>
                                <strong>Fallback syntax:</strong> <code>{var1|var2}</code> uses var1 if present, otherwise var2
                                <br><strong>Example:</strong> <code>{campaign_name|promoted_offering}</code> tries campaign_name first, falls back to promoted_offering
                                <br><strong>AI Naming:</strong> <code>{auto_name}</code> generates smart, concise names (~500ms). Falls back to promoted_offering if Gemini unavailable.
                            </div>
                        </details>
                    </div>

                    <!-- Line Item Name Template -->
                    <div class="form-group">
                        <label for="line_item_name_template">Line Item Name Template</label>
                        <input type="text" id="line_item_name_template" name="line_item_name_template"
                               value="{{ tenant.line_item_name_template or '{order_name} - {product_name}' }}"
                               placeholder="{order_name} - {product_name}"
                               oninput="updateNamingPreview()">
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #666; font-size: 0.875rem;">Show available variables</summary>
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.875rem;">
                                <strong>Available variables:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li><code>{product_name}</code> - Product/inventory name (e.g., "Display 300x250")</li>
                                    <li><code>{order_name}</code> - Parent order name (provides campaign context)</li>
                                    <li><code>{package_index}</code> - Package position number (1, 2, 3...)</li>
                                </ul>
                                <strong>Tip:</strong> Including <code>{order_name}</code> helps identify campaigns in line-item reports
                            </div>
                        </details>
                    </div>

                    <!-- Live Preview -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>Preview with Sample Data</label>
                        <div id="naming-preview" style="padding: 1rem; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px;">
                            <div style="margin-bottom: 0.75rem;">
                                <strong style="color: #1e40af;">Order Name:</strong>
                                <div id="order-preview" style="padding: 0.5rem; background: white; border-radius: 4px; margin-top: 0.25rem; font-family: monospace; color: #059669;">
                                    Nike Shoes Q1 - Oct 7-14, 2025
                                </div>
                            </div>
                            <div>
                                <strong style="color: #1e40af;">Line Item Names:</strong>
                                <div id="lineitem-preview" style="padding: 0.5rem; background: white; border-radius: 4px; margin-top: 0.25rem; font-family: monospace; color: #059669;">
                                    1. Nike Shoes Q1 - Oct 7-14, 2025 - Display 300x250<br>
                                    2. Nike Shoes Q1 - Oct 7-14, 2025 - Video Pre-roll<br>
                                    3. Nike Shoes Q1 - Oct 7-14, 2025 - Native Article
                                </div>
                            </div>
                            <div id="validation-messages" style="margin-top: 0.75rem; font-size: 0.875rem;">
                                <!-- Validation messages will appear here -->
                            </div>
                            <small style="color: #64748b; display: block; margin-top: 0.5rem;">
                                Using sample: campaign_name=null, promoted_offering="Nike Shoes Q1", dates=Oct 7-14, 2025, 3 products
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Approval Workflow -->
                <div class="form-section">
                    <h3>Approval Workflow</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="human_review_required" name="human_review_required"
                               {% if tenant.human_review_required %}checked{% endif %}>
                        <label for="human_review_required">Require manual approval for order activation</label>
                        <small>Orders will be created in draft state and require human approval before activation</small>
                    </div>
                </div>

                <!-- Creative Review -->
                <div class="form-section">
                    <h3>Creative Review</h3>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Configure how uploaded creatives are reviewed and approved
                    </p>

                    <div class="form-group">
                        <label for="approval_mode">Creative Approval Mode</label>
                        <select id="approval_mode" name="approval_mode" class="form-control" onchange="updateApprovalModeUI()">
                            <option value="auto-approve" {% if tenant.approval_mode == 'auto-approve' %}selected{% endif %}>
                                ‚úÖ Auto-approve all creatives
                            </option>
                            <option value="require-human" {% if tenant.approval_mode == 'require-human' or not tenant.approval_mode %}selected{% endif %}>
                                üë§ Require human approval
                            </option>
                            <option value="ai-powered" {% if tenant.approval_mode == 'ai-powered' %}selected{% endif %}>
                                ü§ñ AI-powered review
                            </option>
                        </select>
                        <small>Choose how creatives are handled when uploaded</small>
                    </div>

                    <!-- Mode Descriptions -->
                    <div id="mode-description" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2563eb;">
                        <div id="desc-auto-approve" style="display: none;">
                            <strong>‚úÖ Auto-approve Mode:</strong>
                            <p style="margin: 0.5rem 0 0 0;">All uploaded creatives are immediately approved and ready to use.</p>
                        </div>
                        <div id="desc-require-human" style="display: none;">
                            <strong>üë§ Human Review Mode:</strong>
                            <p style="margin: 0.5rem 0 0 0;">All creatives remain pending until manually reviewed and approved by a human.</p>
                        </div>
                        <div id="desc-ai-powered" style="display: none;">
                            <strong>ü§ñ AI-Powered Mode:</strong>
                            <p style="margin: 0.5rem 0 0 0;">Creatives are automatically reviewed by AI based on your criteria below.</p>
                        </div>
                    </div>

                    <!-- AI Configuration (shown only for ai-powered mode) -->
                    <div id="ai-config-section" style="display: none; margin-top: 1rem;">
                        {% if not has_gemini_key %}
                        <div class="alert alert-warning" style="padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; margin-bottom: 1rem;">
                            <strong>‚ö†Ô∏è Gemini API Key Required</strong>
                            <p style="margin: 0.5rem 0 0;">AI review requires a Gemini API key. Please set your key in <a href="#" onclick="event.preventDefault(); switchSettingsSection('integrations')">Integrations ‚Üí AI Services</a>.</p>
                        </div>
                        {% else %}
                        <div class="alert alert-success" style="padding: 0.75rem; background: #d1fae5; border: 1px solid #34d399; border-radius: 6px; margin-bottom: 1rem;">
                            <strong>‚úÖ Gemini API Key Configured</strong>
                            <p style="margin: 0.5rem 0 0; font-size: 0.875rem; color: #059669;">AI-powered creative review is enabled.</p>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="creative_review_criteria">AI Review Criteria</label>
                            <textarea id="creative_review_criteria" name="creative_review_criteria" class="form-control" rows="6"
                                      placeholder="Enter your creative review criteria..."
                                      style="font-family: monospace; font-size: 0.875rem;">{{ tenant.creative_review_criteria or '' }}</textarea>
                            <small>Define when to <strong>approve</strong>, <strong>require human approval</strong>, or <strong>reject</strong> creatives. The AI will use these criteria to make three-state decisions.</small>
                        </div>

                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #2563eb; font-weight: 500; font-size: 0.875rem;">üìù Show Example Criteria</summary>
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; font-size: 0.875rem;">
                                <strong>Example 1: Simple Three-State Review</strong>
                                <pre style="background: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; white-space: pre-wrap;">APPROVE if:
‚úì Creative clearly matches promoted offering
‚úì Professional quality (clear, readable)
‚úì Appropriate for general audiences

REQUIRE HUMAN APPROVAL if:
‚ö†Ô∏è Unsure about promoted offering match
‚ö†Ô∏è Borderline quality or unclear messaging
‚ö†Ô∏è Contains sensitive content that may need review
‚ö†Ô∏è Novel or unusual creative approach

REJECT if:
‚úó Wrong product/service advertised
‚úó Poor quality or unprofessional
‚úó Inappropriate or offensive content
‚úó Misleading claims</pre>

                                <strong>Example 2: Brand Safety Focus</strong>
                                <pre style="background: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; white-space: pre-wrap;">APPROVE if all conditions met:
- Clearly promotes the advertised product
- No offensive, violent, or inappropriate content
- No false or misleading claims
- Professional image quality

REQUIRE HUMAN APPROVAL if:
- Contains claims that need fact-checking
- Uses controversial themes or messaging
- Quality is acceptable but not ideal
- Uncertain about brand guideline compliance

REJECT if any condition met:
- Violates advertising standards
- Contains competitor branding
- Promotes wrong or unrelated products
- Unprofessional or low quality</pre>

                                <strong>Example 3: Detailed Guidelines</strong>
                                <pre style="background: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; white-space: pre-wrap;">Review each creative and respond with one of three actions:

APPROVE - Creative is ready to go live:
‚úì Promoted offering matches creative content
‚úì Professional quality (clear images, readable text)
‚úì Appropriate for all audiences
‚úì No misleading claims or fine print issues
‚úì Brand/product clearly visible
‚úì Meets industry advertising standards

REQUIRE HUMAN APPROVAL - Needs manual review:
‚ö†Ô∏è Uncertain about promoted offering alignment
‚ö†Ô∏è Questionable claims that may need verification
‚ö†Ô∏è Sensitive topics or mature themes
‚ö†Ô∏è Unusual format or creative approach
‚ö†Ô∏è Borderline quality or professionalism
‚ö†Ô∏è Potential legal or compliance concerns

REJECT - Creative cannot be approved:
‚úó Wrong product/service advertised
‚úó Poor quality or unprofessional appearance
‚úó Inappropriate, offensive, or explicit content
‚úó Misleading, deceptive, or false claims
‚úó Violates advertising regulations
‚úó Contains competitor branding or logos</pre>
                            </div>
                        </details>

                        <!-- AI Policy Configuration -->
                        <div class="form-group" style="margin-top: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: #111827;">AI Confidence Thresholds</h4>
                            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                                Configure how confident the AI must be before automatically approving or rejecting creatives.
                                Lower confidence decisions will require human review.
                            </p>

                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label for="auto_approve_threshold">
                                        Auto-Approve Threshold
                                        <span style="color: #10b981; font-weight: 600; margin-left: 0.5rem;" id="approve_threshold_value">90%</span>
                                    </label>
                                    <input type="range" id="auto_approve_threshold" name="auto_approve_threshold"
                                           min="0.5" max="1.0" step="0.05"
                                           value="{{ (tenant.ai_policy.auto_approve_threshold if tenant.ai_policy else 0.90) }}"
                                           class="form-control" style="margin-bottom: 0.5rem;"
                                           oninput="document.getElementById('approve_threshold_value').textContent = Math.round(this.value * 100) + '%'">
                                    <small>AI must be at least this confident to auto-approve (default: 90%)</small>
                                </div>

                                <div class="form-group" style="margin-top: 1rem;">
                                    <label for="auto_reject_threshold">
                                        Auto-Reject Threshold
                                        <span style="color: #ef4444; font-weight: 600; margin-left: 0.5rem;" id="reject_threshold_value">90%</span>
                                    </label>
                                    <input type="range" id="auto_reject_threshold" name="auto_reject_threshold"
                                           min="0.5" max="1.0" step="0.05"
                                           value="{{ (tenant.ai_policy.auto_reject_threshold if tenant.ai_policy else 0.90) }}"
                                           class="form-control" style="margin-bottom: 0.5rem;"
                                           oninput="document.getElementById('reject_threshold_value').textContent = Math.round(this.value * 100) + '%'">
                                    <small>AI must be at least this confident to auto-reject (default: 90%)</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="sensitive_categories">Always Require Human Review For</label>
                                <input type="text" id="sensitive_categories" name="sensitive_categories"
                                       value="{{ (tenant.ai_policy.always_require_human_for|join(', ') if tenant.ai_policy and tenant.ai_policy.always_require_human_for else 'political, healthcare, financial') }}"
                                       class="form-control"
                                       placeholder="political, healthcare, financial">
                                <small>Categories that always require human review, regardless of AI confidence (comma-separated)</small>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="learn_from_overrides" name="learn_from_overrides"
                                           {% if not tenant.ai_policy or tenant.ai_policy.learn_from_overrides != False %}checked{% endif %}>
                                    Track when humans disagree with AI decisions
                                </label>
                                <small style="display: block; margin-top: 0.25rem;">
                                    Enable learning from human overrides to improve AI accuracy over time
                                </small>
                            </div>

                            <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #2563eb; margin-top: 1rem;">
                                <strong>How It Works:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem;">
                                    <li><strong>High Confidence (‚â•90%):</strong> AI approvals/rejections are automatic</li>
                                    <li><strong>Medium Confidence (10%-90%):</strong> Sent to human review queue with AI recommendation</li>
                                    <li><strong>Sensitive Categories:</strong> Always require human review, regardless of confidence</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advertising Policy Section -->
                <div class="form-section">
                    <h3>Advertising Policy</h3>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Configure which types of advertisers and content are permitted on your inventory
                    </p>

                    <div class="form-group">
                        <label for="policy_check_enabled">
                            <input type="checkbox" id="policy_check_enabled" name="policy_check_enabled"
                                   {% if tenant.advertising_policy and tenant.advertising_policy.get('enabled') != False %}checked{% endif %}>
                            Enable automated advertising policy checks
                        </label>
                        <small>AI-powered analysis of advertiser briefs during product discovery</small>
                    </div>

                    <div id="advertising-policy-config" style="{% if tenant.advertising_policy and tenant.advertising_policy.get('enabled') == False %}display: none;{% endif %}">
                        {% if not tenant.gemini_api_key %}
                        <div class="alert alert-warning" style="padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; margin-bottom: 1rem;">
                            <strong>‚ö†Ô∏è Gemini API Key Required</strong>
                            <p style="margin: 0.5rem 0 0;">Advertising policy checks require a Gemini API key to function. Without it, all campaigns will be allowed by default. Please set your key in <a href="#" onclick="event.preventDefault(); switchSettingsSection('integrations')">Integrations ‚Üí AI Services</a>.</p>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="default_prohibited_categories">Baseline Protected Categories</label>
                            <textarea id="default_prohibited_categories" name="default_prohibited_categories" class="form-control" rows="5"
                                      placeholder="Enter one category per line">{{ (tenant.advertising_policy.get('default_prohibited_categories', []) if tenant.advertising_policy else ['Targeting of vulnerable populations (children, elderly, disabled)', 'Discriminatory content based on protected characteristics', 'Illegal products/services', 'Misleading or deceptive claims', 'Harmful content that could exploit users'])|join('\n') }}</textarea>
                            <small>Core policy categories that apply to all campaigns. These are always enforced when policy checks are enabled. Edit to match your standards.</small>
                        </div>

                        <div class="form-group">
                            <label for="default_prohibited_tactics">Baseline Prohibited Tactics</label>
                            <textarea id="default_prohibited_tactics" name="default_prohibited_tactics" class="form-control" rows="3"
                                      placeholder="Enter one tactic per line">{{ (tenant.advertising_policy.get('default_prohibited_tactics', []) if tenant.advertising_policy else ['Clickbait or sensationalist content', 'False urgency or scarcity claims', 'Hidden or deceptive pricing'])|join('\n') }}</textarea>
                            <small>Core advertising tactics that are never permitted. Edit to match your standards.</small>
                        </div>

                        <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #e5e7eb;">

                        <div class="form-group">
                            <label for="prohibited_categories">Additional Prohibited Categories</label>
                            <textarea id="prohibited_categories" name="prohibited_categories" class="form-control" rows="4"
                                      placeholder="Enter one category per line (e.g., tobacco, gambling, adult content)">{{ (tenant.advertising_policy.get('prohibited_categories', []) if tenant.advertising_policy else [])|join('\n') }}</textarea>
                            <small>Additional content categories to block beyond the baseline. Examples: tobacco, gambling, cannabis, alcohol, political ads, cryptocurrency.</small>
                        </div>

                        <div class="form-group">
                            <label for="prohibited_tactics">Additional Prohibited Tactics</label>
                            <textarea id="prohibited_tactics" name="prohibited_tactics" class="form-control" rows="3"
                                      placeholder="Enter one tactic per line">{{ (tenant.advertising_policy.get('prohibited_tactics', []) if tenant.advertising_policy else [])|join('\n') }}</textarea>
                            <small>Additional advertising tactics to prohibit beyond the baseline.</small>
                        </div>

                        <div class="form-group">
                            <label for="prohibited_advertisers">Blocked Advertisers/Domains</label>
                            <textarea id="prohibited_advertisers" name="prohibited_advertisers" class="form-control" rows="3"
                                      placeholder="Enter one domain or advertiser name per line (e.g., competitor.com)">{{ (tenant.advertising_policy.get('prohibited_advertisers', []) if tenant.advertising_policy else [])|join('\n') }}</textarea>
                            <small>Specific advertisers or domains to block. One per line.</small>
                        </div>

                        <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #2563eb; margin-top: 1rem; font-size: 0.875rem;">
                            <strong>How It Works:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                <li>AI analyzes each campaign brief against your baseline + additional rules</li>
                                <li>Returns: <strong>Allowed</strong>, <strong>Restricted</strong>, or <strong>Blocked</strong></li>
                                <li>Without Gemini API key: All campaigns allowed by default (policy checks disabled)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" onclick="saveBusinessRules()" class="btn btn-primary">
                        Save Business Rules
                    </button>
                    <button type="reset" class="btn btn-secondary">Reset</button>
                </div>
            </form>
        </div>
        <!-- Inventory Settings -->
        <div id="inventory" class="settings-section">
            <div class="settings-header">
                <h2>Inventory Management</h2>
                <p>Sync and manage ad units, placements, and targeting options from your ad server</p>
            </div>

            {% if active_adapter == 'google_ad_manager' %}
            <div class="form-section">
                <h3>Inventory Sync Status</h3>

                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value">{{ inventory_count|default(0) }}</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ ad_units_count|default(0) }}</div>
                        <div class="stat-label">Ad Units</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ placements_count|default(0) }}</div>
                        <div class="stat-label">Placements</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ (custom_targeting_keys_count|default(0) + custom_targeting_values_count|default(0)) }}</div>
                        <div class="stat-label">Targeting (Keys+Values)</div>
                    </div>
                </div>

                <div class="status-card {% if running_sync %}info{% elif last_sync_time %}success{% else %}warning{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            {% if running_sync %}
                                <strong>‚è≥ Sync in progress...</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                    Started {{ running_sync.started_at.strftime('%Y-%m-%d %I:%M %p UTC') }}. This may take several minutes for large inventories.
                                </p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #666;">
                                    <em>The sync will continue even if you navigate away from this page.</em>
                                </p>
                                <button onclick="resetStuckSync()" class="btn" style="margin-top: 0.5rem; background: #dc2626; color: white; font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                                    üõë Reset Stuck Sync
                                </button>
                            {% elif last_sync_time %}
                                <strong>Last synced: {{ last_sync_time }}</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                    Syncing imports ad units, placements, and targeting options from Google Ad Manager.
                                </p>
                            {% else %}
                                <strong>No sync performed yet</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                    Syncing imports ad units, placements, and targeting options from Google Ad Manager.
                                </p>
                            {% endif %}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="syncGAMInventory('incremental')" class="btn btn-primary" style="white-space: nowrap;" {% if not last_sync_time or running_sync %}disabled{% if not last_sync_time %} title="No previous sync - use Full Reset first"{% elif running_sync %} title="Sync already in progress"{% endif %}{% endif %}>
                                    <span id="sync-icon-incremental">üîÑ</span> Incremental Sync
                                </button>
                                <button onclick="syncGAMInventory('full')" class="btn btn-warning" style="white-space: nowrap;" {% if running_sync %}disabled title="Sync already in progress"{% endif %}>
                                    <span id="sync-icon-full">‚ö†Ô∏è</span> Full Reset
                                </button>
                            </div>
                            <p style="margin: 0; font-size: 0.75rem; color: #666;">
                                <strong>Incremental:</strong> Only changed items (fast). <strong>Full Reset:</strong> Deletes & re-syncs all (slow).
                            </p>
                        </div>
                    </div>
                </div>

                {% if running_sync %}
                <script>
                    // Auto-resume polling for running sync
                    document.addEventListener('DOMContentLoaded', function() {
                        const syncId = "{{ running_sync.sync_id }}";
                        const button = document.querySelector('button[onclick*="syncGAMInventory"]');
                        if (button && syncId) {
                            // Disable both buttons
                            document.querySelectorAll('button[onclick*="syncGAMInventory"]').forEach(btn => btn.disabled = true);
                            // Start polling
                            pollSyncStatus(syncId, button, button.innerHTML, null);
                        }
                    });
                </script>
                {% endif %}

                <div class="form-section" style="margin-top: 1.5rem;">
                    <h3>Actions</h3>
                    <div style="display: flex; gap: 1rem;">
                        <a href="{{ url_for('inventory.inventory_browser', tenant_id=tenant_id, type='all') }}" class="btn btn-secondary">
                            üìä Browse Inventory
                        </a>
                        <a href="{{ url_for('inventory.targeting_browser', tenant_id=tenant_id) }}" class="btn btn-secondary">
                            üéØ Browse Targeting
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <strong>Ad Server Required</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                    Connect to Google Ad Manager in the Ad Server settings to enable inventory sync.
                </p>
                <a href="#" onclick="event.preventDefault(); switchSettingsSection('adserver')" class="btn btn-primary" style="margin-top: 1rem;">
                    Configure Ad Server
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Products Settings -->
        <div id="products" class="settings-section">
            <div class="settings-header">
                <h2>Product Management</h2>
                <p>Define advertising products available for purchase</p>
            </div>

            {% if product_count == 0 %}
            <!-- Show wizard prominently for new tenants -->
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-info-circle" style="font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                        <strong>No Products Configured Yet</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                            Create your first advertising product to start offering inventory to buyers.
                        </p>
                    </div>
                    <a href="/tenant/{{ tenant.tenant_id }}/products/add" class="btn btn-success">
                        <i class="fas fa-plus"></i> Create Product
                    </a>
                </div>
            </div>
            {% endif %}

            <div class="status-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ product_count }} Products Configured</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            {{ active_products }} active, {{ draft_products }} draft
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="/tenant/{{ tenant.tenant_id }}/products" class="btn btn-small">Manage</a>
                        <a href="/tenant/{{ tenant.tenant_id }}/products/add" class="btn btn-primary btn-small">Add New</a>
                    </div>
                </div>
            </div>

        </div>

        <!-- Creative Formats section removed - table dropped in migration f2addf453200 -->
        <!-- Formats are now fetched from creative agents via AdCP, not stored in local DB -->

        <!-- Advertisers Settings -->
        <div id="advertisers" class="settings-section">
            <div class="settings-header">
                <h2>Advertiser Management</h2>
                <p>Manage advertisers who can access your inventory</p>
            </div>

            <div class="status-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ advertiser_count }} Advertisers Registered</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            {{ active_advertisers }} active this month
                        </p>
                    </div>
                    <a href="/tenant/{{ tenant.tenant_id }}/principals/create" class="btn btn-primary btn-small">
                        Add Advertiser
                    </a>
                </div>
            </div>

            <!-- Advertisers List -->
            {% if principals %}
            <div class="card" style="margin-top: 1rem;">
                <div class="card-body">
                    <h5 class="card-title">Current Advertisers</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Principal ID</th>
                                    <th>Platform Mappings</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for principal in principals %}
                                <tr>
                                    <td><strong>{{ principal.name }}</strong></td>
                                    <td><code>{{ principal.principal_id }}</code></td>
                                    <td>
                                        {% if principal.platform_mappings %}
                                            {% set mappings = principal.platform_mappings | from_json %}
                                            {% for platform, config in mappings.items() %}
                                                {% if platform == 'gam_advertiser_id' %}
                                                    <small class="badge bg-primary me-1" title="Google Ad Manager Advertiser ID">GAM: {{ config }}</small>
                                                {% elif platform == 'google_ad_manager' %}
                                                    {% if config is mapping and (config.advertiser_id or config.company_id) %}
                                                        <small class="badge bg-primary me-1" title="Google Ad Manager Advertiser">GAM: {{ config.advertiser_id or config.company_id }}</small>
                                                    {% else %}
                                                        <small class="badge bg-primary me-1" title="Google Ad Manager (not configured)">GAM: Not configured</small>
                                                    {% endif %}
                                                {% elif platform == 'mock' %}
                                                    {% if config is mapping and config.advertiser_id %}
                                                        <small class="badge bg-secondary me-1" title="Mock Adapter">Mock: {{ config.advertiser_id }}</small>
                                                    {% else %}
                                                        <small class="badge bg-secondary me-1" title="Mock Adapter">Mock</small>
                                                    {% endif %}
                                                {% else %}
                                                    <small class="badge bg-info me-1" title="{{ platform }}">{{ platform }}: {{ config if config is string else config|first if config is iterable else config }}</small>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                        <small class="text-muted">None</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if principal.created_at %}
                                            {{ principal.created_at.strftime('%Y-%m-%d') }}
                                            {% else %}
                                            Unknown
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm"
                                                    onclick="copyA2AConfig('{{ principal.principal_id }}', '{{ principal.name }}', '{{ principal.access_token }}')"
                                                    title="Copy A2A Configuration">
                                                üìã A2A
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm"
                                                    onclick="copyMCPConfig('{{ principal.principal_id }}', '{{ principal.name }}', '{{ principal.access_token }}')"
                                                    title="Copy MCP Configuration">
                                                üìã MCP
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm"
                                                    onclick="editPrincipalMappings('{{ principal.principal_id }}', '{{ principal.name }}')"
                                                    title="Edit Platform Mappings">
                                                ‚úèÔ∏è Edit
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm"
                                                    onclick="deletePrincipal('{{ principal.principal_id }}', '{{ principal.name }}')"
                                                    title="Delete Advertiser">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card" style="margin-top: 1rem;">
                <div class="card-body text-center text-muted">
                    <p>No advertisers registered yet.</p>
                    <a href="/tenant/{{ tenant.tenant_id }}/principals/create" class="btn btn-primary">
                        Create First Advertiser
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Integrations Settings -->
        <div id="integrations" class="settings-section">
            <div class="settings-header">
                <h2>Integrations</h2>
                <p>Connect external services and configure webhooks</p>
            </div>

            <div class="form-section">
                <h3>Slack Integration</h3>
                <p class="form-section-description">
                    Receive real-time notifications for creative approvals, tasks, and audit logs in your Slack workspace.
                </p>

                <details style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <summary style="cursor: pointer; font-weight: 500; color: #374151;">
                        üìñ How to set up a Slack webhook
                    </summary>
                    <div style="margin-top: 1rem; padding-left: 0.5rem;">
                        <ol style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>Go to <a href="https://api.slack.com/apps" target="_blank" rel="noopener">api.slack.com/apps</a> and create a new app (or select an existing one)</li>
                            <li>Click on <strong>Incoming Webhooks</strong> in the left sidebar</li>
                            <li>Toggle <strong>Activate Incoming Webhooks</strong> to On</li>
                            <li>Click <strong>Add New Webhook to Workspace</strong></li>
                            <li>Select the channel where you want notifications</li>
                            <li>Copy the webhook URL (starts with <code>https://hooks.slack.com/services/...</code>)</li>
                            <li>Paste it into the fields below</li>
                        </ol>
                        <img src="/static/images/slack-webhook-setup.png" alt="Slack Incoming Webhooks setup page" style="max-width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; margin-top: 1rem;">
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;">
                            üí° <strong>Tip:</strong> You can use the same webhook for both notifications and audit logs, or create separate webhooks for different channels.
                        </p>
                    </div>
                </details>

                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/slack">
                    <div class="form-group">
                        <label for="slack_webhook_url">Task Notifications Webhook URL</label>
                        <input type="url" id="slack_webhook_url" name="slack_webhook_url"
                               value="{{ tenant.slack_webhook_url or '' }}"
                               placeholder="https://hooks.slack.com/services/YOUR/WEBHOOK/URL">
                        <small>Receives notifications for new tasks and creative approvals</small>
                    </div>

                    <div class="form-group">
                        <label for="slack_audit_webhook_url">Audit Log Webhook URL (Optional)</label>
                        <input type="url" id="slack_audit_webhook_url" name="slack_audit_webhook_url"
                               value="{{ tenant.slack_audit_webhook_url or '' }}"
                               placeholder="https://hooks.slack.com/services/YOUR/AUDIT/WEBHOOK">
                        <small>Separate channel for audit logs and security alerts</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Slack Settings</button>
                        <button type="button" onclick="testSlack()" class="btn btn-secondary">Test Connection</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>AI Services</h3>
                <p class="form-section-description">
                    Configure AI-powered features like creative review. Each tenant must provide their own API keys.
                </p>

                {% if not tenant.gemini_api_key %}
                <div class="alert alert-warning" style="padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; margin-bottom: 1rem;">
                    <strong>‚ö†Ô∏è Gemini API Key Required</strong>
                    <p style="margin: 0.5rem 0 0;">AI-powered creative review is not available without a Gemini API key. Please add your key below.</p>
                </div>
                {% else %}
                <div class="alert alert-success" style="padding: 0.75rem; background: #d1fae5; border: 1px solid #34d399; border-radius: 6px; margin-bottom: 1rem;">
                    <strong>‚úÖ Gemini API Key Configured</strong>
                    <p style="margin: 0.5rem 0 0;">AI-powered creative review is enabled.</p>
                </div>
                {% endif %}

                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/ai">
                    <div class="form-group">
                        <label for="gemini_api_key">Gemini API Key <span style="color: #ef4444;">*</span></label>
                        <input type="password" id="gemini_api_key" name="gemini_api_key"
                               value="{{ tenant.gemini_api_key or '' }}"
                               placeholder="Enter your Gemini API key"
                               required>
                        <small>
                            Required for AI-powered creative review. Each tenant provides their own key for usage tracking and billing.
                            <a href="https://aistudio.google.com/app/apikey" target="_blank">Get an API key from Google AI Studio</a>
                        </small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save AI Settings</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>AdCP Signals Discovery</h3>
                <p class="form-section-description">
                    Connect an upstream AdCP signals discovery agent to enhance product recommendations with intelligent signal-based targeting.
                </p>

                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/signals">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="signals_enabled" name="signals_enabled"
                                   {% if tenant.signals_agent_config and tenant.signals_agent_config.enabled %}checked{% endif %}>
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-text">Enable Signals Discovery</span>
                        </label>
                        <small>When enabled, the sales agent will query the upstream signals agent for intelligent product customization</small>
                    </div>

                    <div id="signals-config" class="signals-config-section"
                         style="{% if not (tenant.signals_agent_config and tenant.signals_agent_config.enabled) %}display: none;{% endif %}">

                        <div class="form-group">
                            <label for="signals_upstream_url">Upstream Signals Agent URL</label>
                            <input type="url" id="signals_upstream_url" name="signals_upstream_url"
                                   value="{{ (tenant.signals_agent_config.upstream_url if tenant.signals_agent_config else '') or '' }}"
                                   placeholder="http://signals-agent:8080/mcp/"
                                   required>
                            <small>The MCP endpoint URL of your AdCP signals discovery agent</small>
                        </div>

                        <div class="form-group">
                            <label for="signals_auth_token">Authentication Token</label>
                            <input type="text" id="signals_auth_token" name="signals_auth_token"
                                   value="{{ (tenant.signals_agent_config.upstream_token if tenant.signals_agent_config else '') or '' }}"
                                   placeholder="your-signals-agent-token">
                            <small>Token for authenticating with the signals discovery agent (optional)</small>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="signals_auth_header">Auth Header Name</label>
                                <input type="text" id="signals_auth_header" name="signals_auth_header"
                                       value="{{ (tenant.signals_agent_config.auth_header if tenant.signals_agent_config else '') or 'x-adcp-auth' }}"
                                       placeholder="x-adcp-auth">
                                <small>HTTP header name for token authentication</small>
                            </div>

                            <div class="form-group">
                                <label for="signals_timeout">Timeout (seconds)</label>
                                <input type="number" id="signals_timeout" name="signals_timeout"
                                       value="{{ (tenant.signals_agent_config.timeout if tenant.signals_agent_config else '') or '30' }}"
                                       min="5" max="120" placeholder="30">
                                <small>Request timeout for signals discovery calls</small>
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="signals_forward_offering" name="signals_forward_offering"
                                       {% if not tenant.signals_agent_config or tenant.signals_agent_config.forward_promoted_offering != False %}checked{% endif %}>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Forward Promoted Offering</span>
                            </label>
                            <small>Include the promoted offering in signals discovery requests</small>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="signals_fallback" name="signals_fallback"
                                       {% if not tenant.signals_agent_config or tenant.signals_agent_config.fallback_to_database != False %}checked{% endif %}>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Fallback to Database Products</span>
                            </label>
                            <small>Use database products if signals discovery fails or returns no results</small>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Signals Settings</button>
                        <button type="button" onclick="testSignalsConnection()" class="btn btn-secondary">Test Connection</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>Creative Agents</h3>
                <p class="form-section-description">
                    Manage creative agents that provide ad format definitions and rendering capabilities. The default AdCP creative agent is always available.
                </p>

                <div style="margin-bottom: 1rem;">
                    <a href="{{ url_for('creative_agents.list_creative_agents', tenant_id=tenant.tenant_id) }}"
                       class="btn btn-primary">
                        Manage Creative Agents
                    </a>
                </div>

                <div style="padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
                        üí° <strong>What are Creative Agents?</strong><br>
                        Creative agents are external services that define ad formats (like "Display 300x250" or "Video Pre-Roll 30s")
                        and handle creative rendering. You can add custom creative agents to support proprietary formats or
                        integrate with specialized creative services.
                    </p>
                </div>
            </div>
        </div>

        <!-- API Settings -->
        <div id="api" class="settings-section">
            <div class="settings-header">
                <h2>API & Tokens</h2>
                <p>Manage API access and authentication tokens</p>
            </div>

            <div class="form-section">
                <h3>MCP Server Endpoint</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">{% if tenant.virtual_host %}https://{{ tenant.virtual_host }}/mcp/{% elif is_production %}https://{{ tenant.subdomain }}.sales-agent.scope3.com/mcp/{% else %}http://localhost:{{ mcp_port }}/mcp/{% endif %}</pre>
                </div>
            </div>

            <div class="form-section">
                <h3>Python Client Example</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">from fastmcp.client import Client
from fastmcp.client.transports import StreamableHttpTransport

headers = {
    "x-adcp-auth": "YOUR_ACCESS_TOKEN",
    "x-adcp-tenant": "{{ tenant.subdomain }}"
}
transport = StreamableHttpTransport(
    url="{% if tenant.virtual_host %}https://{{ tenant.virtual_host }}/mcp/{% elif is_production %}https://{{ tenant.subdomain }}.sales-agent.scope3.com/mcp/{% else %}http://localhost:{{ mcp_port }}/mcp/{% endif %}",
    headers=headers
)
client = Client(transport=transport)

# Discover products
result = await client.tools.get_products(brief="video ads")</pre>
                </div>
            </div>

            <div class="form-section">
                <h3>Active Tokens</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Each advertiser has their own API token
                </p>
                <!-- Token list would go here -->
            </div>
        </div>

        <!-- Users Settings -->
        <div id="users" class="settings-section">
            <div class="settings-header">
                <h2>Users & Access</h2>
                <p>Manage who can access this tenant's admin interface</p>
            </div>

            <!-- Authorized Domains Section -->
            <div class="form-section">
                <h3>üè¢ Authorized Domains</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                    Users from these domains get automatic admin access via OAuth
                </p>

                <!-- Current Domains -->
                {% if authorized_domains %}
                <div class="domain-list" style="margin-bottom: 1rem;">
                    {% for domain in authorized_domains %}
                    <div class="domain-item" style="display: flex; align-items: center; justify-content: between; padding: 0.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>{{ domain }}</strong>
                            <small style="color: #6b7280; margin-left: 0.5rem;">@{{ domain }} users</small>
                        </div>
                        <form method="POST" action="{{ url_for('settings.remove_authorized_domain', tenant_id=tenant.tenant_id) }}" style="margin: 0;">
                            <input type="hidden" name="domain" value="{{ domain }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                    onclick="return confirm('Remove domain {{ domain }}? Users from this domain will lose access.')">Remove</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; color: #9ca3af; font-style: italic; margin-bottom: 1rem;">
                    No authorized domains configured
                </div>
                {% endif %}

                <!-- Add Domain Form -->
                <form method="POST" action="{{ url_for('settings.add_authorized_domain', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label for="new_domain" style="font-size: 0.875rem; font-weight: 500;">Add Domain</label>
                        <input type="text" id="new_domain" name="domain" placeholder="company.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>

            <!-- Authorized Emails Section -->
            <div class="form-section">
                <h3>üìß Authorized Emails</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                    External users requiring explicit access (contractors, agencies, etc.)
                </p>

                <!-- Current Emails -->
                {% if authorized_emails %}
                <div class="email-list" style="margin-bottom: 1rem;">
                    {% for email in authorized_emails %}
                    <div class="email-item" style="display: flex; align-items: center; justify-content: between; padding: 0.5rem; background: #fef7ec; border: 1px solid #fed7aa; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>{{ email }}</strong>
                            <small style="color: #92400e; margin-left: 0.5rem;">External user</small>
                        </div>
                        <form method="POST" action="{{ url_for('settings.remove_authorized_email', tenant_id=tenant.tenant_id) }}" style="margin: 0;">
                            <input type="hidden" name="email" value="{{ email }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                    onclick="return confirm('Remove {{ email }}? This user will lose access.')">Remove</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; color: #9ca3af; font-style: italic; margin-bottom: 1rem;">
                    No external emails configured
                </div>
                {% endif %}

                <!-- Add Email Form -->
                <form method="POST" action="{{ url_for('settings.add_authorized_email', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label for="new_email" style="font-size: 0.875rem; font-weight: 500;">Add Email</label>
                        <input type="email" id="new_email" name="email" placeholder="contractor@agency.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>

            <!-- Test Access Section -->
            <div class="form-section">
                <h3>üß™ Test Access</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                    Test if an email address would have access to this tenant
                </p>

                <form method="POST" action="{{ url_for('settings.test_domain_access', tenant_id=tenant.tenant_id) }}" style="display: flex; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <label for="test_email" style="font-size: 0.875rem; font-weight: 500;">Email to Test</label>
                        <input type="email" id="test_email" name="test_email" placeholder="user@example.com" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <button type="submit" class="btn btn-secondary">Test</button>
                </form>
            </div>

            <div class="form-section">
                <h3>Tenant Login URL</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">http://localhost:{{ admin_port }}/tenant/{{ tenant.tenant_id }}/login</pre>
                </div>
                <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                    Share this URL with authorized users to access this tenant directly
                </p>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div id="advanced" class="settings-section">
            <div class="settings-header">
                <h2>Advanced Settings</h2>
                <p>Expert configuration and raw JSON editing</p>
            </div>

            <div class="status-card warning">
                <strong>‚ö†Ô∏è Warning</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Modifying these settings incorrectly may break your configuration
                </p>
            </div>

            <div class="form-section">
                <h3>Raw Configuration (JSON)</h3>
                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/raw">
                    <div class="form-group">
                        <textarea id="raw_config" name="config" rows="20"
                                  style="font-family: monospace;">{{ tenant.config_json }}</textarea>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                        <button type="button" onclick="formatJSON()" class="btn btn-secondary">Format JSON</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Danger Zone -->
        <div id="danger-zone" class="settings-section">
            <div class="settings-header">
                <h2>‚ö†Ô∏è Danger Zone</h2>
                <p>Irreversible and destructive actions</p>
            </div>

            <div class="status-card danger">
                <strong>‚ö†Ô∏è Warning</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Actions in this section are permanent and cannot be easily undone
                </p>
            </div>

            <div class="form-section" style="border: 2px solid #dc2626; border-radius: 8px; padding: 1.5rem; background: #fef2f2;">
                <h3 style="color: #991b1b;">Deactivate Sales Agent</h3>
                <p style="color: #7f1d1d; margin-bottom: 1rem;">
                    Deactivating your sales agent will:
                </p>
                <ul style="color: #7f1d1d; margin-bottom: 1.5rem;">
                    <li>Stop all active media buys immediately</li>
                    <li>Disable API access for all principals</li>
                    <li>Hide this tenant from all user dashboards</li>
                    <li>Prevent new signups or logins</li>
                    <li><strong>Preserve all data</strong> - you can reactivate later by contacting support</li>
                </ul>

                <form id="deactivate-form" method="POST" action="/tenant/{{ tenant.tenant_id }}/deactivate" onsubmit="return confirmDeactivation()">
                    <div class="form-group">
                        <label for="confirm-name" style="color: #991b1b;">
                            Type <strong>{{ tenant.name }}</strong> to confirm:
                        </label>
                        <input type="text" id="confirm-name" name="confirm_name" required
                               placeholder="Enter tenant name to confirm"
                               style="border: 2px solid #dc2626;">
                    </div>

                    <button type="submit" class="btn" style="background: #dc2626; color: white;">
                        Deactivate Sales Agent
                    </button>
                </form>
            </div>

            {% if not tenant.is_active %}
            <div class="form-section" style="border: 2px solid #059669; border-radius: 8px; padding: 1.5rem; background: #f0fdf4;">
                <h3 style="color: #065f46;">Sales Agent Currently Inactive</h3>
                <p style="color: #047857; margin-bottom: 1rem;">
                    This sales agent is currently deactivated. To reactivate, please contact support at
                    <a href="mailto:support@scope3.com">support@scope3.com</a>.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Configuration for external JavaScript -->
<div id="settings-config"
     data-script-name="{{ script_name }}"
     data-tenant-id="{{ tenant.tenant_id }}"
     data-active-adapter="{{ active_adapter }}"
     data-a2a-port="{{ a2a_port }}"
     data-is-production="{% if is_production %}true{% else %}false{% endif %}"
     data-virtual-host="{{ tenant.virtual_host if tenant.virtual_host else '' }}"
     data-subdomain="{{ tenant.subdomain if tenant.subdomain else '' }}"
     data-tenant-ad-server="{{ tenant.ad_server if tenant.ad_server else '' }}"
     style="display: none;">
</div>

<script src="{{ url_for('static', filename='js/tenant_settings.js') }}"></script>

<!-- Approximated DNS Widget -->
<link rel="stylesheet" href="https://cloud.approximated.app/dnswidget/dnswidget.v1.css">
<script src="https://cloud.approximated.app/dnswidget/dnswidget.v1.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const virtualHostInput = document.getElementById('virtual_host');
    const dnsWidgetContainer = document.getElementById('dns-widget-container');
    const tenantId = '{{ tenant.tenant_id }}';

    let widgetInitialized = false;
    let debounceTimer = null;
    let dnsVerified = false;

    // Function to initialize the DNS widget
    async function initializeDNSWidget() {
        const virtualHost = virtualHostInput.value.trim();
        console.log('initializeDNSWidget called with domain:', virtualHost);

        // Show/hide widget based on virtual host input
        if (virtualHost) {
            dnsWidgetContainer.style.display = 'block';

            // Only initialize once
            if (!widgetInitialized) {
                try {
                    // Get script name for proper URL routing
                    const scriptName = document.getElementById('settings-config').dataset.scriptName || '';

                    // Get token from our backend
                    const response = await fetch(`${scriptName}/tenant/${tenantId}/settings/approximated-token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        console.error('Failed to get Approximated token:', await response.text());
                        dnsWidgetContainer.innerHTML = '<p style="color: #dc2626; font-size: 0.875rem;">‚ùå DNS widget unavailable. Please contact support.</p>';
                        return;
                    }

                    const data = await response.json();
                    console.log('Approximated token API response:', data);

                    if (data.success && data.token) {
                        console.log('Initializing DNS widget with token:', data.token.substring(0, 20) + '...');

                        // Wait for widget library to be ready
                        if (!window.apxDns) {
                            console.error('Approximated DNS widget library not loaded');
                            dnsWidgetContainer.innerHTML = '<p style="color: #dc2626; font-size: 0.875rem;">‚ùå DNS widget library not loaded.</p>';
                            return;
                        }

                        // Initialize Approximated widget
                        const config = {
                            token: data.token,
                            api_url: "https://cloud.approximated.app/api/dns",
                            dnsRecords: [
                                {
                                    type: "CNAME",
                                    host: "@",
                                    value: "sales-agent.scope3.com",
                                    ttl: 3600
                                }
                            ],
                            domain: virtualHost,
                            prefillDomain: virtualHost,
                            verifyAutoScroll: true
                        };

                        window.apxDns.init(config);
                        widgetInitialized = true;

                        // Listen for widget events
                        document.addEventListener('apx-dnswidget-records-completely-verified', function(e) {
                            console.log('DNS records verified successfully!', e.detail);
                            dnsVerified = true;

                            // Show success message
                            const successMessage = document.getElementById('dns-success-message');
                            if (successMessage) {
                                successMessage.style.display = 'block';
                            }

                            // Optionally hide the widget details to show clean success state
                            const widgetDiv = document.getElementById('apxdnswidget');
                            if (widgetDiv) {
                                widgetDiv.style.display = 'none';
                            }
                        });

                        document.addEventListener('apx-dnswidget-records-failed-verification', function(e) {
                            console.log('DNS verification failed:', e.detail);
                            dnsVerified = false;

                            // Hide success message if shown
                            const successMessage = document.getElementById('dns-success-message');
                            if (successMessage) {
                                successMessage.style.display = 'none';
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error initializing DNS widget:', error);
                    dnsWidgetContainer.innerHTML = '<p style="color: #dc2626; font-size: 0.875rem;">‚ùå Error initializing DNS widget. Check console for details.</p>';
                }
            }
        } else {
            dnsWidgetContainer.style.display = 'none';
        }
    }

    // Watch for changes to virtual host (debounced)
    virtualHostInput.addEventListener('input', function() {
        // Clear existing timer
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }

        // Set new timer - wait 500ms after user stops typing
        debounceTimer = setTimeout(function() {
            // Reset widget on domain change - reinitialize with new domain
            widgetInitialized = false;
            dnsVerified = false;

            // Hide success message
            const successMessage = document.getElementById('dns-success-message');
            if (successMessage) {
                successMessage.style.display = 'none';
            }

            // Clear and show widget div
            const widgetDiv = document.getElementById('apxdnswidget');
            if (widgetDiv) {
                widgetDiv.innerHTML = '';
                widgetDiv.style.display = 'block';
            }

            initializeDNSWidget();
        }, 500);
    });

    // Initialize on page load if virtual host has a value
    initializeDNSWidget();

    // Show/hide domain registration container based on virtual host
    function updateDomainRegistrationVisibility() {
        const virtualHost = virtualHostInput.value.trim();
        const domainRegistrationContainer = document.getElementById('domain-registration-container');

        if (virtualHost && domainRegistrationContainer) {
            domainRegistrationContainer.style.display = 'block';
        } else if (domainRegistrationContainer) {
            domainRegistrationContainer.style.display = 'none';
        }
    }

    // Watch for virtual host changes to show/hide registration container
    virtualHostInput.addEventListener('input', updateDomainRegistrationVisibility);
    updateDomainRegistrationVisibility(); // Initial check

    // Form submission handler - show warning if DNS not verified
    const accountForm = document.getElementById('account-settings-form');
    if (accountForm) {
        accountForm.addEventListener('submit', function(e) {
            const virtualHost = virtualHostInput.value.trim();
            const warningBanner = document.getElementById('dns-warning-banner');

            // If virtual host is set but DNS not verified, show warning
            if (virtualHost && !dnsVerified) {
                // Show warning banner
                if (warningBanner) {
                    warningBanner.style.display = 'block';
                    // Scroll to warning
                    warningBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Prevent submission and ask for confirmation
                e.preventDefault();

                if (confirm('‚ö†Ô∏è DNS records have not been verified yet.\n\nYour custom domain may not work until DNS is properly configured.\n\nDo you want to save anyway?')) {
                    // User confirmed, submit the form
                    accountForm.submit();
                }
            } else {
                // Hide warning banner if shown
                if (warningBanner) {
                    warningBanner.style.display = 'none';
                }
            }
        });
    }
});

// Domain Registration Functions (defined globally for onclick handlers)
async function checkDomainRegistrationStatus() {
    const virtualHostInput = document.getElementById('virtual_host');
    const domain = virtualHostInput.value.trim();

    if (!domain) {
        alert('Please enter a domain first');
        return;
    }

    const statusIcon = document.getElementById('domain-status-icon');
    const statusText = document.getElementById('domain-status-text');
    const statusDetails = document.getElementById('domain-status-details');
    const registerBtn = document.getElementById('register-domain-btn');
    const unregisterBtn = document.getElementById('unregister-domain-btn');
    const checkBtn = document.getElementById('check-domain-status-btn');

    // Show loading state
    statusIcon.textContent = '‚è≥';
    statusText.textContent = 'Checking status...';
    statusDetails.textContent = '';
    checkBtn.disabled = true;

    try {
        const scriptName = document.getElementById('settings-config').dataset.scriptName || '';
        const tenantId = document.getElementById('settings-config').dataset.tenantId;

        const response = await fetch(`${scriptName}/tenant/${tenantId}/settings/approximated-domain-status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain: domain })
        });

        const data = await response.json();

        if (data.success) {
            if (data.registered) {
                // Domain is registered
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = 'Domain Registered';

                let details = [];
                if (data.ssl_active) {
                    details.push('HTTPS/TLS active');
                } else if (data.tls_enabled) {
                    details.push('TLS certificate pending (wait 1-2 minutes)');
                } else {
                    details.push('TLS not yet active');
                }

                if (data.target_address) {
                    details.push(`Backend: ${data.target_address}`);
                }

                if (data.status) {
                    details.push(`Status: ${data.status}`);
                }

                statusDetails.textContent = details.join(' ‚Ä¢ ');
                registerBtn.style.display = 'none';
                unregisterBtn.style.display = 'inline-block';
            } else {
                // Domain not registered
                statusIcon.textContent = '‚ùå';
                statusText.textContent = 'Domain Not Registered';
                statusDetails.textContent = 'Click "Register Domain" to enable HTTPS/TLS';
                registerBtn.style.display = 'inline-block';
                unregisterBtn.style.display = 'none';
            }
        } else {
            statusIcon.textContent = '‚ö†Ô∏è';
            statusText.textContent = 'Check Failed';
            statusDetails.textContent = data.error || 'Unknown error';
            registerBtn.style.display = 'none';
            unregisterBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('Error checking domain status:', error);
        statusIcon.textContent = '‚ö†Ô∏è';
        statusText.textContent = 'Error';
        statusDetails.textContent = error.message;
        registerBtn.style.display = 'none';
        unregisterBtn.style.display = 'none';
    } finally {
        checkBtn.disabled = false;
    }
}

async function registerDomain() {
    const virtualHostInput = document.getElementById('virtual_host');
    const domain = virtualHostInput.value.trim();

    if (!domain) {
        alert('Please enter a domain first');
        return;
    }

    if (!confirm(`Register domain ${domain}?\n\nThis will:\n‚Ä¢ Issue HTTPS/TLS certificate\n‚Ä¢ Enable traffic routing\n‚Ä¢ Take 1-2 minutes to complete`)) {
        return;
    }

    const registerBtn = document.getElementById('register-domain-btn');
    registerBtn.disabled = true;
    registerBtn.textContent = 'Registering...';

    try {
        const scriptName = document.getElementById('settings-config').dataset.scriptName || '';
        const tenantId = document.getElementById('settings-config').dataset.tenantId;

        const response = await fetch(`${scriptName}/tenant/${tenantId}/settings/approximated-register-domain`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain: domain })
        });

        const data = await response.json();

        if (data.success) {
            alert(`‚úÖ ${data.message}\n\nWait 1-2 minutes for TLS certificate to be issued.`);
            // Refresh status
            await checkDomainRegistrationStatus();
        } else {
            alert(`‚ùå Registration failed:\n${data.error}`);
        }
    } catch (error) {
        console.error('Error registering domain:', error);
        alert(`‚ùå Error: ${error.message}`);
    } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = 'Register Domain';
    }
}

async function unregisterDomain() {
    const virtualHostInput = document.getElementById('virtual_host');
    const domain = virtualHostInput.value.trim();

    if (!domain) {
        alert('Please enter a domain first');
        return;
    }

    if (!confirm(`‚ö†Ô∏è Unregister domain ${domain}?\n\nThis will:\n‚Ä¢ Remove HTTPS/TLS certificate\n‚Ä¢ Stop traffic routing\n‚Ä¢ Domain will stop working\n\nAre you sure?`)) {
        return;
    }

    const unregisterBtn = document.getElementById('unregister-domain-btn');
    unregisterBtn.disabled = true;
    unregisterBtn.textContent = 'Unregistering...';

    try {
        const scriptName = document.getElementById('settings-config').dataset.scriptName || '';
        const tenantId = document.getElementById('settings-config').dataset.tenantId;

        const response = await fetch(`${scriptName}/tenant/${tenantId}/settings/approximated-unregister-domain`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain: domain })
        });

        const data = await response.json();

        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            // Refresh status
            await checkDomainRegistrationStatus();
        } else {
            alert(`‚ùå Unregistration failed:\n${data.error}`);
        }
    } catch (error) {
        console.error('Error unregistering domain:', error);
        alert(`‚ùå Error: ${error.message}`);
    } finally {
        unregisterBtn.disabled = false;
        unregisterBtn.textContent = 'Unregister Domain';
    }
}
</script>

<!-- Edit Principal Mappings Modal -->
<div class="modal fade" id="editPrincipalModal" tabindex="-1" aria-labelledby="editPrincipalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPrincipalModalTitle">Edit Platform Mappings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editPrincipalForm">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMappingsBtn" onclick="savePrincipalMappings()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
