# Conductor Workspace Setup Guide

This guide documents the automated setup process for Conductor workspace copies.

## Quick Start

Run the setup script from within a Conductor workspace:

```bash
./setup_conductor_workspace.sh
```

The script automatically:
- Detects the Conductor workspace using environment variables
- Assigns unique ports based on the workspace name
- Creates a `.env` file with environment-based configuration
- Creates a `docker-compose.override.yml` for development hot-reloading
- DOES NOT modify `docker-compose.yml` (uses environment variables instead)

## How It Works

The setup script uses Conductor-provided environment variables:
- `$CONDUCTOR_WORKSPACE_NAME` - The workspace name (e.g., "san-francisco")
- `$CONDUCTOR_WORKSPACE_PATH` - Path to the workspace directory
- `$CONDUCTOR_ROOT_PATH` - Path to the repository root

Unique ports are generated by creating a hash of the workspace name, ensuring consistent port allocation across runs.

## Port Configuration

Each workspace gets unique ports to avoid conflicts:

```bash
# Example ports for workspace "san-francisco"
POSTGRES_PORT=5456      # Base: 5432 + workspace number
ADCP_SALES_PORT=8104    # Base: 8080 + workspace number
ADMIN_UI_PORT=8025      # Base: 8001 + workspace number
```

## Environment Variables

The setup script reads from your shell environment. Set these before running:

```bash
# Required
export GEMINI_API_KEY="your-api-key"

# OAuth (recommended method)
export GOOGLE_CLIENT_ID="your-client-id.apps.googleusercontent.com"
export GOOGLE_CLIENT_SECRET="your-client-secret"

# Admin configuration
export SUPER_ADMIN_EMAILS="admin@example.com"
export SUPER_ADMIN_DOMAINS="example.com"
```

## After Setup

Start the services:
```bash
docker-compose build
docker-compose up -d
```

**Note**: The `docker-compose.override.yml` enables development features:
- Hot reloading for code changes
- Volume mounts that preserve the container's `.venv`
- Flask debug mode for the Admin UI

## Verification

Check that all services are running:
```bash
docker-compose ps
```

Test endpoints (using example ports):
- MCP Server: `curl http://localhost:8104/mcp/`
- Admin UI: `http://localhost:8025/`
- PostgreSQL: `psql -h localhost -p 5456 -U adcp_user -d adcp`

## Important Notes

1. **OAuth Redirect URI**: If using Google OAuth, ensure the redirect URI in Google Console matches your Admin UI port (e.g., `http://localhost:8025/auth/google/callback`)

2. **Database URL**: The DATABASE_URL in `.env` is automatically configured to match the POSTGRES_PORT setting

3. **Consistent Ports**: The same workspace name will always get the same ports, making it easy to remember and bookmark

4. **Manual Override**: You can still manually edit the `.env` file if you need specific ports

## Troubleshooting

If you encounter issues:

1. **Port Conflicts**: Check if the assigned ports are already in use:
   ```bash
   lsof -i :PORT_NUMBER
   ```

2. **Missing Environment Variables**: Ensure you have set:
   - `GEMINI_API_KEY` in your shell environment
   - `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` (or a client_secret*.json file)

3. **Database Issues**: Database migrations run automatically via `entrypoint.sh`

4. **Git Worktree Warning**: Conductor workspaces use git worktrees. Changes here affect the main repository when merged. DO NOT delete core files like Alembic migrations or entrypoint.sh