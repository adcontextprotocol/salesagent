# Fly.io Dockerfile for AdCP Sales Agent with ADK
FROM python:3.12-slim

# Install dependencies
RUN apt-get update && apt-get install -y \
    libpq5 \
    curl \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages
RUN pip install uv

WORKDIR /app

# Copy and install dependencies
COPY pyproject.toml uv.lock ./
RUN uv sync

# Copy application
COPY . .

# Add .venv to PATH
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONUNBUFFERED=1

# Service ports
ENV ADCP_SALES_PORT=8080
ENV ADMIN_UI_PORT=8001
ENV ADK_WEB_PORT=8091

# Make run_all_services.py executable
RUN chmod +x run_all_services.py

# Health check for MCP server
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Expose all service ports
EXPOSE 8080 8001 8091

# Run all services
CMD ["python", "run_all_services.py"]
