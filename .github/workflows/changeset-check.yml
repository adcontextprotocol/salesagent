name: Changeset Check

on:
  pull_request:
    branches: [main]

jobs:
  changeset-check:
    name: Check for Changeset
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for changeset files
        id: check_changeset
        run: |
          # Check if any changeset files exist (excluding README.md and config.json)
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" | wc -l)
          echo "changeset_count=$CHANGESET_COUNT" >> $GITHUB_OUTPUT
          echo "Found $CHANGESET_COUNT changeset file(s)"

      - name: Check for skip label
        id: check_label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const hasSkipLabel = labels.includes('skip-changeset');
            console.log(`PR labels: ${labels.join(', ')}`);
            console.log(`Has skip-changeset label: ${hasSkipLabel}`);
            return hasSkipLabel;

      - name: Validate changeset requirement
        if: steps.check_changeset.outputs.changeset_count == '0' && steps.check_label.outputs.result == 'false'
        run: |
          echo "❌ No changeset found and PR is not labeled with 'skip-changeset'"
          echo ""
          echo "Please add a changeset to document your changes:"
          echo "  npx changeset"
          echo ""
          echo "Or add the 'skip-changeset' label if this PR doesn't require a version bump"
          echo "(e.g., documentation-only changes, test updates)"
          exit 1

      - name: Changeset validation passed
        if: steps.check_changeset.outputs.changeset_count != '0' || steps.check_label.outputs.result == 'true'
        run: |
          if [ "${{ steps.check_label.outputs.result }}" == "true" ]; then
            echo "✅ PR labeled with 'skip-changeset' - no changeset required"
          else
            echo "✅ Changeset file(s) found - requirement satisfied"
          fi
